> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [thinkwon.blog.csdn.net](https://thinkwon.blog.csdn.net/article/details/104391081)

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ CSDN çš„åšä¸» ThinkWonï¼Œâ€œ2020 åšå®¢ä¹‹æ˜Ÿå¹´åº¦æ€»è¯„é€‰ " å¼€å§‹å•¦ï¼Œå¸Œæœ›å¤§å®¶å¸®æˆ‘æŠ•ç¥¨ï¼Œæ¯å¤©éƒ½å¯ä»¥æŠ•å¤šç¥¨å“¦ï¼Œç‚¹å‡»ä¸‹æ–¹é“¾æ¥ï¼Œç„¶åç‚¹å‡» " æœ€å¤§â€ï¼Œå†ç‚¹å‡» " æŠ• TA ä¸€ç¥¨ " å°±å¯ä»¥å•¦ï¼  
> æŠ•ç¥¨é“¾æ¥ï¼š[ï¼ŒThinkWon å°†ä¸€è·¯ä¸ä½ ç›¸ä¼´ï¼åˆ›ä½œå‡ºæ›´å¤šæ›´é«˜è´¨é‡çš„æ–‡ç« ï¼2020 ä¸ºåŠªåŠ›å¥‹æ–—çš„ä½ ç‚¹èµğŸ‘ï¼Œï¸æ–°çš„ä¸€å¹´ï¼Œç¥å„ä½å¤§ç‰›ç‰›æ°”å†²å¤©ï¼Œç‰›å¹´å¤§å‰ï¼ğŸ˜ŠğŸ˜Š](https://bss.csdn.net/m/topic/blog_star2020/detail?user>https://bss.csdn.net/m/topic/blog_star2020/detail?username=thinkwon</a><br> åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œ<h-char unicode=)
> 
> [](https://bss.csdn.net/m/topic/blog_star2020/detail?user>https://bss.csdn.net/m/topic/blog_star2020/detail?username=thinkwon</a><br> åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œ<h-char unicode=)

[Java é¢è¯•æ€»ç»“æ±‡æ€»ï¼Œæ•´ç†äº†åŒ…æ‹¬ Java åŸºç¡€çŸ¥è¯†ï¼Œé›†åˆå®¹å™¨ï¼Œå¹¶å‘ç¼–ç¨‹ï¼ŒJVMï¼Œå¸¸ç”¨å¼€æºæ¡†æ¶ Springï¼ŒMyBatisï¼Œæ•°æ®åº“ï¼Œä¸­é—´ä»¶ç­‰ï¼ŒåŒ…å«äº†ä½œä¸ºä¸€ä¸ª Java å·¥ç¨‹å¸ˆåœ¨é¢è¯•ä¸­éœ€è¦ç”¨åˆ°æˆ–è€…å¯èƒ½ç”¨åˆ°çš„ç»å¤§éƒ¨åˆ†çŸ¥è¯†ã€‚æ¬¢è¿å¤§å®¶é˜…è¯»ï¼Œæœ¬äººè§è¯†æœ‰é™ï¼Œå†™çš„åšå®¢éš¾å…æœ‰é”™è¯¯æˆ–è€…ç–å¿½çš„åœ°æ–¹ï¼Œè¿˜æœ›å„ä½å¤§ä½¬æŒ‡ç‚¹ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿæ¿€ä¸å°½ã€‚æ–‡ç« æŒç»­æ›´æ–°ä¸­â€¦](https://bss.csdn.net/m/topic/blog_star2020/detail?user>https://bss.csdn.net/m/topic/blog_star2020/detail?username=thinkwon</a><br> åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œ<h-char unicode=)

1.Netty æ˜¯ä»€ä¹ˆï¼Ÿ
------------

Netty æ˜¯ ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚Netty æ˜¯åŸºäº nio çš„ï¼Œå®ƒå°è£…äº† jdk çš„ nioï¼Œè®©æˆ‘ä»¬ä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹æ³•çµæ´»ã€‚

2.Netty çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
---------------

*   é«˜å¹¶å‘ï¼šNetty æ˜¯ä¸€æ¬¾åŸºäº NIOï¼ˆNonblocking IOï¼Œéé˜»å¡ IOï¼‰å¼€å‘çš„ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼Œå¯¹æ¯”äº BIOï¼ˆBlocking I/Oï¼Œé˜»å¡ IOï¼‰ï¼Œä»–çš„å¹¶å‘æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§æé«˜ã€‚
*   ä¼ è¾“å¿«ï¼šNetty çš„ä¼ è¾“ä¾èµ–äºé›¶æ‹·è´ç‰¹æ€§ï¼Œå°½é‡å‡å°‘ä¸å¿…è¦çš„å†…å­˜æ‹·è´ï¼Œå®ç°äº†æ›´é«˜æ•ˆç‡çš„ä¼ è¾“ã€‚
*   å°è£…å¥½ï¼šNetty å°è£…äº† NIO æ“ä½œçš„å¾ˆå¤šç»†èŠ‚ï¼Œæä¾›äº†æ˜“äºä½¿ç”¨è°ƒç”¨æ¥å£ã€‚

3.Netty çš„ä¼˜åŠ¿æœ‰å“ªäº›ï¼Ÿ
---------------

*   ä½¿ç”¨ç®€å•ï¼šå°è£…äº† NIO çš„å¾ˆå¤šç»†èŠ‚ï¼Œä½¿ç”¨æ›´ç®€å•ã€‚
*   åŠŸèƒ½å¼ºå¤§ï¼šé¢„ç½®äº†å¤šç§ç¼–è§£ç åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ä¸»æµåè®®ã€‚
*   å®šåˆ¶èƒ½åŠ›å¼ºï¼šå¯ä»¥é€šè¿‡ ChannelHandler å¯¹é€šä¿¡æ¡†æ¶è¿›è¡Œçµæ´»åœ°æ‰©å±•ã€‚
*   æ€§èƒ½é«˜ï¼šé€šè¿‡ä¸å…¶ä»–ä¸šç•Œä¸»æµçš„ NIO æ¡†æ¶å¯¹æ¯”ï¼ŒNetty çš„ç»¼åˆæ€§èƒ½æœ€ä¼˜ã€‚
*   ç¨³å®šï¼šNetty ä¿®å¤äº†å·²ç»å‘ç°çš„æ‰€æœ‰ NIO çš„ bugï¼Œè®©å¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡æœ¬èº«ã€‚
*   ç¤¾åŒºæ´»è·ƒï¼šNetty æ˜¯æ´»è·ƒçš„å¼€æºé¡¹ç›®ï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œbug ä¿®å¤é€Ÿåº¦å¿«ã€‚

4.Netty çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ
-----------------

å…¸å‹çš„åº”ç”¨æœ‰ï¼šé˜¿é‡Œåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ Dubboï¼Œé»˜è®¤ä½¿ç”¨ Netty ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œè¿˜æœ‰ RocketMQ ä¹Ÿæ˜¯ä½¿ç”¨ Netty ä½œä¸ºé€šè®¯çš„åŸºç¡€ã€‚

5.Netty é«˜æ€§èƒ½è¡¨ç°åœ¨å“ªäº›æ–¹é¢ï¼Ÿ
-------------------

*   IO çº¿ç¨‹æ¨¡å‹ï¼šåŒæ­¥éé˜»å¡ï¼Œç”¨æœ€å°‘çš„èµ„æºåšæ›´å¤šçš„äº‹ã€‚
*   å†…å­˜é›¶æ‹·è´ï¼šå°½é‡å‡å°‘ä¸å¿…è¦çš„å†…å­˜æ‹·è´ï¼Œå®ç°äº†æ›´é«˜æ•ˆç‡çš„ä¼ è¾“ã€‚
*   å†…å­˜æ± è®¾è®¡ï¼šç”³è¯·çš„å†…å­˜å¯ä»¥é‡ç”¨ï¼Œä¸»è¦æŒ‡ç›´æ¥å†…å­˜ã€‚å†…éƒ¨å®ç°æ˜¯ç”¨ä¸€é¢—äºŒå‰æŸ¥æ‰¾æ ‘ç®¡ç†å†…å­˜åˆ†é…æƒ…å†µã€‚
*   ä¸²å½¢åŒ–å¤„ç†è¯»å†™ï¼šé¿å…ä½¿ç”¨é”å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚
*   é«˜æ€§èƒ½åºåˆ—åŒ–åè®®ï¼šæ”¯æŒ protobuf ç­‰é«˜æ€§èƒ½åºåˆ—åŒ–åè®®ã€‚

6.BIOã€NIO å’Œ AIO çš„åŒºåˆ«ï¼Ÿ
--------------------

BIOï¼šä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚çº¿ç¨‹å¼€é”€å¤§ã€‚  
ä¼ªå¼‚æ­¥ IOï¼šå°†è¯·æ±‚è¿æ¥æ”¾å…¥çº¿ç¨‹æ± ï¼Œä¸€å¯¹å¤šï¼Œä½†çº¿ç¨‹è¿˜æ˜¯å¾ˆå®è´µçš„èµ„æºã€‚

NIOï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†å®¢æˆ·ç«¯å‘é€çš„è¿æ¥è¯·æ±‚éƒ½ä¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰ I/O è¯·æ±‚æ—¶æ‰å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚

AIOï¼šä¸€ä¸ªæœ‰æ•ˆè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯çš„ I/O è¯·æ±‚éƒ½æ˜¯ç”± OS å…ˆå®Œæˆäº†å†é€šçŸ¥æœåŠ¡å™¨åº”ç”¨å»å¯åŠ¨çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œ

BIO æ˜¯é¢å‘æµçš„ï¼ŒNIO æ˜¯é¢å‘ç¼“å†²åŒºçš„ï¼›BIO çš„å„ç§æµæ˜¯é˜»å¡çš„ã€‚è€Œ NIO æ˜¯éé˜»å¡çš„ï¼›BIO çš„ Stream æ˜¯å•å‘çš„ï¼Œè€Œ NIO çš„ channel æ˜¯åŒå‘çš„ã€‚

NIO çš„ç‰¹ç‚¹ï¼šäº‹ä»¶é©±åŠ¨æ¨¡å‹ã€å•çº¿ç¨‹å¤„ç†å¤šä»»åŠ¡ã€éé˜»å¡ I/Oï¼ŒI/O è¯»å†™ä¸å†é˜»å¡ï¼Œè€Œæ˜¯è¿”å› 0ã€åŸºäº block çš„ä¼ è¾“æ¯”åŸºäºæµçš„ä¼ è¾“æ›´é«˜æ•ˆã€æ›´é«˜çº§çš„ IO å‡½æ•° zero-copyã€IO å¤šè·¯å¤ç”¨å¤§å¤§æé«˜äº† Java ç½‘ç»œåº”ç”¨çš„å¯ä¼¸ç¼©æ€§å’Œå®ç”¨æ€§ã€‚åŸºäº Reactor çº¿ç¨‹æ¨¡å‹ã€‚

åœ¨ Reactor æ¨¡å¼ä¸­ï¼Œäº‹ä»¶åˆ†å‘å™¨ç­‰å¾…æŸä¸ªäº‹ä»¶æˆ–è€…å¯åº”ç”¨æˆ–ä¸ªæ“ä½œçš„çŠ¶æ€å‘ç”Ÿï¼Œäº‹ä»¶åˆ†å‘å™¨å°±æŠŠè¿™ä¸ªäº‹ä»¶ä¼ ç»™äº‹å…ˆæ³¨å†Œçš„äº‹ä»¶å¤„ç†å‡½æ•°æˆ–è€…å›è°ƒå‡½æ•°ï¼Œç”±åè€…æ¥åšå®é™…çš„è¯»å†™æ“ä½œã€‚å¦‚åœ¨ Reactor ä¸­å®ç°è¯»ï¼šæ³¨å†Œè¯»å°±ç»ªäº‹ä»¶å’Œç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€äº‹ä»¶åˆ†å‘å™¨ç­‰å¾…äº‹ä»¶ã€äº‹ä»¶åˆ°æ¥ï¼Œæ¿€æ´»åˆ†å‘å™¨ï¼Œåˆ†å‘å™¨è°ƒç”¨äº‹ä»¶å¯¹åº”çš„å¤„ç†å™¨ã€äº‹ä»¶å¤„ç†å™¨å®Œæˆå®é™…çš„è¯»æ“ä½œï¼Œå¤„ç†è¯»åˆ°çš„æ•°æ®ï¼Œæ³¨å†Œæ–°çš„äº‹ä»¶ï¼Œç„¶åè¿”è¿˜æ§åˆ¶æƒã€‚

7.NIO çš„ç»„æˆï¼Ÿ
----------

Bufferï¼šä¸ Channel è¿›è¡Œäº¤äº’ï¼Œæ•°æ®æ˜¯ä» Channel è¯»å…¥ç¼“å†²åŒºï¼Œä»ç¼“å†²åŒºå†™å…¥ Channel ä¸­çš„

flip æ–¹æ³• ï¼š åè½¬æ­¤ç¼“å†²åŒºï¼Œå°† position ç»™ limitï¼Œç„¶åå°† position ç½®ä¸º 0ï¼Œå…¶å®å°±æ˜¯åˆ‡æ¢è¯»å†™æ¨¡å¼

clear æ–¹æ³• ï¼šæ¸…é™¤æ­¤ç¼“å†²åŒºï¼Œå°† position ç½®ä¸º 0ï¼ŒæŠŠ capacity çš„å€¼ç»™ limitã€‚

rewind æ–¹æ³• ï¼š é‡ç»•æ­¤ç¼“å†²åŒºï¼Œå°† position ç½®ä¸º 0

DirectByteBuffer å¯å‡å°‘ä¸€æ¬¡ç³»ç»Ÿç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´ã€‚ä½† Buffer åˆ›å»ºå’Œé”€æ¯çš„æˆæœ¬æ›´é«˜ï¼Œä¸å¯æ§ï¼Œé€šå¸¸ä¼šç”¨å†…å­˜æ± æ¥æé«˜æ€§èƒ½ã€‚ç›´æ¥ç¼“å†²åŒºä¸»è¦åˆ†é…ç»™é‚£äº›æ˜“å—åŸºç¡€ç³»ç»Ÿçš„æœ¬æœº I/O æ“ä½œå½±å“çš„å¤§å‹ã€æŒä¹…çš„ç¼“å†²åŒºã€‚å¦‚æœæ•°æ®é‡æ¯”è¾ƒå°çš„ä¸­å°åº”ç”¨æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ heapBufferï¼Œç”± JVM è¿›è¡Œç®¡ç†ã€‚

Channelï¼šè¡¨ç¤º IO æºä¸ç›®æ ‡æ‰“å¼€çš„è¿æ¥ï¼Œæ˜¯åŒå‘çš„ï¼Œä½†ä¸èƒ½ç›´æ¥è®¿é—®æ•°æ®ï¼Œåªèƒ½ä¸ Buffer è¿›è¡Œäº¤äº’ã€‚é€šè¿‡æºç å¯çŸ¥ï¼ŒFileChannel çš„ read æ–¹æ³•å’Œ write æ–¹æ³•éƒ½å¯¼è‡´æ•°æ®å¤åˆ¶äº†ä¸¤æ¬¡ï¼

Selector å¯ä½¿ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ç®¡ç†å¤šä¸ª Channelï¼Œopen æ–¹æ³•å¯åˆ›å»º Selectorï¼Œregister æ–¹æ³•å‘å¤šè·¯å¤ç”¨å™¨å™¨æ³¨å†Œé€šé“ï¼Œå¯ä»¥ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼šè¯»ã€å†™ã€è¿æ¥ã€acceptã€‚æ³¨å†Œäº‹ä»¶åä¼šäº§ç”Ÿä¸€ä¸ª SelectionKeyï¼šå®ƒè¡¨ç¤º SelectableChannel å’Œ Selector ä¹‹é—´çš„æ³¨å†Œå…³ç³»ï¼Œwakeup æ–¹æ³•ï¼šä½¿å°šæœªè¿”å›çš„ç¬¬ä¸€ä¸ªé€‰æ‹©æ“ä½œç«‹å³è¿”å›ï¼Œå”¤é†’çš„

åŸå› æ˜¯ï¼šæ³¨å†Œäº†æ–°çš„ channel æˆ–è€…äº‹ä»¶ï¼›channel å…³é—­ï¼Œå–æ¶ˆæ³¨å†Œï¼›ä¼˜å…ˆçº§æ›´é«˜çš„äº‹ä»¶è§¦å‘ï¼ˆå¦‚å®šæ—¶å™¨äº‹ä»¶ï¼‰ï¼Œå¸Œæœ›åŠæ—¶å¤„ç†ã€‚

Selector åœ¨ Linux çš„å®ç°ç±»æ˜¯ EPollSelectorImplï¼Œå§”æ‰˜ç»™ EPollArrayWrapper å®ç°ï¼Œå…¶ä¸­ä¸‰ä¸ª native æ–¹æ³•æ˜¯å¯¹ epoll çš„å°è£…ï¼Œè€Œ EPollSelectorImpl. implRegister æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨ epoll_ctl å‘ epoll å®ä¾‹ä¸­æ³¨å†Œäº‹ä»¶ï¼Œè¿˜å°†æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦ (fd) ä¸ SelectionKey çš„å¯¹åº”å…³ç³»æ·»åŠ åˆ° fdToKey ä¸­ï¼Œè¿™ä¸ª map ç»´æŠ¤äº†æ–‡ä»¶æè¿°ç¬¦ä¸ SelectionKey çš„æ˜ å°„ã€‚

fdToKey æœ‰æ—¶ä¼šå˜å¾—éå¸¸å¤§ï¼Œå› ä¸ºæ³¨å†Œåˆ° Selector ä¸Šçš„ Channel éå¸¸å¤šï¼ˆç™¾ä¸‡è¿æ¥ï¼‰ï¼›è¿‡æœŸæˆ–å¤±æ•ˆçš„ Channel æ²¡æœ‰åŠæ—¶å…³é—­ã€‚fdToKey æ€»æ˜¯ä¸²è¡Œè¯»å–çš„ï¼Œè€Œè¯»å–æ˜¯åœ¨ select æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œè¯¥æ–¹æ³•æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚

Pipeï¼šä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„å•å‘æ•°æ®è¿æ¥ï¼Œæ•°æ®ä¼šè¢«å†™åˆ° sink é€šé“ï¼Œä» source é€šé“è¯»å–

NIO çš„æœåŠ¡ç«¯å»ºç«‹è¿‡ç¨‹ï¼šSelector.open()ï¼šæ‰“å¼€ä¸€ä¸ª Selectorï¼›ServerSocketChannel.open()ï¼šåˆ›å»ºæœåŠ¡ç«¯çš„ Channelï¼›bind()ï¼šç»‘å®šåˆ°æŸä¸ªç«¯å£ä¸Šã€‚å¹¶é…ç½®éé˜»å¡æ¨¡å¼ï¼›register()ï¼šæ³¨å†Œ Channel å’Œå…³æ³¨çš„äº‹ä»¶åˆ° Selector ä¸Šï¼›select() è½®è¯¢æ‹¿åˆ°å·²ç»å°±ç»ªçš„äº‹ä»¶

8.Netty çš„çº¿ç¨‹æ¨¡å‹ï¼Ÿ
--------------

Netty é€šè¿‡ Reactor æ¨¡å‹åŸºäºå¤šè·¯å¤ç”¨å™¨æ¥æ”¶å¹¶å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå†…éƒ¨å®ç°äº†ä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œboss çº¿ç¨‹æ± å’Œ work çº¿ç¨‹æ± ï¼Œå…¶ä¸­ boss çº¿ç¨‹æ± çš„çº¿ç¨‹è´Ÿè´£å¤„ç†è¯·æ±‚çš„ accept äº‹ä»¶ï¼Œå½“æ¥æ”¶åˆ° accept äº‹ä»¶çš„è¯·æ±‚æ—¶ï¼ŒæŠŠå¯¹åº”çš„ socket å°è£…åˆ°ä¸€ä¸ª NioSocketChannel ä¸­ï¼Œå¹¶äº¤ç»™ work çº¿ç¨‹æ± ï¼Œå…¶ä¸­ work çº¿ç¨‹æ± è´Ÿè´£è¯·æ±‚çš„ read å’Œ write äº‹ä»¶ï¼Œç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

å•çº¿ç¨‹æ¨¡å‹ï¼šæ‰€æœ‰ I/O æ“ä½œéƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆï¼Œå³å¤šè·¯å¤ç”¨ã€äº‹ä»¶åˆ†å‘å’Œå¤„ç†éƒ½æ˜¯åœ¨ä¸€ä¸ª Reactor çº¿ç¨‹ä¸Šå®Œæˆçš„ã€‚æ—¢è¦æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚, å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥ï¼Œåˆè¦å‘é€ / è¯»å–è¯·æ±‚æˆ–åº”ç­” / å“åº”æ¶ˆæ¯ã€‚ä¸€ä¸ª NIO çº¿ç¨‹åŒæ—¶å¤„ç†æˆç™¾ä¸Šåƒçš„é“¾è·¯ï¼Œæ€§èƒ½ä¸Šæ— æ³•æ”¯æ’‘ï¼Œé€Ÿåº¦æ…¢ï¼Œè‹¥çº¿ç¨‹è¿›å…¥æ­»å¾ªç¯ï¼Œæ•´ä¸ªç¨‹åºä¸å¯ç”¨ï¼Œå¯¹äºé«˜è´Ÿè½½ã€å¤§å¹¶å‘çš„åº”ç”¨åœºæ™¯ä¸åˆé€‚ã€‚

å¤šçº¿ç¨‹æ¨¡å‹ï¼šæœ‰ä¸€ä¸ª NIO çº¿ç¨‹ï¼ˆAcceptorï¼‰ åªè´Ÿè´£ç›‘å¬æœåŠ¡ç«¯ï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„ TCP è¿æ¥è¯·æ±‚ï¼›NIO çº¿ç¨‹æ± è´Ÿè´£ç½‘ç»œ IO çš„æ“ä½œï¼Œå³æ¶ˆæ¯çš„è¯»å–ã€è§£ç ã€ç¼–ç å’Œå‘é€ï¼›1 ä¸ª NIO çº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç† N æ¡é“¾è·¯ï¼Œä½†æ˜¯ 1 ä¸ªé“¾è·¯åªå¯¹åº” 1 ä¸ª NIO çº¿ç¨‹ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å‘ç”Ÿå¹¶å‘æ“ä½œé—®é¢˜ã€‚ä½†åœ¨å¹¶å‘ç™¾ä¸‡å®¢æˆ·ç«¯è¿æ¥æˆ–éœ€è¦å®‰å…¨è®¤è¯æ—¶ï¼Œä¸€ä¸ª Acceptor çº¿ç¨‹å¯èƒ½ä¼šå­˜åœ¨æ€§èƒ½ä¸è¶³é—®é¢˜ã€‚

ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ï¼šAcceptor çº¿ç¨‹ç”¨äºç»‘å®šç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œå°† SocketChannel ä»ä¸»çº¿ç¨‹æ± çš„ Reactor çº¿ç¨‹çš„å¤šè·¯å¤ç”¨å™¨ä¸Šç§»é™¤ï¼Œé‡æ–°æ³¨å†Œåˆ° Sub çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸Šï¼Œç”¨äºå¤„ç† I/O çš„è¯»å†™ç­‰æ“ä½œï¼Œä»è€Œä¿è¯ mainReactor åªè´Ÿè´£æ¥å…¥è®¤è¯ã€æ¡æ‰‹ç­‰æ“ä½œï¼›

9.TCP ç²˜åŒ… / æ‹†åŒ…çš„åŸå› åŠè§£å†³æ–¹æ³•ï¼Ÿ
----------------------

TCP æ˜¯ä»¥æµçš„æ–¹å¼æ¥å¤„ç†æ•°æ®ï¼Œä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢« TCP æ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿå¯èƒ½æŠŠå°çš„å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ã€‚

TCP ç²˜åŒ… / åˆ†åŒ…çš„åŸå› ï¼š

åº”ç”¨ç¨‹åºå†™å…¥çš„å­—èŠ‚å¤§å°å¤§äºå¥—æ¥å­—å‘é€ç¼“å†²åŒºçš„å¤§å°ï¼Œä¼šå‘ç”Ÿæ‹†åŒ…ç°è±¡ï¼Œè€Œåº”ç”¨ç¨‹åºå†™å…¥æ•°æ®å°äºå¥—æ¥å­—ç¼“å†²åŒºå¤§å°ï¼Œç½‘å¡å°†åº”ç”¨å¤šæ¬¡å†™å…¥çš„æ•°æ®å‘é€åˆ°ç½‘ç»œä¸Šï¼Œè¿™å°†ä¼šå‘ç”Ÿç²˜åŒ…ç°è±¡ï¼›

è¿›è¡Œ MSS å¤§å°çš„ TCP åˆ†æ®µï¼Œå½“ TCP æŠ¥æ–‡é•¿åº¦ - TCP å¤´éƒ¨é•¿åº¦ > MSS çš„æ—¶å€™å°†å‘ç”Ÿæ‹†åŒ…  
ä»¥å¤ªç½‘å¸§çš„ payloadï¼ˆå‡€è·ï¼‰å¤§äº MTUï¼ˆ1500 å­—èŠ‚ï¼‰è¿›è¡Œ ip åˆ†ç‰‡ã€‚

è§£å†³æ–¹æ³•

æ¶ˆæ¯å®šé•¿ï¼šFixedLengthFrameDecoder ç±»

åŒ…å°¾å¢åŠ ç‰¹æ®Šå­—ç¬¦åˆ†å‰²ï¼š

*   è¡Œåˆ†éš”ç¬¦ç±»ï¼šLineBasedFrameDecoder
*   æˆ–è‡ªå®šä¹‰åˆ†éš”ç¬¦ç±» ï¼šDelimiterBasedFrameDecoder

å°†æ¶ˆæ¯åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼šLengthFieldBasedFrameDecoder ç±»ã€‚åˆ†ä¸ºæœ‰å¤´éƒ¨çš„æ‹†åŒ…ä¸ç²˜åŒ…ã€é•¿åº¦å­—æ®µåœ¨å‰ä¸”æœ‰å¤´éƒ¨çš„æ‹†åŒ…ä¸ç²˜åŒ…ã€å¤šæ‰©å±•å¤´éƒ¨çš„æ‹†åŒ…ä¸ç²˜åŒ…ã€‚

10. ä»€ä¹ˆæ˜¯ Netty çš„é›¶æ‹·è´ï¼Ÿ
-------------------

Netty çš„é›¶æ‹·è´ä¸»è¦åŒ…å«ä¸‰ä¸ªæ–¹é¢ï¼š

*   Netty çš„æ¥æ”¶å’Œå‘é€ ByteBuffer é‡‡ç”¨ DIRECT BUFFERSï¼Œä½¿ç”¨å †å¤–ç›´æ¥å†…å­˜è¿›è¡Œ Socket è¯»å†™ï¼Œä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´ã€‚å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„å †å†…å­˜ï¼ˆHEAP BUFFERSï¼‰è¿›è¡Œ Socket è¯»å†™ï¼ŒJVM ä¼šå°†å †å†…å­˜ Buffer æ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜ä¸­ï¼Œç„¶åæ‰å†™å…¥ Socket ä¸­ã€‚ç›¸æ¯”äºå †å¤–ç›´æ¥å†…å­˜ï¼Œæ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­å¤šäº†ä¸€æ¬¡ç¼“å†²åŒºçš„å†…å­˜æ‹·è´ã€‚
*   Netty æä¾›äº†ç»„åˆ Buffer å¯¹è±¡ï¼Œå¯ä»¥èšåˆå¤šä¸ª ByteBuffer å¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥åƒæ“ä½œä¸€ä¸ª Buffer é‚£æ ·æ–¹ä¾¿çš„å¯¹ç»„åˆ Buffer è¿›è¡Œæ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å†…å­˜æ‹·è´çš„æ–¹å¼å°†å‡ ä¸ªå° Buffer åˆå¹¶æˆä¸€ä¸ªå¤§çš„ Bufferã€‚
*   Netty çš„æ–‡ä»¶ä¼ è¾“é‡‡ç”¨äº† transferTo æ–¹æ³•ï¼Œå®ƒå¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ Channelï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯ write æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜ã€‚

11.Netty ä¸­æœ‰å“ªç§é‡è¦ç»„ä»¶ï¼Ÿ
------------------

*   Channelï¼šNetty ç½‘ç»œæ“ä½œæŠ½è±¡ç±»ï¼Œå®ƒé™¤äº†åŒ…æ‹¬åŸºæœ¬çš„ I/O æ“ä½œï¼Œå¦‚ bindã€connectã€readã€write ç­‰ã€‚
*   EventLoopï¼šä¸»è¦æ˜¯é…åˆ Channel å¤„ç† I/O æ“ä½œï¼Œç”¨æ¥å¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹æƒ…ã€‚
*   ChannelFutureï¼šNetty æ¡†æ¶ä¸­æ‰€æœ‰çš„ I/O æ“ä½œéƒ½ä¸ºå¼‚æ­¥çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ ChannelFuture çš„ addListener() æ³¨å†Œä¸€ä¸ª ChannelFutureListener ç›‘å¬äº‹ä»¶ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥æ—¶ï¼Œç›‘å¬å°±ä¼šè‡ªåŠ¨è§¦å‘è¿”å›ç»“æœã€‚
*   ChannelHandlerï¼šå……å½“äº†æ‰€æœ‰å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„é€»è¾‘å®¹å™¨ã€‚ChannelHandler ä¸»è¦ç”¨æ¥å¤„ç†å„ç§äº‹ä»¶ï¼Œè¿™é‡Œçš„äº‹ä»¶å¾ˆå¹¿æ³›ï¼Œæ¯”å¦‚å¯ä»¥æ˜¯è¿æ¥ã€æ•°æ®æ¥æ”¶ã€å¼‚å¸¸ã€æ•°æ®è½¬æ¢ç­‰ã€‚
*   ChannelPipelineï¼šä¸º ChannelHandler é“¾æä¾›äº†å®¹å™¨ï¼Œå½“ channel åˆ›å»ºæ—¶ï¼Œå°±ä¼šè¢«è‡ªåŠ¨åˆ†é…åˆ°å®ƒä¸“å±çš„ ChannelPipelineï¼Œè¿™ä¸ªå…³è”æ˜¯æ°¸ä¹…æ€§çš„ã€‚

12.Netty å‘é€æ¶ˆæ¯æœ‰å‡ ç§æ–¹å¼ï¼Ÿ
-------------------

Netty æœ‰ä¸¤ç§å‘é€æ¶ˆæ¯çš„æ–¹å¼ï¼š

*   ç›´æ¥å†™å…¥ Channel ä¸­ï¼Œæ¶ˆæ¯ä» ChannelPipeline å½“ä¸­å°¾éƒ¨å¼€å§‹ç§»åŠ¨ï¼›
*   å†™å…¥å’Œ ChannelHandler ç»‘å®šçš„ ChannelHandlerContext ä¸­ï¼Œæ¶ˆæ¯ä» ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandler ä¸­ç§»åŠ¨ã€‚

13. é»˜è®¤æƒ…å†µ Netty èµ·å¤šå°‘çº¿ç¨‹ï¼Ÿä½•æ—¶å¯åŠ¨ï¼Ÿ
--------------------------

Netty é»˜è®¤æ˜¯ CPU å¤„ç†å™¨æ•°çš„ä¸¤å€ï¼Œbind å®Œä¹‹åå¯åŠ¨ã€‚

14. äº†è§£å“ªå‡ ç§åºåˆ—åŒ–åè®®ï¼Ÿ
---------------

åºåˆ—åŒ–ï¼ˆç¼–ç ï¼‰æ˜¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶å½¢å¼ï¼ˆå­—èŠ‚æ•°ç»„ï¼‰ï¼Œä¸»è¦ç”¨äºç½‘ç»œä¼ è¾“ã€æ•°æ®æŒä¹…åŒ–ç­‰ï¼›è€Œååºåˆ—åŒ–ï¼ˆè§£ç ï¼‰åˆ™æ˜¯å°†ä»ç½‘ç»œã€ç£ç›˜ç­‰è¯»å–çš„å­—èŠ‚æ•°ç»„è¿˜åŸæˆåŸå§‹å¯¹è±¡ï¼Œä¸»è¦ç”¨äºç½‘ç»œä¼ è¾“å¯¹è±¡çš„è§£ç ï¼Œä»¥ä¾¿å®Œæˆè¿œç¨‹è°ƒç”¨ã€‚

å½±å“åºåˆ—åŒ–æ€§èƒ½çš„å…³é”®å› ç´ ï¼šåºåˆ—åŒ–åçš„ç æµå¤§å°ï¼ˆç½‘ç»œå¸¦å®½çš„å ç”¨ï¼‰ã€åºåˆ—åŒ–çš„æ€§èƒ½ï¼ˆCPU èµ„æºå ç”¨ï¼‰ï¼›æ˜¯å¦æ”¯æŒè·¨è¯­è¨€ï¼ˆå¼‚æ„ç³»ç»Ÿçš„å¯¹æ¥å’Œå¼€å‘è¯­è¨€åˆ‡æ¢ï¼‰ã€‚

Java é»˜è®¤æä¾›çš„åºåˆ—åŒ–ï¼šæ— æ³•è·¨è¯­è¨€ã€åºåˆ—åŒ–åçš„ç æµå¤ªå¤§ã€åºåˆ—åŒ–çš„æ€§èƒ½å·®

XMLï¼Œä¼˜ç‚¹ï¼šäººæœºå¯è¯»æ€§å¥½ï¼Œå¯æŒ‡å®šå…ƒç´ æˆ–ç‰¹æ€§çš„åç§°ã€‚ç¼ºç‚¹ï¼šåºåˆ—åŒ–æ•°æ®åªåŒ…å«æ•°æ®æœ¬èº«ä»¥åŠç±»çš„ç»“æ„ï¼Œä¸åŒ…æ‹¬ç±»å‹æ ‡è¯†å’Œç¨‹åºé›†ä¿¡æ¯ï¼›åªèƒ½åºåˆ—åŒ–å…¬å…±å±æ€§å’Œå­—æ®µï¼›ä¸èƒ½åºåˆ—åŒ–æ–¹æ³•ï¼›æ–‡ä»¶åºå¤§ï¼Œæ–‡ä»¶æ ¼å¼å¤æ‚ï¼Œä¼ è¾“å å¸¦å®½ã€‚é€‚ç”¨åœºæ™¯ï¼šå½“åšé…ç½®æ–‡ä»¶å­˜å‚¨æ•°æ®ï¼Œå®æ—¶æ•°æ®è½¬æ¢ã€‚

JSONï¼Œæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œä¼˜ç‚¹ï¼šå…¼å®¹æ€§é«˜ã€æ•°æ®æ ¼å¼æ¯”è¾ƒç®€å•ï¼Œæ˜“äºè¯»å†™ã€åºåˆ—åŒ–åæ•°æ®è¾ƒå°ï¼Œå¯æ‰©å±•æ€§å¥½ï¼Œå…¼å®¹æ€§å¥½ã€ä¸ XML ç›¸æ¯”ï¼Œå…¶åè®®æ¯”è¾ƒç®€å•ï¼Œè§£æé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚ç¼ºç‚¹ï¼šæ•°æ®çš„æè¿°æ€§æ¯” XML å·®ã€ä¸é€‚åˆæ€§èƒ½è¦æ±‚ä¸º ms çº§åˆ«çš„æƒ…å†µã€é¢å¤–ç©ºé—´å¼€é”€æ¯”è¾ƒå¤§ã€‚é€‚ç”¨åœºæ™¯ï¼ˆå¯æ›¿ä»£ï¼¸ï¼­ï¼¬ï¼‰ï¼šè·¨é˜²ç«å¢™è®¿é—®ã€å¯è°ƒå¼æ€§è¦æ±‚é«˜ã€åŸºäº Web browser çš„ Ajax è¯·æ±‚ã€ä¼ è¾“æ•°æ®é‡ç›¸å¯¹å°ï¼Œå®æ—¶æ€§è¦æ±‚ç›¸å¯¹ä½ï¼ˆä¾‹å¦‚ç§’çº§åˆ«ï¼‰çš„æœåŠ¡ã€‚

Fastjsonï¼Œé‡‡ç”¨ä¸€ç§ â€œå‡å®šæœ‰åºå¿«é€ŸåŒ¹é…â€ çš„ç®—æ³•ã€‚ä¼˜ç‚¹ï¼šæ¥å£ç®€å•æ˜“ç”¨ã€ç›®å‰ java è¯­è¨€ä¸­æœ€å¿«çš„ json åº“ã€‚ç¼ºç‚¹ï¼šè¿‡äºæ³¨é‡å¿«ï¼Œè€Œåç¦»äº† â€œæ ‡å‡†â€ åŠåŠŸèƒ½æ€§ã€ä»£ç è´¨é‡ä¸é«˜ï¼Œæ–‡æ¡£ä¸å…¨ã€‚é€‚ç”¨åœºæ™¯ï¼šåè®®äº¤äº’ã€Web è¾“å‡ºã€Android å®¢æˆ·ç«¯

Thriftï¼Œä¸ä»…æ˜¯åºåˆ—åŒ–åè®®ï¼Œè¿˜æ˜¯ä¸€ä¸ª RPC æ¡†æ¶ã€‚ä¼˜ç‚¹ï¼šåºåˆ—åŒ–åçš„ä½“ç§¯å°, é€Ÿåº¦å¿«ã€æ”¯æŒå¤šç§è¯­è¨€å’Œä¸°å¯Œçš„æ•°æ®ç±»å‹ã€å¯¹äºæ•°æ®å­—æ®µçš„å¢åˆ å…·æœ‰è¾ƒå¼ºçš„å…¼å®¹æ€§ã€æ”¯æŒäºŒè¿›åˆ¶å‹ç¼©ç¼–ç ã€‚ç¼ºç‚¹ï¼šä½¿ç”¨è€…è¾ƒå°‘ã€è·¨é˜²ç«å¢™è®¿é—®æ—¶ï¼Œä¸å®‰å…¨ã€ä¸å…·æœ‰å¯è¯»æ€§ï¼Œè°ƒè¯•ä»£ç æ—¶ç›¸å¯¹å›°éš¾ã€ä¸èƒ½ä¸å…¶ä»–ä¼ è¾“å±‚åè®®å…±åŒä½¿ç”¨ï¼ˆä¾‹å¦‚ HTTPï¼‰ã€æ— æ³•æ”¯æŒå‘æŒä¹…å±‚ç›´æ¥è¯»å†™æ•°æ®ï¼Œå³ä¸é€‚åˆåšæ•°æ®æŒä¹…åŒ–åºåˆ—åŒ–åè®®ã€‚é€‚ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„ RPC è§£å†³æ–¹æ¡ˆ

Avroï¼ŒHadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œè§£å†³äº† JSON çš„å†—é•¿å’Œæ²¡æœ‰ IDL çš„é—®é¢˜ã€‚ä¼˜ç‚¹ï¼šæ”¯æŒä¸°å¯Œçš„æ•°æ®ç±»å‹ã€ç®€å•çš„åŠ¨æ€è¯­è¨€ç»“åˆåŠŸèƒ½ã€å…·æœ‰è‡ªæˆ‘æè¿°å±æ€§ã€æé«˜äº†æ•°æ®è§£æé€Ÿåº¦ã€å¿«é€Ÿå¯å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®å½¢å¼ã€å¯ä»¥å®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ RPCã€æ”¯æŒè·¨ç¼–ç¨‹è¯­è¨€å®ç°ã€‚ç¼ºç‚¹ï¼šå¯¹äºä¹ æƒ¯äºé™æ€ç±»å‹è¯­è¨€çš„ç”¨æˆ·ä¸ç›´è§‚ã€‚é€‚ç”¨åœºæ™¯ï¼šåœ¨ Hadoop ä¸­åš Hiveã€Pig å’Œ MapReduce çš„æŒä¹…åŒ–æ•°æ®æ ¼å¼ã€‚

Protobufï¼Œå°†æ•°æ®ç»“æ„ä»¥. proto æ–‡ä»¶è¿›è¡Œæè¿°ï¼Œé€šè¿‡ä»£ç ç”Ÿæˆå·¥å…·å¯ä»¥ç”Ÿæˆå¯¹åº”æ•°æ®ç»“æ„çš„ POJO å¯¹è±¡å’Œ Protobuf ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§ã€‚ä¼˜ç‚¹ï¼šåºåˆ—åŒ–åç æµå°ï¼Œæ€§èƒ½é«˜ã€ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼ˆXML JSON ç­‰ï¼‰ã€é€šè¿‡æ ‡è¯†å­—æ®µçš„é¡ºåºï¼Œå¯ä»¥å®ç°åè®®çš„å‰å‘å…¼å®¹ã€ç»“æ„åŒ–çš„æ–‡æ¡£æ›´å®¹æ˜“ç®¡ç†å’Œç»´æŠ¤ã€‚ç¼ºç‚¹ï¼šéœ€è¦ä¾èµ–äºå·¥å…·ç”Ÿæˆä»£ç ã€æ”¯æŒçš„è¯­è¨€ç›¸å¯¹è¾ƒå°‘ï¼Œå®˜æ–¹åªæ”¯æŒ Javaã€C++ã€pythonã€‚é€‚ç”¨åœºæ™¯ï¼šå¯¹æ€§èƒ½è¦æ±‚é«˜çš„ RPC è°ƒç”¨ã€å…·æœ‰è‰¯å¥½çš„è·¨é˜²ç«å¢™çš„è®¿é—®å±æ€§ã€é€‚åˆåº”ç”¨å±‚å¯¹è±¡çš„æŒä¹…åŒ–

å…¶å®ƒ

protostuff åŸºäº protobuf åè®®ï¼Œä½†ä¸éœ€è¦é…ç½® proto æ–‡ä»¶ï¼Œç›´æ¥å¯¼åŒ…å³å¯  
Jboss marshaling å¯ä»¥ç›´æ¥åºåˆ—åŒ– java ç±»ï¼Œ æ— é¡»å® java.io.Serializable æ¥å£  
Message pack ä¸€ä¸ªé«˜æ•ˆçš„äºŒè¿›åˆ¶åºåˆ—åŒ–æ ¼å¼  
Hessian é‡‡ç”¨äºŒè¿›åˆ¶åè®®çš„è½»é‡çº§ remoting onhttp å·¥å…·  
kryo åŸºäº protobuf åè®®ï¼Œåªæ”¯æŒ java è¯­è¨€, éœ€è¦æ³¨å†Œï¼ˆRegistrationï¼‰ï¼Œç„¶ååºåˆ—åŒ–ï¼ˆOutputï¼‰ï¼Œååºåˆ—åŒ–ï¼ˆInputï¼‰

15. å¦‚ä½•é€‰æ‹©åºåˆ—åŒ–åè®®ï¼Ÿ
--------------

å…·ä½“åœºæ™¯

å¯¹äºå…¬å¸é—´çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœæ€§èƒ½è¦æ±‚åœ¨ 100ms ä»¥ä¸Šçš„æœåŠ¡ï¼ŒåŸºäº XML çš„ SOAP åè®®æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„æ–¹æ¡ˆã€‚  
åŸºäº Web browser çš„ Ajaxï¼Œä»¥åŠ Mobile app ä¸æœåŠ¡ç«¯ä¹‹é—´çš„é€šè®¯ï¼ŒJSON åè®®æ˜¯é¦–é€‰ã€‚å¯¹äºæ€§èƒ½è¦æ±‚ä¸å¤ªé«˜ï¼Œæˆ–è€…ä»¥åŠ¨æ€ç±»å‹è¯­è¨€ä¸ºä¸»ï¼Œæˆ–è€…ä¼ è¾“æ•°æ®è½½è·å¾ˆå°çš„çš„è¿ç”¨åœºæ™¯ï¼ŒJSON ä¹Ÿæ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚  
å¯¹äºè°ƒè¯•ç¯å¢ƒæ¯”è¾ƒæ¶åŠ£çš„åœºæ™¯ï¼Œé‡‡ç”¨ JSON æˆ– XML èƒ½å¤Ÿæå¤§çš„æé«˜è°ƒè¯•æ•ˆç‡ï¼Œé™ä½ç³»ç»Ÿå¼€å‘æˆæœ¬ã€‚  
å½“å¯¹æ€§èƒ½å’Œç®€æ´æ€§æœ‰æé«˜è¦æ±‚çš„åœºæ™¯ï¼ŒProtobufï¼ŒThriftï¼ŒAvro ä¹‹é—´å…·æœ‰ä¸€å®šçš„ç«äº‰å…³ç³»ã€‚  
å¯¹äº T çº§åˆ«çš„æ•°æ®çš„æŒä¹…åŒ–åº”ç”¨åœºæ™¯ï¼ŒProtobuf å’Œ Avro æ˜¯é¦–è¦é€‰æ‹©ã€‚å¦‚æœæŒä¹…åŒ–åçš„æ•°æ®å­˜å‚¨åœ¨ hadoop å­é¡¹ç›®é‡Œï¼ŒAvro ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

å¯¹äºæŒä¹…å±‚é Hadoop é¡¹ç›®ï¼Œä»¥é™æ€ç±»å‹è¯­è¨€ä¸ºä¸»çš„åº”ç”¨åœºæ™¯ï¼ŒProtobuf ä¼šæ›´ç¬¦åˆé™æ€ç±»å‹è¯­è¨€å·¥ç¨‹å¸ˆçš„å¼€å‘ä¹ æƒ¯ã€‚ç”±äº Avro çš„è®¾è®¡ç†å¿µåå‘äºåŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå¯¹äºåŠ¨æ€è¯­è¨€ä¸ºä¸»çš„åº”ç”¨åœºæ™¯ï¼ŒAvro æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚  
å¦‚æœéœ€è¦æä¾›ä¸€ä¸ªå®Œæ•´çš„ RPC è§£å†³æ–¹æ¡ˆï¼ŒThrift æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚  
å¦‚æœåºåˆ—åŒ–ä¹‹åéœ€è¦æ”¯æŒä¸åŒçš„ä¼ è¾“å±‚åè®®ï¼Œæˆ–è€…éœ€è¦è·¨é˜²ç«å¢™è®¿é—®çš„é«˜æ€§èƒ½åœºæ™¯ï¼ŒProtobuf å¯ä»¥ä¼˜å…ˆè€ƒè™‘ã€‚  
protobuf çš„æ•°æ®ç±»å‹æœ‰å¤šç§ï¼šboolã€doubleã€floatã€int32ã€int64ã€stringã€bytesã€enumã€messageã€‚protobuf çš„é™å®šç¬¦ï¼šrequired: å¿…é¡»èµ‹å€¼ï¼Œä¸èƒ½ä¸ºç©ºã€optional: å­—æ®µå¯ä»¥èµ‹å€¼ï¼Œä¹Ÿå¯ä»¥ä¸èµ‹å€¼ã€repeated: è¯¥å­—æ®µå¯ä»¥é‡å¤ä»»æ„æ¬¡æ•°ï¼ˆåŒ…æ‹¬ 0 æ¬¡ï¼‰ã€æšä¸¾ï¼›åªèƒ½ç”¨æŒ‡å®šçš„å¸¸é‡é›†ä¸­çš„ä¸€ä¸ªå€¼ä½œä¸ºå…¶å€¼ï¼›

protobuf çš„åŸºæœ¬è§„åˆ™ï¼šæ¯ä¸ªæ¶ˆæ¯ä¸­å¿…é¡»è‡³å°‘ç•™æœ‰ä¸€ä¸ª required ç±»å‹çš„å­—æ®µã€åŒ…å« 0 ä¸ªæˆ–å¤šä¸ª optional ç±»å‹çš„å­—æ®µï¼›repeated è¡¨ç¤ºçš„å­—æ®µå¯ä»¥åŒ…å« 0 ä¸ªæˆ–å¤šä¸ªæ•°æ®ï¼›[1,15] ä¹‹å†…çš„æ ‡è¯†å·åœ¨ç¼–ç çš„æ—¶å€™ä¼šå ç”¨ä¸€ä¸ªå­—èŠ‚ï¼ˆå¸¸ç”¨ï¼‰ï¼Œ[16,2047] ä¹‹å†…çš„æ ‡è¯†å·åˆ™å ç”¨ 2 ä¸ªå­—èŠ‚ï¼Œæ ‡è¯†å·ä¸€å®šä¸èƒ½é‡å¤ã€ä½¿ç”¨æ¶ˆæ¯ç±»å‹ï¼Œä¹Ÿå¯ä»¥å°†æ¶ˆæ¯åµŒå¥—ä»»æ„å¤šå±‚ï¼Œå¯ç”¨åµŒå¥—æ¶ˆæ¯ç±»å‹æ¥ä»£æ›¿ç»„ã€‚

protobuf çš„æ¶ˆæ¯å‡çº§åŸåˆ™ï¼šä¸è¦æ›´æ”¹ä»»ä½•å·²æœ‰çš„å­—æ®µçš„æ•°å€¼æ ‡è¯†ï¼›ä¸èƒ½ç§»é™¤å·²ç»å­˜åœ¨çš„ required å­—æ®µï¼Œoptional å’Œ repeated ç±»å‹çš„å­—æ®µå¯ä»¥è¢«ç§»é™¤ï¼Œä½†è¦ä¿ç•™æ ‡å·ä¸èƒ½è¢«é‡ç”¨ã€‚æ–°æ·»åŠ çš„å­—æ®µå¿…é¡»æ˜¯ optional æˆ– repeatedã€‚å› ä¸ºæ—§ç‰ˆæœ¬ç¨‹åºæ— æ³•è¯»å–æˆ–å†™å…¥æ–°å¢çš„ required é™å®šç¬¦çš„å­—æ®µã€‚

ç¼–è¯‘å™¨ä¸ºæ¯ä¸€ä¸ªæ¶ˆæ¯ç±»å‹ç”Ÿæˆäº†ä¸€ä¸ª. java æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ªç‰¹æ®Šçš„ Builder ç±»ï¼ˆè¯¥ç±»æ˜¯ç”¨æ¥åˆ›å»ºæ¶ˆæ¯ç±»æ¥å£çš„ï¼‰ã€‚å¦‚ï¼šUserProto.User.Builder builder = UserProto.User.newBuilder();builder.build()ï¼›

Netty ä¸­çš„ä½¿ç”¨ï¼šProtobufVarint32FrameDecoder æ˜¯ç”¨äºå¤„ç†åŠåŒ…æ¶ˆæ¯çš„è§£ç ç±»ï¼›ProtobufDecoder(UserProto.User.getDefaultInstance()) è¿™æ˜¯åˆ›å»ºçš„ UserProto.java æ–‡ä»¶ä¸­çš„è§£ç ç±»ï¼›ProtobufVarint32LengthFieldPrepender å¯¹ protobuf åè®®çš„æ¶ˆæ¯å¤´ä¸ŠåŠ ä¸Šä¸€ä¸ªé•¿åº¦ä¸º 32 çš„æ•´å½¢å­—æ®µï¼Œç”¨äºæ ‡å¿—è¿™ä¸ªæ¶ˆæ¯çš„é•¿åº¦çš„ç±»ï¼›ProtobufEncoder æ˜¯ç¼–ç ç±»

å°† StringBuilder è½¬æ¢ä¸º ByteBuf ç±»å‹ï¼šcopiedBuffer() æ–¹æ³•

16.Netty æ”¯æŒå“ªäº›å¿ƒè·³ç±»å‹è®¾ç½®ï¼Ÿ
--------------------

*   readerIdleTimeï¼šä¸ºè¯»è¶…æ—¶æ—¶é—´ï¼ˆå³æµ‹è¯•ç«¯ä¸€å®šæ—¶é—´å†…æœªæ¥å—åˆ°è¢«æµ‹è¯•ç«¯æ¶ˆæ¯ï¼‰ã€‚
*   writerIdleTimeï¼šä¸ºå†™è¶…æ—¶æ—¶é—´ï¼ˆå³æµ‹è¯•ç«¯ä¸€å®šæ—¶é—´å†…å‘è¢«æµ‹è¯•ç«¯å‘é€æ¶ˆæ¯ï¼‰ã€‚
*   allIdleTimeï¼šæ‰€æœ‰ç±»å‹çš„è¶…æ—¶æ—¶é—´ã€‚

17.Netty å’Œ Tomcat çš„åŒºåˆ«ï¼Ÿ
----------------------

*   ä½œç”¨ä¸åŒï¼šTomcat æ˜¯ Servlet å®¹å™¨ï¼Œå¯ä»¥è§†ä¸º Web æœåŠ¡å™¨ï¼Œè€Œ Netty æ˜¯å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶å’Œå·¥å…·ç”¨äºç®€åŒ–ç½‘ç»œç¼–ç¨‹ï¼Œä¾‹å¦‚ TCP å’Œ UDP å¥—æ¥å­—æœåŠ¡å™¨ã€‚
*   åè®®ä¸åŒï¼šTomcat æ˜¯åŸºäº http åè®®çš„ Web æœåŠ¡å™¨ï¼Œè€Œ Netty èƒ½é€šè¿‡ç¼–ç¨‹è‡ªå®šä¹‰å„ç§åè®®ï¼Œå› ä¸º Netty æœ¬èº«è‡ªå·±èƒ½ç¼–ç  / è§£ç å­—èŠ‚æµï¼Œæ‰€æœ‰ Netty å¯ä»¥å®ç°ï¼ŒHTTP æœåŠ¡å™¨ã€FTP æœåŠ¡å™¨ã€UDP æœåŠ¡å™¨ã€RPC æœåŠ¡å™¨ã€WebSocket æœåŠ¡å™¨ã€Redis çš„ Proxy æœåŠ¡å™¨ã€MySQL çš„ Proxy æœåŠ¡å™¨ç­‰ç­‰ã€‚

18.NIOEventLoopGroup æºç ï¼Ÿ
------------------------

NioEventLoopGroup(å…¶å®æ˜¯ MultithreadEventExecutorGroup) å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªç±»å‹ä¸º EventExecutor children [], é»˜è®¤å¤§å°æ˜¯å¤„ç†å™¨æ ¸æ•° * 2, è¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåˆå§‹åŒ– EventExecutor æ—¶ NioEventLoopGroup é‡è½½ newChild æ–¹æ³•ï¼Œæ‰€ä»¥ children å…ƒç´ çš„å®é™…ç±»å‹ä¸º NioEventLoopã€‚

çº¿ç¨‹å¯åŠ¨æ—¶è°ƒç”¨ SingleThreadEventExecutor çš„æ„é€ æ–¹æ³•ï¼Œæ‰§è¡Œ NioEventLoop ç±»çš„ run æ–¹æ³•ï¼Œé¦–å…ˆä¼šè°ƒç”¨ hasTasks() æ–¹æ³•åˆ¤æ–­å½“å‰ taskQueue æ˜¯å¦æœ‰å…ƒç´ ã€‚å¦‚æœ taskQueue ä¸­æœ‰å…ƒç´ ï¼Œæ‰§è¡Œ selectNow() æ–¹æ³•ï¼Œæœ€ç»ˆæ‰§è¡Œ selector.selectNow()ï¼Œè¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›ã€‚å¦‚æœ taskQueue æ²¡æœ‰å…ƒç´ ï¼Œæ‰§è¡Œ select(oldWakenUp) æ–¹æ³•

select (oldWakenUp) æ–¹æ³•è§£å†³äº† Nio ä¸­çš„ bugï¼ŒselectCnt ç”¨æ¥è®°å½• selector.select æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°å’Œæ ‡è¯†æ˜¯å¦æ‰§è¡Œè¿‡ selector.selectNow()ï¼Œè‹¥è§¦å‘äº† epoll çš„ç©ºè½®è¯¢ bugï¼Œåˆ™ä¼šåå¤æ‰§è¡Œ selector.select(timeoutMillis)ï¼Œå˜é‡ selectCnt ä¼šé€æ¸å˜å¤§ï¼Œå½“ selectCnt è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ 512ï¼‰ï¼Œåˆ™æ‰§è¡Œ rebuildSelector æ–¹æ³•ï¼Œè¿›è¡Œ selector é‡å»ºï¼Œè§£å†³ cpu å ç”¨ 100% çš„ bugã€‚

rebuildSelector æ–¹æ³•å…ˆé€šè¿‡ openSelector æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„ selectorã€‚ç„¶åå°† old selector çš„ selectionKey æ‰§è¡Œ cancelã€‚æœ€åå°† old selector çš„ channel é‡æ–°æ³¨å†Œåˆ°æ–°çš„ selector ä¸­ã€‚rebuild åï¼Œéœ€è¦é‡æ–°æ‰§è¡Œæ–¹æ³• selectNowï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å·² ready çš„ selectionKeyã€‚

æ¥ä¸‹æ¥è°ƒç”¨ processSelectedKeys æ–¹æ³•ï¼ˆå¤„ç† I/O ä»»åŠ¡ï¼‰ï¼Œå½“ selectedKeys != null æ—¶ï¼Œè°ƒç”¨ processSelectedKeysOptimized æ–¹æ³•ï¼Œè¿­ä»£ selectedKeys è·å–å°±ç»ªçš„ IO äº‹ä»¶çš„ selectkey å­˜æ”¾åœ¨æ•°ç»„ selectedKeys ä¸­, ç„¶åä¸ºæ¯ä¸ªäº‹ä»¶éƒ½è°ƒç”¨ processSelectedKey æ¥å¤„ç†å®ƒï¼ŒprocessSelectedKey ä¸­åˆ†åˆ«å¤„ç† OP_READï¼›OP_WRITEï¼›OP_CONNECT äº‹ä»¶ã€‚

æœ€åè°ƒç”¨ runAllTasks æ–¹æ³•ï¼ˆé IO ä»»åŠ¡ï¼‰ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨ fetchFromScheduledTaskQueue æ–¹æ³•ï¼ŒæŠŠ scheduledTaskQueue ä¸­å·²ç»è¶…è¿‡å»¶è¿Ÿæ‰§è¡Œæ—¶é—´çš„ä»»åŠ¡ç§»åˆ° taskQueue ä¸­ç­‰å¾…è¢«æ‰§è¡Œï¼Œç„¶åä¾æ¬¡ä» taskQueue ä¸­å–ä»»åŠ¡æ‰§è¡Œï¼Œæ¯æ‰§è¡Œ 64 ä¸ªä»»åŠ¡ï¼Œè¿›è¡Œè€—æ—¶æ£€æŸ¥ï¼Œå¦‚æœå·²æ‰§è¡Œæ—¶é—´è¶…è¿‡é¢„å…ˆè®¾å®šçš„æ‰§è¡Œæ—¶é—´ï¼Œåˆ™åœæ­¢æ‰§è¡Œé IO ä»»åŠ¡ï¼Œé¿å…é IO ä»»åŠ¡å¤ªå¤šï¼Œå½±å“ IO ä»»åŠ¡çš„æ‰§è¡Œã€‚

æ¯ä¸ª NioEventLoop å¯¹åº”ä¸€ä¸ªçº¿ç¨‹å’Œä¸€ä¸ª Selectorï¼ŒNioServerSocketChannel ä¼šä¸»åŠ¨æ³¨å†Œåˆ°æŸä¸€ä¸ª NioEventLoop çš„ Selector ä¸Šï¼ŒNioEventLoop è´Ÿè´£äº‹ä»¶è½®è¯¢ã€‚

Outbound äº‹ä»¶éƒ½æ˜¯è¯·æ±‚äº‹ä»¶, å‘èµ·è€…æ˜¯ Channelï¼Œå¤„ç†è€…æ˜¯ unsafeï¼Œé€šè¿‡ Outbound äº‹ä»¶è¿›è¡Œé€šçŸ¥ï¼Œä¼ æ’­æ–¹å‘æ˜¯ tail åˆ° headã€‚Inbound äº‹ä»¶å‘èµ·è€…æ˜¯ unsafeï¼Œäº‹ä»¶çš„å¤„ç†è€…æ˜¯ Channel, æ˜¯é€šçŸ¥äº‹ä»¶ï¼Œä¼ æ’­æ–¹å‘æ˜¯ä»å¤´åˆ°å°¾ã€‚

å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œé¦–å…ˆä¼šé¢„ç”³è¯·ä¸€å¤§å—å†…å­˜ Arenaï¼ŒArena ç”±è®¸å¤š Chunk ç»„æˆï¼Œè€Œæ¯ä¸ª Chunk é»˜è®¤ç”± 2048 ä¸ª page ç»„æˆã€‚Chunk é€šè¿‡ AVL æ ‘çš„å½¢å¼ç»„ç»‡ Pageï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ª Pageï¼Œè€Œä¸­é—´èŠ‚ç‚¹è¡¨ç¤ºå†…å­˜åŒºåŸŸï¼ŒèŠ‚ç‚¹è‡ªå·±è®°å½•å®ƒåœ¨æ•´ä¸ª Arena ä¸­çš„åç§»åœ°å€ã€‚å½“åŒºåŸŸè¢«åˆ†é…å‡ºå»åï¼Œä¸­é—´èŠ‚ç‚¹ä¸Šçš„æ ‡è®°ä½ä¼šè¢«æ ‡è®°ï¼Œè¿™æ ·å°±è¡¨ç¤ºè¿™ä¸ªä¸­é—´èŠ‚ç‚¹ä»¥ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å·²è¢«åˆ†é…äº†ã€‚å¤§äº 8k çš„å†…å­˜åˆ†é…åœ¨ poolChunkList ä¸­ï¼Œè€Œ PoolSubpage ç”¨äºåˆ†é…å°äº 8k çš„å†…å­˜ï¼Œå®ƒä¼šæŠŠä¸€ä¸ª page åˆ†å‰²æˆå¤šæ®µï¼Œè¿›è¡Œå†…å­˜åˆ†é…ã€‚

ByteBuf çš„ç‰¹ç‚¹ï¼šæ”¯æŒè‡ªåŠ¨æ‰©å®¹ï¼ˆ4Mï¼‰ï¼Œä¿è¯ put æ–¹æ³•ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€é€šè¿‡å†…ç½®çš„å¤åˆç¼“å†²ç±»å‹ï¼Œå®ç°é›¶æ‹·è´ï¼ˆzero-copyï¼‰ï¼›ä¸éœ€è¦è°ƒç”¨ flip() æ¥åˆ‡æ¢è¯» / å†™æ¨¡å¼ï¼Œè¯»å–å’Œå†™å…¥ç´¢å¼•åˆ†å¼€ï¼›æ–¹æ³•é“¾ï¼›å¼•ç”¨è®¡æ•°åŸºäº AtomicIntegerFieldUpdater ç”¨äºå†…å­˜å›æ”¶ï¼›PooledByteBuf é‡‡ç”¨äºŒå‰æ ‘æ¥å®ç°ä¸€ä¸ªå†…å­˜æ± ï¼Œé›†ä¸­ç®¡ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œä¸ç”¨æ¯æ¬¡ä½¿ç”¨éƒ½æ–°å»ºä¸€ä¸ªç¼“å†²åŒºå¯¹è±¡ã€‚UnpooledHeapByteBuf æ¯æ¬¡éƒ½ä¼šæ–°å»ºä¸€ä¸ªç¼“å†²åŒºå¯¹è±¡ã€‚

Netty ç®€ä»‹
--------

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJjZmJiZTlmNjY?x-oss-process=image/format,png)

Netty æ˜¯ ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚

### JDK åŸç”Ÿ NIO ç¨‹åºçš„é—®é¢˜

JDK åŸç”Ÿä¹Ÿæœ‰ä¸€å¥—ç½‘ç»œåº”ç”¨ç¨‹åº APIï¼Œä½†æ˜¯å­˜åœ¨ä¸€ç³»åˆ—é—®é¢˜ï¼Œä¸»è¦å¦‚ä¸‹ï¼š

*   NIO çš„ç±»åº“å’Œ API ç¹æ‚ï¼Œä½¿ç”¨éº»çƒ¦ï¼Œä½ éœ€è¦ç†Ÿç»ƒæŒæ¡ Selectorã€ServerSocketChannelã€SocketChannelã€ByteBuffer ç­‰
*   éœ€è¦å…·å¤‡å…¶å®ƒçš„é¢å¤–æŠ€èƒ½åšé“ºå«ï¼Œä¾‹å¦‚ç†Ÿæ‚‰ Java å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå› ä¸º NIO ç¼–ç¨‹æ¶‰åŠåˆ° Reactor æ¨¡å¼ï¼Œä½ å¿…é¡»å¯¹å¤šçº¿ç¨‹å’Œç½‘è·¯ç¼–ç¨‹éå¸¸ç†Ÿæ‚‰ï¼Œæ‰èƒ½ç¼–å†™å‡ºé«˜è´¨é‡çš„ NIO ç¨‹åº
*   å¯é æ€§èƒ½åŠ›è¡¥é½ï¼Œå¼€å‘å·¥ä½œé‡å’Œéš¾åº¦éƒ½éå¸¸å¤§ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯é¢ä¸´æ–­è¿é‡è¿ã€ç½‘ç»œé—ªæ–­ã€åŠåŒ…è¯»å†™ã€å¤±è´¥ç¼“å­˜ã€ç½‘ç»œæ‹¥å¡å’Œå¼‚å¸¸ç æµçš„å¤„ç†ç­‰ç­‰ï¼ŒNIO ç¼–ç¨‹çš„ç‰¹ç‚¹æ˜¯åŠŸèƒ½å¼€å‘ç›¸å¯¹å®¹æ˜“ï¼Œä½†æ˜¯å¯é æ€§èƒ½åŠ›è¡¥é½å·¥ä½œé‡å’Œéš¾åº¦éƒ½éå¸¸å¤§
*   JDK NIO çš„ BUGï¼Œä¾‹å¦‚è‡­åæ˜­è‘—çš„ epoll bugï¼Œå®ƒä¼šå¯¼è‡´ Selector ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´ CPU 100%ã€‚å®˜æ–¹å£°ç§°åœ¨ JDK1.6 ç‰ˆæœ¬çš„ update18 ä¿®å¤äº†è¯¥é—®é¢˜ï¼Œä½†æ˜¯ç›´åˆ° JDK1.7 ç‰ˆæœ¬è¯¥é—®é¢˜ä»æ—§å­˜åœ¨ï¼Œåªä¸è¿‡è¯¥ bug å‘ç”Ÿæ¦‚ç‡é™ä½äº†ä¸€äº›è€Œå·²ï¼Œå®ƒå¹¶æ²¡æœ‰è¢«æ ¹æœ¬è§£å†³

### Netty çš„ç‰¹ç‚¹

Netty çš„å¯¹ JDK è‡ªå¸¦çš„ NIO çš„ API è¿›è¡Œå°è£…ï¼Œè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸»è¦ç‰¹ç‚¹æœ‰ï¼š

*   è®¾è®¡ä¼˜é›… é€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ API - é˜»å¡å’Œéé˜»å¡ Socket åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ï¼Œå¯ä»¥æ¸…æ™°åœ°åˆ†ç¦»å…³æ³¨ç‚¹ é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹ - å•çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ±  çœŸæ­£çš„æ— è¿æ¥æ•°æ®æŠ¥å¥—æ¥å­—æ”¯æŒï¼ˆè‡ª 3.1 èµ·ï¼‰
*   ä½¿ç”¨æ–¹ä¾¿ è¯¦ç»†è®°å½•çš„ Javadocï¼Œç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ æ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹ï¼ŒJDK 5ï¼ˆNetty 3.xï¼‰æˆ– 6ï¼ˆNetty 4.xï¼‰å°±è¶³å¤Ÿäº†
*   é«˜æ€§èƒ½ ååé‡æ›´é«˜ï¼Œå»¶è¿Ÿæ›´ä½ å‡å°‘èµ„æºæ¶ˆè€— æœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶
*   å®‰å…¨ å®Œæ•´çš„ SSL / TLS å’Œ StartTLS æ”¯æŒ
*   ç¤¾åŒºæ´»è·ƒï¼Œä¸æ–­æ›´æ–° ç¤¾åŒºæ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œå‘ç°çš„ BUG å¯ä»¥è¢«åŠæ—¶ä¿®å¤ï¼ŒåŒæ—¶ï¼Œæ›´å¤šçš„æ–°åŠŸèƒ½ä¼šè¢«åŠ å…¥

### Netty å¸¸è§ä½¿ç”¨åœºæ™¯

Netty å¸¸è§çš„ä½¿ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

*   äº’è”ç½‘è¡Œä¸š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éœ€è¦è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Œé«˜æ€§èƒ½çš„ RPC æ¡†æ¶å¿…ä¸å¯å°‘ï¼ŒNetty ä½œä¸ºå¼‚æ­¥é«˜æ–°èƒ½çš„é€šä¿¡æ¡†æ¶, å¾€å¾€ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶è¢«è¿™äº› RPC æ¡†æ¶ä½¿ç”¨ã€‚ å…¸å‹çš„åº”ç”¨æœ‰ï¼šé˜¿é‡Œåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ Dubbo çš„ RPC æ¡†æ¶ä½¿ç”¨ Dubbo åè®®è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡ï¼ŒDubbo åè®®é»˜è®¤ä½¿ç”¨ Netty ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œç”¨äºå®ç°å„è¿›ç¨‹èŠ‚ç‚¹ä¹‹é—´çš„å†…éƒ¨é€šä¿¡ã€‚
*   æ¸¸æˆè¡Œä¸š æ— è®ºæ˜¯æ‰‹æ¸¸æœåŠ¡ç«¯è¿˜æ˜¯å¤§å‹çš„ç½‘ç»œæ¸¸æˆï¼ŒJava è¯­è¨€å¾—åˆ°äº†è¶Šæ¥è¶Šå¹¿æ³›çš„åº”ç”¨ã€‚Netty ä½œä¸ºé«˜æ€§èƒ½çš„åŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œå®ƒæœ¬èº«æä¾›äº† TCP/UDP å’Œ HTTP åè®®æ ˆã€‚ éå¸¸æ–¹ä¾¿å®šåˆ¶å’Œå¼€å‘ç§æœ‰åè®®æ ˆï¼Œè´¦å·ç™»å½•æœåŠ¡å™¨ï¼Œåœ°å›¾æœåŠ¡å™¨ä¹‹é—´å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ Netty è¿›è¡Œé«˜æ€§èƒ½çš„é€šä¿¡
*   å¤§æ•°æ®é¢†åŸŸ ç»å…¸çš„ Hadoop çš„é«˜æ€§èƒ½é€šä¿¡å’Œåºåˆ—åŒ–ç»„ä»¶ Avro çš„ RPC æ¡†æ¶ï¼Œé»˜è®¤é‡‡ç”¨ Netty è¿›è¡Œè·¨ç•Œç‚¹é€šä¿¡ï¼Œå®ƒçš„ Netty Service åŸºäº Netty æ¡†æ¶äºŒæ¬¡å°è£…å®ç°

æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥äº†è§£ä¸€ä¸‹ç›®å‰æœ‰å“ªäº›å¼€æºé¡¹ç›®ä½¿ç”¨äº† Nettyï¼š[Related projects](https://netty.io/wiki/related-projects.html)

Netty é«˜æ€§èƒ½è®¾è®¡
-----------

Netty ä½œä¸ºå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œï¼Œé«˜æ€§èƒ½ä¹‹å¤„ä¸»è¦æ¥è‡ªäºå…¶ I/O æ¨¡å‹å’Œçº¿ç¨‹å¤„ç†æ¨¡å‹ï¼Œå‰è€…å†³å®šå¦‚ä½•æ”¶å‘æ•°æ®ï¼Œåè€…å†³å®šå¦‚ä½•å¤„ç†æ•°æ®

### I/O æ¨¡å‹

ç”¨ä»€ä¹ˆæ ·çš„é€šé“å°†æ•°æ®å‘é€ç»™å¯¹æ–¹ï¼ŒBIOã€NIO æˆ–è€… AIOï¼ŒI/O æ¨¡å‹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†æ¡†æ¶çš„æ€§èƒ½

#### é˜»å¡ I/O

ä¼ ç»Ÿé˜»å¡å‹ I/O(BIO) å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJjZmI3MGMxMTE?x-oss-process=image/format,png)

**ç‰¹ç‚¹**

*   æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ® readï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ® write çš„å®Œæ•´æ“ä½œ

**é—®é¢˜**

*   å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§
*   è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨ read æ“ä½œä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹

#### I/O å¤ç”¨æ¨¡å‹

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJjZmJhNTNjMGE?x-oss-process=image/format,png)

åœ¨ I/O å¤ç”¨æ¨¡å‹ä¸­ï¼Œä¼šç”¨åˆ° selectï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿä¼šä½¿è¿›ç¨‹é˜»å¡ï¼Œä½†æ˜¯å’Œé˜»å¡ I/O æ‰€ä¸åŒçš„çš„ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥åŒæ—¶é˜»å¡å¤šä¸ª I/O æ“ä½œï¼Œè€Œä¸”å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªè¯»æ“ä½œï¼Œå¤šä¸ªå†™æ“ä½œçš„ I/O å‡½æ•°è¿›è¡Œæ£€æµ‹ï¼Œç›´åˆ°æœ‰æ•°æ®å¯è¯»æˆ–å¯å†™æ—¶ï¼Œæ‰çœŸæ­£è°ƒç”¨ I/O æ“ä½œå‡½æ•°

Netty çš„éé˜»å¡ I/O çš„å®ç°å…³é”®æ˜¯åŸºäº I/O å¤ç”¨æ¨¡å‹ï¼Œè¿™é‡Œç”¨ Selector å¯¹è±¡è¡¨ç¤ºï¼š

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJjZmJhMzIxNjk?x-oss-process=image/format,png)

Netty çš„ IO çº¿ç¨‹ NioEventLoop ç”±äºèšåˆäº†å¤šè·¯å¤ç”¨å™¨ Selectorï¼Œå¯ä»¥åŒæ—¶å¹¶å‘å¤„ç†æˆç™¾ä¸Šåƒä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å½“çº¿ç¨‹ä»æŸå®¢æˆ·ç«¯ Socket é€šé“è¿›è¡Œè¯»å†™æ•°æ®æ—¶ï¼Œè‹¥æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹å¯ä»¥è¿›è¡Œå…¶ä»–ä»»åŠ¡ã€‚çº¿ç¨‹é€šå¸¸å°†éé˜»å¡ IO çš„ç©ºé—²æ—¶é—´ç”¨äºåœ¨å…¶ä»–é€šé“ä¸Šæ‰§è¡Œ IO æ“ä½œï¼Œæ‰€ä»¥å•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºé€šé“ã€‚

ç”±äºè¯»å†™æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ï¼Œè¿™å°±å¯ä»¥å……åˆ†æå‡ IO çº¿ç¨‹çš„è¿è¡Œæ•ˆç‡ï¼Œé¿å…ç”±äºé¢‘ç¹ I/O é˜»å¡å¯¼è‡´çš„çº¿ç¨‹æŒ‚èµ·ï¼Œä¸€ä¸ª I/O çº¿ç¨‹å¯ä»¥å¹¶å‘å¤„ç† N ä¸ªå®¢æˆ·ç«¯è¿æ¥å’Œè¯»å†™æ“ä½œï¼Œè¿™ä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¼ ç»ŸåŒæ­¥é˜»å¡ I/O ä¸€è¿æ¥ä¸€çº¿ç¨‹æ¨¡å‹ï¼Œæ¶æ„çš„æ€§èƒ½ã€å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›å’Œå¯é æ€§éƒ½å¾—åˆ°äº†æå¤§çš„æå‡ã€‚

#### åŸºäº buffer

ä¼ ç»Ÿçš„ I/O æ˜¯é¢å‘å­—èŠ‚æµæˆ–å­—ç¬¦æµçš„ï¼Œä»¥æµå¼çš„æ–¹å¼é¡ºåºåœ°ä»ä¸€ä¸ª Stream ä¸­è¯»å–ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚, å› æ­¤ä¹Ÿå°±ä¸èƒ½éšæ„æ”¹å˜è¯»å–æŒ‡é’ˆçš„ä½ç½®ã€‚

åœ¨ NIO ä¸­, æŠ›å¼ƒäº†ä¼ ç»Ÿçš„ I/O æµ, è€Œæ˜¯å¼•å…¥äº† Channel å’Œ Buffer çš„æ¦‚å¿µ. åœ¨ NIO ä¸­, åªèƒ½ä» Channel ä¸­è¯»å–æ•°æ®åˆ° Buffer ä¸­æˆ–å°†æ•°æ® Buffer ä¸­å†™å…¥åˆ° Channelã€‚

åŸºäº buffer æ“ä½œä¸åƒä¼ ç»Ÿ IO çš„é¡ºåºæ“ä½œ, NIO ä¸­å¯ä»¥éšæ„åœ°è¯»å–ä»»æ„ä½ç½®çš„æ•°æ®

### çº¿ç¨‹æ¨¡å‹

æ•°æ®æŠ¥å¦‚ä½•è¯»å–ï¼Ÿè¯»å–ä¹‹åçš„ç¼–è§£ç åœ¨å“ªä¸ªçº¿ç¨‹è¿›è¡Œï¼Œç¼–è§£ç åçš„æ¶ˆæ¯å¦‚ä½•æ´¾å‘ï¼Œçº¿ç¨‹æ¨¡å‹çš„ä¸åŒï¼Œå¯¹æ€§èƒ½çš„å½±å“ä¹Ÿéå¸¸å¤§ã€‚

#### äº‹ä»¶é©±åŠ¨æ¨¡å‹

é€šå¸¸ï¼Œæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªäº‹ä»¶å¤„ç†æ¨¡å‹çš„ç¨‹åºæœ‰ä¸¤ç§æ€è·¯

*   è½®è¯¢æ–¹å¼ çº¿ç¨‹ä¸æ–­è½®è¯¢è®¿é—®ç›¸å…³äº‹ä»¶å‘ç”Ÿæºæœ‰æ²¡æœ‰å‘ç”Ÿäº‹ä»¶ï¼Œæœ‰å‘ç”Ÿäº‹ä»¶å°±è°ƒç”¨äº‹ä»¶å¤„ç†é€»è¾‘ã€‚
*   äº‹ä»¶é©±åŠ¨æ–¹å¼ å‘ç”Ÿäº‹ä»¶ï¼Œä¸»çº¿ç¨‹æŠŠäº‹ä»¶æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œåœ¨å¦å¤–çº¿ç¨‹ä¸æ–­å¾ªç¯æ¶ˆè´¹äº‹ä»¶åˆ—è¡¨ä¸­çš„äº‹ä»¶ï¼Œè°ƒç”¨äº‹ä»¶å¯¹åº”çš„å¤„ç†é€»è¾‘å¤„ç†äº‹ä»¶ã€‚äº‹ä»¶é©±åŠ¨æ–¹å¼ä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯é€šçŸ¥æ–¹å¼ï¼Œå…¶å®æ˜¯è®¾è®¡æ¨¡å¼ä¸­**è§‚å¯Ÿè€…æ¨¡å¼**çš„æ€è·¯ã€‚

ä»¥ GUI çš„é€»è¾‘å¤„ç†ä¸ºä¾‹ï¼Œè¯´æ˜ä¸¤ç§é€»è¾‘çš„ä¸åŒï¼š

*   è½®è¯¢æ–¹å¼ çº¿ç¨‹ä¸æ–­è½®è¯¢æ˜¯å¦å‘ç”ŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œå¦‚æœå‘ç”Ÿï¼Œè°ƒç”¨å¤„ç†é€»è¾‘
*   äº‹ä»¶é©±åŠ¨æ–¹å¼ å‘ç”Ÿç‚¹å‡»äº‹ä»¶æŠŠäº‹ä»¶æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œåœ¨å¦å¤–çº¿ç¨‹æ¶ˆè´¹çš„äº‹ä»¶åˆ—è¡¨ä¸­çš„äº‹ä»¶ï¼Œæ ¹æ®äº‹ä»¶ç±»å‹è°ƒç”¨ç›¸å…³äº‹ä»¶å¤„ç†é€»è¾‘

è¿™é‡Œå€Ÿç”¨ Oâ€™Reilly å¤§ç¥å…³äº[äº‹ä»¶é©±åŠ¨æ¨¡å‹è§£é‡Šå›¾](http://www.oreilly.com/programming/free/software-architecture-patterns.csp)

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJjZmJkZjM0Mzk?x-oss-process=image/format,png)

ä¸»è¦åŒ…æ‹¬ 4 ä¸ªåŸºæœ¬ç»„ä»¶ï¼š

*   äº‹ä»¶é˜Ÿåˆ—ï¼ˆevent queueï¼‰ï¼šæ¥æ”¶äº‹ä»¶çš„å…¥å£ï¼Œå­˜å‚¨å¾…å¤„ç†äº‹ä»¶
*   åˆ†å‘å™¨ï¼ˆevent mediatorï¼‰ï¼šå°†ä¸åŒçš„äº‹ä»¶åˆ†å‘åˆ°ä¸åŒçš„ä¸šåŠ¡é€»è¾‘å•å…ƒ
*   äº‹ä»¶é€šé“ï¼ˆevent channelï¼‰ï¼šåˆ†å‘å™¨ä¸å¤„ç†å™¨ä¹‹é—´çš„è”ç³»æ¸ é“
*   äº‹ä»¶å¤„ç†å™¨ï¼ˆevent processorï¼‰ï¼šå®ç°ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å®Œæˆåä¼šå‘å‡ºäº‹ä»¶ï¼Œè§¦å‘ä¸‹ä¸€æ­¥æ“ä½œ

å¯ä»¥çœ‹å‡ºï¼Œç›¸å¯¹ä¼ ç»Ÿè½®è¯¢æ¨¡å¼ï¼Œäº‹ä»¶é©±åŠ¨æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

*   å¯æ‰©å±•æ€§å¥½ï¼Œåˆ†å¸ƒå¼çš„å¼‚æ­¥æ¶æ„ï¼Œäº‹ä»¶å¤„ç†å™¨ä¹‹é—´é«˜åº¦è§£è€¦ï¼Œå¯ä»¥æ–¹ä¾¿æ‰©å±•äº‹ä»¶å¤„ç†é€»è¾‘
*   é«˜æ€§èƒ½ï¼ŒåŸºäºé˜Ÿåˆ—æš‚å­˜äº‹ä»¶ï¼Œèƒ½æ–¹ä¾¿å¹¶è¡Œå¼‚æ­¥å¤„ç†äº‹ä»¶

#### Reactor çº¿ç¨‹æ¨¡å‹

Reactor æ˜¯ååº”å †çš„æ„æ€ï¼ŒReactor æ¨¡å‹ï¼Œæ˜¯æŒ‡é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„æœåŠ¡è¯·æ±‚çš„**äº‹ä»¶é©±åŠ¨å¤„ç†æ¨¡å¼**ã€‚ æœåŠ¡ç«¯ç¨‹åºå¤„ç†ä¼ å…¥å¤šè·¯è¯·æ±‚ï¼Œå¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾ç»™è¯·æ±‚å¯¹åº”çš„å¤„ç†çº¿ç¨‹ï¼ŒReactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ï¼Œå³ I/O å¤šäº†å¤ç”¨ç»Ÿä¸€ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶ååˆ†å‘ (Dispatch ç»™æŸè¿›ç¨‹)ï¼Œæ˜¯ç¼–å†™é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨çš„å¿…å¤‡æŠ€æœ¯ä¹‹ä¸€ã€‚

Reactor æ¨¡å‹ä¸­æœ‰ 2 ä¸ªå…³é”®ç»„æˆï¼š

*   Reactor Reactor åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ IO äº‹ä»¶åšå‡ºååº”ã€‚ å®ƒå°±åƒå…¬å¸çš„ç”µè¯æ¥çº¿å‘˜ï¼Œå®ƒæ¥å¬æ¥è‡ªå®¢æˆ·çš„ç”µè¯å¹¶å°†çº¿è·¯è½¬ç§»åˆ°é€‚å½“çš„è”ç³»äºº
*   Handlers å¤„ç†ç¨‹åºæ‰§è¡Œ I/O äº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼Œç±»ä¼¼äºå®¢æˆ·æƒ³è¦ä¸ä¹‹äº¤è°ˆçš„å…¬å¸ä¸­çš„å®é™…å®˜å‘˜ã€‚Reactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” I/O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œ

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJkYzY1NGQ2ZGM?x-oss-process=image/format,png)

å–å†³äº Reactor çš„æ•°é‡å’Œ Hanndler çº¿ç¨‹æ•°é‡çš„ä¸åŒï¼ŒReactor æ¨¡å‹æœ‰ 3 ä¸ªå˜ç§

*   å• Reactor å•çº¿ç¨‹
*   å• Reactor å¤šçº¿ç¨‹
*   ä¸»ä» Reactor å¤šçº¿ç¨‹

å¯ä»¥è¿™æ ·ç†è§£ï¼ŒReactor å°±æ˜¯ä¸€ä¸ªæ‰§è¡Œ while (true) { selector.select(); â€¦} å¾ªç¯çš„çº¿ç¨‹ï¼Œä¼šæºæºä¸æ–­çš„äº§ç”Ÿæ–°çš„äº‹ä»¶ï¼Œç§°ä½œååº”å †å¾ˆè´´åˆ‡ã€‚

ç¯‡å¹…å…³ç³»ï¼Œè¿™é‡Œä¸å†å…·ä½“å±•å¼€ Reactor ç‰¹æ€§ã€ä¼˜ç¼ºç‚¹æ¯”è¾ƒï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼š[ã€Šç†è§£é«˜æ€§èƒ½ç½‘ç»œæ¨¡å‹ã€‹](https://www.jianshu.com/p/2965fca6bb8f)

#### Netty çº¿ç¨‹æ¨¡å‹

Netty ä¸»è¦**åŸºäºä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹**ï¼ˆå¦‚ä¸‹å›¾ï¼‰åšäº†ä¸€å®šçš„ä¿®æ”¹ï¼Œå…¶ä¸­ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª Reactorï¼šMainReactor å’Œ SubReactorï¼š

*   MainReactor è´Ÿè´£å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬äº¤ç»™ SubReactor
*   SubReactor è´Ÿè´£ç›¸åº”é€šé“çš„ IO è¯»å†™è¯·æ±‚
*   é IO è¯·æ±‚ï¼ˆå…·ä½“é€»è¾‘å¤„ç†ï¼‰çš„ä»»åŠ¡åˆ™ä¼šç›´æ¥å†™å…¥é˜Ÿåˆ—ï¼Œç­‰å¾… worker threads è¿›è¡Œå¤„ç†

è¿™é‡Œå¼•ç”¨ Doug Lee å¤§ç¥çš„ Reactor ä»‹ç»ï¼š[Scalable IO in Java](http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf) é‡Œé¢å…³äºä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹çš„å›¾

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJkYzY5OGRkZDY?x-oss-process=image/format,png)

ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼š è™½ç„¶ Netty çš„çº¿ç¨‹æ¨¡å‹åŸºäºä¸»ä» Reactor å¤šçº¿ç¨‹ï¼Œå€Ÿç”¨äº† MainReactor å’Œ SubReactor çš„ç»“æ„ï¼Œä½†æ˜¯å®é™…å®ç°ä¸Šï¼ŒSubReactor å’Œ Worker çº¿ç¨‹åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­ï¼š

```
EventLoopGroup bossGroup = new NioEventLoopGroup();
EventLoopGroup workerGroup = new NioEventLoopGroup();
ServerBootstrap server = new ServerBootstrap();
server.group(bossGroup, workerGroup)
 .channel(NioServerSocketChannel.class)
```

ä¸Šé¢ä»£ç ä¸­çš„ bossGroup å’Œ workerGroup æ˜¯ Bootstrap æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œè¿™ä¸¤ä¸ª group å‡æ˜¯çº¿ç¨‹æ± 

*   bossGroup çº¿ç¨‹æ± åˆ™åªæ˜¯åœ¨ bind æŸä¸ªç«¯å£åï¼Œè·å¾—å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä½œä¸º MainReactorï¼Œä¸“é—¨å¤„ç†ç«¯å£çš„ accept äº‹ä»¶ï¼Œ**æ¯ä¸ªç«¯å£å¯¹åº”ä¸€ä¸ª boss çº¿ç¨‹**
*   workerGroup çº¿ç¨‹æ± ä¼šè¢«å„ä¸ª SubReactor å’Œ worker çº¿ç¨‹å……åˆ†åˆ©ç”¨

#### å¼‚æ­¥å¤„ç†

å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…ã€‚

Netty ä¸­çš„ I/O æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼ŒåŒ…æ‹¬ bindã€writeã€connect ç­‰æ“ä½œä¼šç®€å•çš„è¿”å›ä¸€ä¸ª ChannelFutureï¼Œè°ƒç”¨è€…å¹¶ä¸èƒ½ç«‹åˆ»è·å¾—ç»“æœï¼Œé€šè¿‡ Future-Listener æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾— IO æ“ä½œç»“æœã€‚

å½“ future å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶ï¼Œå¤„äºéå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„ ChannelFuture æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ï¼Œå¸¸è§æœ‰å¦‚ä¸‹æ“ä½œï¼š

*   é€šè¿‡ isDone æ–¹æ³•æ¥åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å®Œæˆ
*   é€šè¿‡ isSuccess æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸ
*   é€šè¿‡ getCause æ–¹æ³•æ¥è·å–å·²å®Œæˆçš„å½“å‰æ“ä½œå¤±è´¥çš„åŸå› 
*   é€šè¿‡ isCancelled æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆ
*   é€šè¿‡ addListener æ–¹æ³•æ¥æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆ (isDone æ–¹æ³•è¿”å›å®Œæˆ)ï¼Œå°†ä¼šé€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ï¼›å¦‚æœ future å¯¹è±¡å·²å®Œæˆï¼Œåˆ™ç†è§£é€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨

ä¾‹å¦‚ä¸‹é¢çš„çš„ä»£ç ä¸­ç»‘å®šç«¯å£æ˜¯å¼‚æ­¥æ“ä½œï¼Œå½“ç»‘å®šæ“ä½œå¤„ç†å®Œï¼Œå°†ä¼šè°ƒç”¨ç›¸åº”çš„ç›‘å¬å™¨å¤„ç†é€»è¾‘

```
serverBootstrap.bind(port).addListener(future -> {
        if (future.isSuccess()) {
            System.out.println(new Date() + ": ç«¯å£[" + port + "]ç»‘å®šæˆåŠŸ!");
        } else {
            System.err.println("ç«¯å£[" + port + "]ç»‘å®šå¤±è´¥!");
        }
    });
```

ç›¸æ¯”ä¼ ç»Ÿé˜»å¡ I/Oï¼Œæ‰§è¡Œ I/O æ“ä½œåçº¿ç¨‹ä¼šè¢«é˜»å¡ä½, ç›´åˆ°æ“ä½œå®Œæˆï¼›å¼‚æ­¥å¤„ç†çš„å¥½å¤„æ˜¯ä¸ä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œçº¿ç¨‹åœ¨ I/O æ“ä½œæœŸé—´å¯ä»¥æ‰§è¡Œåˆ«çš„ç¨‹åºï¼Œåœ¨é«˜å¹¶å‘æƒ…å½¢ä¸‹ä¼šæ›´ç¨³å®šå’Œæ›´é«˜çš„ååé‡ã€‚

Netty æ¶æ„è®¾è®¡
----------

å‰é¢ä»‹ç»å®Œ Netty ç›¸å…³ä¸€äº›ç†è®ºä»‹ç»ï¼Œä¸‹é¢ä»åŠŸèƒ½ç‰¹æ€§ã€æ¨¡å—ç»„ä»¶ã€è¿ä½œè¿‡ç¨‹æ¥ä»‹ç» Netty çš„æ¶æ„è®¾è®¡

### åŠŸèƒ½ç‰¹æ€§

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJkYzg2MTRjOGY?x-oss-process=image/format,png)

*   ä¼ è¾“æœåŠ¡ æ”¯æŒ BIO å’Œ NIO
*   å®¹å™¨é›†æˆ æ”¯æŒ OSGIã€JBossMCã€Springã€Guice å®¹å™¨
*   åè®®æ”¯æŒ HTTPã€Protobufã€äºŒè¿›åˆ¶ã€æ–‡æœ¬ã€WebSocket ç­‰ä¸€ç³»åˆ—å¸¸è§åè®®éƒ½æ”¯æŒã€‚ è¿˜æ”¯æŒé€šè¿‡å®è¡Œç¼–ç è§£ç é€»è¾‘æ¥å®ç°è‡ªå®šä¹‰åè®®
*   Core æ ¸å¿ƒ å¯æ‰©å±•äº‹ä»¶æ¨¡å‹ã€é€šç”¨é€šä¿¡ APIã€æ”¯æŒé›¶æ‹·è´çš„ ByteBuf ç¼“å†²å¯¹è±¡

### æ¨¡å—ç»„ä»¶

#### Bootstrapã€ServerBootstrap

Bootstrap æ„æ€æ˜¯å¼•å¯¼ï¼Œä¸€ä¸ª Netty åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª Bootstrap å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª Netty ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼ŒNetty ä¸­ Bootstrap ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼ŒServerBootstrap æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»ã€‚

#### Futureã€ChannelFuture

æ­£å¦‚å‰é¢ä»‹ç»ï¼Œåœ¨ Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ï¼Œä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ Future å’Œ ChannelFuturesï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ã€‚

#### Channel

Netty ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I/O æ“ä½œã€‚ Channel ä¸ºç”¨æˆ·æä¾›ï¼š

*   å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€ï¼ˆä¾‹å¦‚æ˜¯å¦æ‰“å¼€ï¼Ÿæ˜¯å¦å·²è¿æ¥ï¼Ÿï¼‰
*   ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•° ï¼ˆä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼‰
*   æä¾›å¼‚æ­¥çš„ç½‘ç»œ I/O æ“ä½œ (å¦‚å»ºç«‹è¿æ¥ï¼Œè¯»å†™ï¼Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• I / O è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ I / O æ“ä½œå·²å®Œæˆã€‚è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª ChannelFuture å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° ChannelFuture ä¸Šï¼Œå¯ä»¥ I / O æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹ã€‚
*   æ”¯æŒå…³è” I/O æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åº

ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº”ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ Channel ç±»å‹

*   NioSocketChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥
*   NioServerSocketChannelï¼Œå¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥
*   NioDatagramChannelï¼Œå¼‚æ­¥çš„ UDP è¿æ¥
*   NioSctpChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ Sctp è¿æ¥
*   NioSctpServerChannelï¼Œå¼‚æ­¥çš„ Sctp æœåŠ¡å™¨ç«¯è¿æ¥ è¿™äº›é€šé“æ¶µç›–äº† UDP å’Œ TCP ç½‘ç»œ IO ä»¥åŠæ–‡ä»¶ IO.

#### Selector

Netty åŸºäº Selector å¯¹è±¡å®ç° I/O å¤šè·¯å¤ç”¨ï¼Œé€šè¿‡ Selector, ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ Channel äº‹ä»¶, å½“å‘ä¸€ä¸ª Selector ä¸­æ³¨å†Œ Channel åï¼ŒSelector å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢ (select) è¿™äº›æ³¨å†Œçš„ Channel æ˜¯å¦æœ‰å·²å°±ç»ªçš„ I/O äº‹ä»¶ (ä¾‹å¦‚å¯è¯», å¯å†™, ç½‘ç»œè¿æ¥å®Œæˆç­‰)ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª Channelã€‚

#### NioEventLoop

NioEventLoop ä¸­ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¼‚æ­¥æäº¤æ‰§è¡Œä»»åŠ¡ï¼Œçº¿ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨ NioEventLoop çš„ run æ–¹æ³•ï¼Œæ‰§è¡Œ I/O ä»»åŠ¡å’Œé I/O ä»»åŠ¡ï¼š

*   I/O ä»»åŠ¡ å³ selectionKey ä¸­ ready çš„äº‹ä»¶ï¼Œå¦‚ acceptã€connectã€readã€write ç­‰ï¼Œç”± processSelectedKeys æ–¹æ³•è§¦å‘ã€‚
*   é IO ä»»åŠ¡ æ·»åŠ åˆ° taskQueue ä¸­çš„ä»»åŠ¡ï¼Œå¦‚ register0ã€bind0 ç­‰ä»»åŠ¡ï¼Œç”± runAllTasks æ–¹æ³•è§¦å‘ã€‚

ä¸¤ç§ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¯”ç”±å˜é‡ ioRatio æ§åˆ¶ï¼Œé»˜è®¤ä¸º 50ï¼Œåˆ™è¡¨ç¤ºå…è®¸é IO ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ä¸ IO ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ç›¸ç­‰ã€‚

#### NioEventLoopGroup

NioEventLoopGroupï¼Œä¸»è¦ç®¡ç† eventLoop çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ (NioEventLoop) è´Ÿè´£å¤„ç†å¤šä¸ª Channel ä¸Šçš„äº‹ä»¶ï¼Œè€Œä¸€ä¸ª Channel åªå¯¹åº”äºä¸€ä¸ªçº¿ç¨‹ã€‚

#### ChannelHandler

ChannelHandler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç† I / O äº‹ä»¶æˆ–æ‹¦æˆª I / O æ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ ChannelPipeline(ä¸šåŠ¡å¤„ç†é“¾) ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚

ChannelHandler æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£æœ‰è®¸å¤šçš„æ–¹æ³•éœ€è¦å®ç°ï¼Œæ–¹ä¾¿ä½¿ç”¨æœŸé—´ï¼Œå¯ä»¥ç»§æ‰¿å®ƒçš„å­ç±»ï¼š

*   ChannelInboundHandler ç”¨äºå¤„ç†å…¥ç«™ I / O äº‹ä»¶
*   ChannelOutboundHandler ç”¨äºå¤„ç†å‡ºç«™ I / O æ“ä½œ

æˆ–è€…ä½¿ç”¨ä»¥ä¸‹é€‚é…å™¨ç±»ï¼š

*   ChannelInboundHandlerAdapter ç”¨äºå¤„ç†å…¥ç«™ I / O äº‹ä»¶
*   ChannelOutboundHandlerAdapter ç”¨äºå¤„ç†å‡ºç«™ I / O æ“ä½œ
*   ChannelDuplexHandler ç”¨äºå¤„ç†å…¥ç«™å’Œå‡ºç«™äº‹ä»¶

#### ChannelHandlerContext

ä¿å­˜ Channel ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ª ChannelHandler å¯¹è±¡

#### ChannelPipline

ä¿å­˜ ChannelHandler çš„ Listï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª Channel çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œã€‚ ChannelPipeline å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ Channel ä¸­å„ä¸ªçš„ ChannelHandler å¦‚ä½•ç›¸äº’äº¤äº’ã€‚

ä¸‹å›¾å¼•ç”¨ Netty çš„ Javadoc4.1 ä¸­ ChannelPipline çš„è¯´æ˜ï¼Œæè¿°äº† ChannelPipeline ä¸­ ChannelHandler é€šå¸¸å¦‚ä½•å¤„ç† I/O äº‹ä»¶ã€‚ I/O äº‹ä»¶ç”± ChannelInboundHandler æˆ– ChannelOutboundHandler å¤„ç†ï¼Œå¹¶é€šè¿‡è°ƒç”¨ ChannelHandlerContext ä¸­å®šä¹‰çš„äº‹ä»¶ä¼ æ’­æ–¹æ³•ï¼ˆä¾‹å¦‚ ChannelHandlerContext.fireChannelReadï¼ˆObjectï¼‰å’Œ ChannelOutboundInvoker.writeï¼ˆObjectï¼‰ï¼‰è½¬å‘åˆ°å…¶æœ€è¿‘çš„å¤„ç†ç¨‹åºã€‚

```
I/O Request
                                            via Channel or
                                        ChannelHandlerContext
                                                      |
  +---------------------------------------------------+---------------+
  |                           ChannelPipeline         |               |
  |                                                  \|/              |
  |    +---------------------+            +-----------+----------+    |
  |    | Inbound Handler  N  |            | Outbound Handler  1  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  |               |                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler N-1 |            | Outbound Handler  2  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  .               |
  |               .                                   .               |
  | ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|
  |        [ method call]                       [method call]         |
  |               .                                   .               |
  |               .                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler  2  |            | Outbound Handler M-1 |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  |               |                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler  1  |            | Outbound Handler  M  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  +---------------+-----------------------------------+---------------+
                  |                                  \|/
  +---------------+-----------------------------------+---------------+
  |               |                                   |               |
  |       [ Socket.read() ]                    [ Socket.write() ]     |
  |                                                                   |
  |  Netty Internal I/O Threads (Transport Implementation)            |
  +-------------------------------------------------------------------+
```

å…¥ç«™äº‹ä»¶ç”±è‡ªä¸‹è€Œä¸Šæ–¹å‘çš„å…¥ç«™å¤„ç†ç¨‹åºå¤„ç†ï¼Œå¦‚å›¾å·¦ä¾§æ‰€ç¤ºã€‚ å…¥ç«™ Handler å¤„ç†ç¨‹åºé€šå¸¸å¤„ç†ç”±å›¾åº•éƒ¨çš„ I / O çº¿ç¨‹ç”Ÿæˆçš„å…¥ç«™æ•°æ®ã€‚ é€šå¸¸é€šè¿‡å®é™…è¾“å…¥æ“ä½œï¼ˆä¾‹å¦‚ SocketChannel.readï¼ˆByteBufferï¼‰ï¼‰ä»è¿œç¨‹è¯»å–å…¥ç«™æ•°æ®ã€‚

å‡ºç«™äº‹ä»¶ç”±ä¸Šä¸‹æ–¹å‘å¤„ç†ï¼Œå¦‚å›¾å³ä¾§æ‰€ç¤ºã€‚ å‡ºç«™ Handler å¤„ç†ç¨‹åºé€šå¸¸ä¼šç”Ÿæˆæˆ–è½¬æ¢å‡ºç«™ä¼ è¾“ï¼Œä¾‹å¦‚ write è¯·æ±‚ã€‚ I/O çº¿ç¨‹é€šå¸¸æ‰§è¡Œå®é™…çš„è¾“å‡ºæ“ä½œï¼Œä¾‹å¦‚ SocketChannel.writeï¼ˆByteBufferï¼‰ã€‚

åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”, å®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹:

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJkYzhjZDFhMmY?x-oss-process=image/format,png)

ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipeline, è€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨, å¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandlerã€‚å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handlerï¼Œå‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handlerï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ã€‚

### å·¥ä½œåŸç†æ¶æ„

åˆå§‹åŒ–å¹¶å¯åŠ¨ Netty æœåŠ¡ç«¯è¿‡ç¨‹å¦‚ä¸‹ï¼š

```
public static void main(String[] args) {
        // åˆ›å»ºmainReactor
        NioEventLoopGroup boosGroup = new NioEventLoopGroup();
        // åˆ›å»ºå·¥ä½œçº¿ç¨‹ç»„
        NioEventLoopGroup workerGroup = new NioEventLoopGroup();

        final ServerBootstrap serverBootstrap = new ServerBootstrap();
        serverBootstrap 
                 // ç»„è£…NioEventLoopGroup 
                .group(boosGroup, workerGroup)
                 // è®¾ç½®channelç±»å‹ä¸ºNIOç±»å‹
                .channel(NioServerSocketChannel.class)
                // è®¾ç½®è¿æ¥é…ç½®å‚æ•°
                .option(ChannelOption.SO_BACKLOG, 1024)
                .childOption(ChannelOption.SO_KEEPALIVE, true)
                .childOption(ChannelOption.TCP_NODELAY, true)
                // é…ç½®å…¥ç«™ã€å‡ºç«™äº‹ä»¶handler
                .childHandler(new ChannelInitializer<NioSocketChannel>() {
                    @Override
                    protected void initChannel(NioSocketChannel ch) {
                        // é…ç½®å…¥ç«™ã€å‡ºç«™äº‹ä»¶channel
                        ch.pipeline().addLast(...);
                        ch.pipeline().addLast(...);
                    }
    });

        // ç»‘å®šç«¯å£
        int port = 8080;
        serverBootstrap.bind(port).addListener(future -> {
            if (future.isSuccess()) {
                System.out.println(new Date() + ": ç«¯å£[" + port + "]ç»‘å®šæˆåŠŸ!");
            } else {
                System.err.println("ç«¯å£[" + port + "]ç»‘å®šå¤±è´¥!");
            }
        });
}
```

*   åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š
*   1 åˆå§‹åŒ–åˆ›å»º 2 ä¸ª NioEventLoopGroupï¼Œå…¶ä¸­ boosGroup ç”¨äº Accetpt è¿æ¥å»ºç«‹äº‹ä»¶å¹¶åˆ†å‘è¯·æ±‚ï¼Œ workerGroup ç”¨äºå¤„ç† I/O è¯»å†™äº‹ä»¶å’Œä¸šåŠ¡é€»è¾‘
*   2 åŸºäº ServerBootstrap(æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»)ï¼Œé…ç½® EventLoopGroupã€Channel ç±»å‹ï¼Œè¿æ¥å‚æ•°ã€é…ç½®å…¥ç«™ã€å‡ºç«™äº‹ä»¶ handler
*   3 ç»‘å®šç«¯å£ï¼Œå¼€å§‹å·¥ä½œ

ç»“åˆä¸Šé¢çš„ä»‹ç»çš„ Netty Reactor æ¨¡å‹ï¼Œä»‹ç»æœåŠ¡ç«¯ Netty çš„å·¥ä½œæ¶æ„å›¾ï¼š

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC8xMS8xLzE2NmNjYmJkYzlhN2NhYmU?x-oss-process=image/format,png)

server ç«¯åŒ…å« 1 ä¸ª Boss NioEventLoopGroup å’Œ 1 ä¸ª Worker NioEventLoopGroupï¼ŒNioEventLoopGroup ç›¸å½“äº 1 ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œè¿™ä¸ªç»„é‡ŒåŒ…å«å¤šä¸ªäº‹ä»¶å¾ªç¯ NioEventLoopï¼Œæ¯ä¸ª NioEventLoop åŒ…å« 1 ä¸ª selector å’Œ 1 ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ã€‚

æ¯ä¸ª Boss NioEventLoop å¾ªç¯æ‰§è¡Œçš„ä»»åŠ¡åŒ…å« 3 æ­¥ï¼š

*   1 è½®è¯¢ accept äº‹ä»¶
*   2 å¤„ç† accept I/O äº‹ä»¶ï¼Œä¸ Client å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ NioSocketChannelï¼Œå¹¶å°† NioSocketChannel æ³¨å†Œåˆ°æŸä¸ª Worker NioEventLoop çš„ Selector ä¸Š *3 å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ŒrunAllTasksã€‚ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åŒ…æ‹¬ç”¨æˆ·è°ƒç”¨ eventloop.execute æˆ– schedule æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ–è€…å…¶å®ƒçº¿ç¨‹æäº¤åˆ°è¯¥ eventloop çš„ä»»åŠ¡ã€‚

æ¯ä¸ª Worker NioEventLoop å¾ªç¯æ‰§è¡Œçš„ä»»åŠ¡åŒ…å« 3 æ­¥ï¼š

*   1 è½®è¯¢ readã€write äº‹ä»¶ï¼›
*   2 å¤„ I/O äº‹ä»¶ï¼Œå³ readã€write äº‹ä»¶ï¼Œåœ¨ NioSocketChannel å¯è¯»ã€å¯å†™äº‹ä»¶å‘ç”Ÿæ—¶è¿›è¡Œå¤„ç†
*   3 å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ŒrunAllTasksã€‚

å…¶ä¸­ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ task æœ‰ 3 ç§å…¸å‹ä½¿ç”¨åœºæ™¯

*   1 ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡

```
ctx.channel().eventLoop().execute(new Runnable() {
    @Override
    public void run() {
        //...
    }
});
```

*   2 éå½“å‰ reactor çº¿ç¨‹è°ƒç”¨ channel çš„å„ç§æ–¹æ³• ä¾‹å¦‚åœ¨æ¨é€ç³»ç»Ÿçš„ä¸šåŠ¡çº¿ç¨‹é‡Œé¢ï¼Œæ ¹æ®ç”¨æˆ·çš„æ ‡è¯†ï¼Œæ‰¾åˆ°å¯¹åº”çš„ channel å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ write ç±»æ–¹æ³•å‘è¯¥ç”¨æˆ·æ¨é€æ¶ˆæ¯ï¼Œå°±ä¼šè¿›å…¥åˆ°è¿™ç§åœºæ™¯ã€‚æœ€ç»ˆçš„ write ä¼šæäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­åè¢«å¼‚æ­¥æ¶ˆè´¹ã€‚
*   3 ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡

```
ctx.channel().eventLoop().schedule(new Runnable() {
    @Override
    public void run() {

    }
}, 60, TimeUnit.SECONDS);
```

æ€»ç»“
--

ç°åœ¨ç¨³å®šæ¨èä½¿ç”¨çš„ä¸»æµç‰ˆæœ¬è¿˜æ˜¯ Netty4ï¼ŒNetty5 ä¸­ä½¿ç”¨äº† ForkJoinPoolï¼Œå¢åŠ äº†ä»£ç çš„å¤æ‚åº¦ï¼Œä½†æ˜¯å¯¹æ€§èƒ½çš„æ”¹å–„å´ä¸æ˜æ˜¾ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬ä¸æ¨èä½¿ç”¨ï¼Œå®˜ç½‘ä¹Ÿæ²¡æœ‰æä¾›ä¸‹è½½é“¾æ¥ã€‚

Netty å…¥é—¨é—¨æ§›ç›¸å¯¹è¾ƒé«˜ï¼Œå…¶å®æ˜¯å› ä¸ºè¿™æ–¹é¢çš„èµ„æ–™è¾ƒå°‘ï¼Œå¹¶ä¸æ˜¯å› ä¸ºä»–æœ‰å¤šéš¾ï¼Œå¤§å®¶å…¶å®éƒ½å¯ä»¥åƒæé€ Spring ä¸€æ ·æé€ Nettyã€‚åœ¨å­¦ä¹ ä¹‹å‰ï¼Œå»ºè®®å…ˆç†è§£é€æ•´ä¸ªæ¡†æ¶åŸç†ç»“æ„ï¼Œè¿è¡Œè¿‡ç¨‹ï¼Œå¯ä»¥å°‘èµ°å¾ˆå¤šå¼¯è·¯ã€‚