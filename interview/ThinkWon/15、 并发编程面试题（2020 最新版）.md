> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [thinkwon.blog.csdn.net](https://thinkwon.blog.csdn.net/article/details/104863992)

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ CSDN çš„åšä¸» ThinkWonï¼Œâ€œ2020 åšå®¢ä¹‹æ˜Ÿå¹´åº¦æ€»è¯„é€‰ " å¼€å§‹å•¦ï¼Œå¸Œæœ›å¤§å®¶å¸®æˆ‘æŠ•ç¥¨ï¼Œæ¯å¤©éƒ½å¯ä»¥æŠ•å¤šç¥¨å“¦ï¼Œç‚¹å‡»ä¸‹æ–¹é“¾æ¥ï¼Œç„¶åç‚¹å‡» " æœ€å¤§â€ï¼Œå†ç‚¹å‡» " æŠ• TA ä¸€ç¥¨ " å°±å¯ä»¥å•¦ï¼  
> æŠ•ç¥¨é“¾æ¥ï¼š[ï¼ŒThinkWon å°†ä¸€è·¯ä¸ä½ ç›¸ä¼´ï¼åˆ›ä½œå‡ºæ›´å¤šæ›´é«˜è´¨é‡çš„æ–‡ç« ï¼2020 ä¸ºåŠªåŠ›å¥‹æ–—çš„ä½ ç‚¹èµğŸ‘ï¼Œï¸æ–°çš„ä¸€å¹´ï¼Œç¥å„ä½å¤§ç‰›ç‰›æ°”å†²å¤©ï¼Œç‰›å¹´å¤§å‰ï¼ğŸ˜ŠğŸ˜Š](https://bss.csdn.net/m/topic/blog_star2020/detail?user>https://bss.csdn.net/m/topic/blog_star2020/detail?username=thinkwon</a><br> åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œ<h-char unicode=)
> 
> [](https://bss.csdn.net/m/topic/blog_star2020/detail?user>https://bss.csdn.net/m/topic/blog_star2020/detail?username=thinkwon</a><br> åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œ<h-char unicode=)

[Java é¢è¯•æ€»ç»“æ±‡æ€»ï¼Œæ•´ç†äº†åŒ…æ‹¬ Java åŸºç¡€çŸ¥è¯†ï¼Œé›†åˆå®¹å™¨ï¼Œå¹¶å‘ç¼–ç¨‹ï¼ŒJVMï¼Œå¸¸ç”¨å¼€æºæ¡†æ¶ Springï¼ŒMyBatisï¼Œæ•°æ®åº“ï¼Œä¸­é—´ä»¶ç­‰ï¼ŒåŒ…å«äº†ä½œä¸ºä¸€ä¸ª Java å·¥ç¨‹å¸ˆåœ¨é¢è¯•ä¸­éœ€è¦ç”¨åˆ°æˆ–è€…å¯èƒ½ç”¨åˆ°çš„ç»å¤§éƒ¨åˆ†çŸ¥è¯†ã€‚æ¬¢è¿å¤§å®¶é˜…è¯»ï¼Œæœ¬äººè§è¯†æœ‰é™ï¼Œå†™çš„åšå®¢éš¾å…æœ‰é”™è¯¯æˆ–è€…ç–å¿½çš„åœ°æ–¹ï¼Œè¿˜æœ›å„ä½å¤§ä½¬æŒ‡ç‚¹ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿæ¿€ä¸å°½ã€‚æ–‡ç« æŒç»­æ›´æ–°ä¸­â€¦](https://bss.csdn.net/m/topic/blog_star2020/detail?user>https://bss.csdn.net/m/topic/blog_star2020/detail?username=thinkwon</a><br> åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œ<h-char unicode=)

åŸºç¡€çŸ¥è¯†
----

### å¹¶å‘ç¼–ç¨‹çš„ä¼˜ç¼ºç‚¹

#### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¹¶å‘ç¼–ç¨‹ï¼ˆå¹¶å‘ç¼–ç¨‹çš„ä¼˜ç‚¹ï¼‰

*   å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„è®¡ç®—èƒ½åŠ›ï¼šé€šè¿‡å¹¶å‘ç¼–ç¨‹çš„å½¢å¼å¯ä»¥å°†å¤šæ ¸ CPU çš„è®¡ç®—èƒ½åŠ›å‘æŒ¥åˆ°æè‡´ï¼Œæ€§èƒ½å¾—åˆ°æå‡
    
*   æ–¹ä¾¿è¿›è¡Œä¸šåŠ¡æ‹†åˆ†ï¼Œæå‡ç³»ç»Ÿå¹¶å‘èƒ½åŠ›å’Œæ€§èƒ½ï¼šåœ¨ç‰¹æ®Šçš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå…ˆå¤©çš„å°±é€‚åˆäºå¹¶å‘ç¼–ç¨‹ã€‚ç°åœ¨çš„ç³»ç»ŸåŠ¨ä¸åŠ¨å°±è¦æ±‚ç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§çš„å¹¶å‘é‡ï¼Œè€Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æ­£æ˜¯å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿçš„åŸºç¡€ï¼Œåˆ©ç”¨å¥½å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘èƒ½åŠ›ä»¥åŠæ€§èƒ½ã€‚é¢å¯¹å¤æ‚ä¸šåŠ¡æ¨¡å‹ï¼Œå¹¶è¡Œç¨‹åºä¼šæ¯”ä¸²è¡Œç¨‹åºæ›´é€‚åº”ä¸šåŠ¡éœ€æ±‚ï¼Œè€Œå¹¶å‘ç¼–ç¨‹æ›´èƒ½å»åˆè¿™ç§ä¸šåŠ¡æ‹†åˆ†ã€‚
    

#### å¹¶å‘ç¼–ç¨‹æœ‰ä»€ä¹ˆç¼ºç‚¹

å¹¶å‘ç¼–ç¨‹çš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œæé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯å¹¶å‘ç¼–ç¨‹å¹¶ä¸æ€»æ˜¯èƒ½æé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦çš„ï¼Œè€Œä¸”å¹¶å‘ç¼–ç¨‹å¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ **ï¼šå†…å­˜æ³„æ¼ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€çº¿ç¨‹å®‰å…¨ã€æ­»é” ** ç­‰é—®é¢˜ã€‚

#### å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ Java ç¨‹åºä¸­æ€ä¹ˆä¿è¯å¤šçº¿ç¨‹çš„è¿è¡Œå®‰å…¨ï¼Ÿ

å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ï¼ˆçº¿ç¨‹çš„å®‰å…¨æ€§é—®é¢˜ä½“ç°åœ¨ï¼‰ï¼š

åŸå­æ€§ï¼šåŸå­ï¼Œå³ä¸€ä¸ªä¸å¯å†è¢«åˆ†å‰²çš„é¢—ç²’ã€‚åŸå­æ€§æŒ‡çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ã€‚

å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹, å¦ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ã€‚ï¼ˆsynchronized,volatileï¼‰

æœ‰åºæ€§ï¼šç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ï¼ˆå¤„ç†å™¨å¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼‰

å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„åŸå› ï¼š

*   çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„åŸå­æ€§é—®é¢˜
    
*   ç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜
    
*   ç¼–è¯‘ä¼˜åŒ–å¸¦æ¥çš„æœ‰åºæ€§é—®é¢˜
    

è§£å†³åŠæ³•ï¼š

*   JDK Atomic å¼€å¤´çš„åŸå­ç±»ã€synchronizedã€LOCKï¼Œå¯ä»¥è§£å†³åŸå­æ€§é—®é¢˜
*   synchronizedã€volatileã€LOCKï¼Œå¯ä»¥è§£å†³å¯è§æ€§é—®é¢˜
*   Happens-Before è§„åˆ™å¯ä»¥è§£å†³æœ‰åºæ€§é—®é¢˜

#### å¹¶è¡Œå’Œå¹¶å‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

*   å¹¶å‘ï¼šå¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ª CPU æ ¸ä¸Šï¼ŒæŒ‰ç»†åˆ†çš„æ—¶é—´ç‰‡è½®æµ (äº¤æ›¿) æ‰§è¡Œï¼Œä»é€»è¾‘ä¸Šæ¥çœ‹é‚£äº›ä»»åŠ¡æ˜¯åŒæ—¶æ‰§è¡Œã€‚
*   å¹¶è¡Œï¼šå•ä½æ—¶é—´å†…ï¼Œå¤šä¸ªå¤„ç†å™¨æˆ–å¤šæ ¸å¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ â€œåŒæ—¶è¿›è¡Œâ€ã€‚
*   ä¸²è¡Œï¼šæœ‰ n ä¸ªä»»åŠ¡ï¼Œç”±ä¸€ä¸ªçº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œã€‚ç”±äºä»»åŠ¡ã€æ–¹æ³•éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ‰€ä»¥ä¸å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨æƒ…å†µï¼Œä¹Ÿå°±ä¸å­˜åœ¨ä¸´ç•ŒåŒºçš„é—®é¢˜ã€‚

åšä¸€ä¸ªå½¢è±¡çš„æ¯”å–»ï¼š

å¹¶å‘ = ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸€å°å’–å•¡æœºã€‚

å¹¶è¡Œ = ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸¤å°å’–å•¡æœºã€‚

ä¸²è¡Œ = ä¸€ä¸ªé˜Ÿåˆ—å’Œä¸€å°å’–å•¡æœºã€‚

#### ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹çš„ä¼˜åŠ£ï¼Ÿ

å¤šçº¿ç¨‹ï¼šå¤šçº¿ç¨‹æ˜¯æŒ‡ç¨‹åºä¸­åŒ…å«å¤šä¸ªæ‰§è¡Œæµï¼Œå³åœ¨ä¸€ä¸ªç¨‹åºä¸­å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªä¸åŒçš„çº¿ç¨‹æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚

å¤šçº¿ç¨‹çš„å¥½å¤„ï¼š

å¯ä»¥æé«˜ CPU çš„åˆ©ç”¨ç‡ã€‚åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¿…é¡»ç­‰å¾…çš„æ—¶å€™ï¼ŒCPU å¯ä»¥è¿è¡Œå…¶å®ƒçš„çº¿ç¨‹è€Œä¸æ˜¯ç­‰å¾…ï¼Œè¿™æ ·å°±å¤§å¤§æé«˜äº†ç¨‹åºçš„æ•ˆç‡ã€‚ä¹Ÿå°±æ˜¯è¯´å…è®¸å•ä¸ªç¨‹åºåˆ›å»ºå¤šä¸ªå¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹æ¥å®Œæˆå„è‡ªçš„ä»»åŠ¡ã€‚

å¤šçº¿ç¨‹çš„åŠ£åŠ¿ï¼š

*   çº¿ç¨‹ä¹Ÿæ˜¯ç¨‹åºï¼Œæ‰€ä»¥çº¿ç¨‹éœ€è¦å ç”¨å†…å­˜ï¼Œçº¿ç¨‹è¶Šå¤šå ç”¨å†…å­˜ä¹Ÿè¶Šå¤šï¼›
    
*   å¤šçº¿ç¨‹éœ€è¦åè°ƒå’Œç®¡ç†ï¼Œæ‰€ä»¥éœ€è¦ CPU æ—¶é—´è·Ÿè¸ªçº¿ç¨‹ï¼›
    
*   çº¿ç¨‹ä¹‹é—´å¯¹å…±äº«èµ„æºçš„è®¿é—®ä¼šç›¸äº’å½±å“ï¼Œå¿…é¡»è§£å†³ç«ç”¨å…±äº«èµ„æºçš„é—®é¢˜ã€‚
    

### çº¿ç¨‹å’Œè¿›ç¨‹åŒºåˆ«

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹å’Œè¿›ç¨‹?

è¿›ç¨‹

ä¸€ä¸ªåœ¨å†…å­˜ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨ Windows ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿è¡Œçš„ xx.exe å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚

çº¿ç¨‹

è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡ï¼ˆæ§åˆ¶å•å…ƒï¼‰ï¼Œè´Ÿè´£å½“å‰è¿›ç¨‹ä¸­ç¨‹åºçš„æ‰§è¡Œã€‚ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯å…±äº«æ•°æ®ã€‚

#### è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«

çº¿ç¨‹å…·æœ‰è®¸å¤šä¼ ç»Ÿè¿›ç¨‹æ‰€å…·æœ‰çš„ç‰¹å¾ï¼Œæ•…åˆç§°ä¸ºè½»å‹è¿›ç¨‹ (Lightâ€”Weight Process) æˆ–è¿›ç¨‹å…ƒï¼›è€ŒæŠŠä¼ ç»Ÿçš„è¿›ç¨‹ç§°ä¸ºé‡å‹è¿›ç¨‹ (Heavyâ€”Weight Process)ï¼Œå®ƒç›¸å½“äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„ä»»åŠ¡ã€‚åœ¨å¼•å…¥äº†çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè‡³å°‘åŒ…å«ä¸€ä¸ªçº¿ç¨‹ã€‚

**æ ¹æœ¬åŒºåˆ«**ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯å¤„ç†å™¨ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½

**èµ„æºå¼€é”€**ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´ï¼ˆç¨‹åºä¸Šä¸‹æ–‡ï¼‰ï¼Œç¨‹åºä¹‹é—´çš„åˆ‡æ¢ä¼šæœ‰è¾ƒå¤§çš„å¼€é”€ï¼›çº¿ç¨‹å¯ä»¥çœ‹åšè½»é‡çº§çš„è¿›ç¨‹ï¼ŒåŒä¸€ç±»çº¿ç¨‹å…±äº«ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢çš„å¼€é”€å°ã€‚

**åŒ…å«å…³ç³»**ï¼šå¦‚æœä¸€ä¸ªè¿›ç¨‹å†…æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œè¿‡ç¨‹ä¸æ˜¯ä¸€æ¡çº¿çš„ï¼Œè€Œæ˜¯å¤šæ¡çº¿ï¼ˆçº¿ç¨‹ï¼‰å…±åŒå®Œæˆçš„ï¼›çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»æƒè¿›ç¨‹æˆ–è€…è½»é‡çº§è¿›ç¨‹ã€‚

**å†…å­˜åˆ†é…**ï¼šåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œèµ„æºï¼Œè€Œè¿›ç¨‹ä¹‹é—´çš„åœ°å€ç©ºé—´å’Œèµ„æºæ˜¯ç›¸äº’ç‹¬ç«‹çš„

**å½±å“å…³ç³»**ï¼šä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶ä»–è¿›ç¨‹äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ•´ä¸ªè¿›ç¨‹éƒ½æ­»æ‰ã€‚æ‰€ä»¥å¤šè¿›ç¨‹è¦æ¯”å¤šçº¿ç¨‹å¥å£®ã€‚

**æ‰§è¡Œè¿‡ç¨‹**ï¼šæ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æœ‰ç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºå‡ºå£ã€‚ä½†æ˜¯çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ï¼Œä¸¤è€…å‡å¯å¹¶å‘æ‰§è¡Œ

#### ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢?

å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚

ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚

Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

#### å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹

*   **ç”¨æˆ· (User) çº¿ç¨‹**ï¼šè¿è¡Œåœ¨å‰å°ï¼Œæ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ï¼Œå¦‚ç¨‹åºçš„ä¸»çº¿ç¨‹ã€è¿æ¥ç½‘ç»œçš„å­çº¿ç¨‹ç­‰éƒ½æ˜¯ç”¨æˆ·çº¿ç¨‹
*   **å®ˆæŠ¤ (Daemon) çº¿ç¨‹**ï¼šè¿è¡Œåœ¨åå°ï¼Œä¸ºå…¶ä»–å‰å°çº¿ç¨‹æœåŠ¡ã€‚ä¹Ÿå¯ä»¥è¯´å®ˆæŠ¤çº¿ç¨‹æ˜¯ JVM ä¸­éå®ˆæŠ¤çº¿ç¨‹çš„ **â€œä½£äººâ€**ã€‚ä¸€æ—¦æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½ç»“æŸè¿è¡Œï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šéš JVM ä¸€èµ·ç»“æŸå·¥ä½œ

main å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å•Šï¼Œmain å‡½æ•°å¯åŠ¨çš„åŒæ—¶åœ¨ JVM å†…éƒ¨åŒæ—¶è¿˜å¯åŠ¨äº†å¥½å¤šå®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ã€‚

æ¯”è¾ƒæ˜æ˜¾çš„åŒºåˆ«ä¹‹ä¸€æ˜¯ç”¨æˆ·çº¿ç¨‹ç»“æŸï¼ŒJVM é€€å‡ºï¼Œä¸ç®¡è¿™ä¸ªæ—¶å€™æœ‰æ²¡æœ‰å®ˆæŠ¤çº¿ç¨‹è¿è¡Œã€‚è€Œå®ˆæŠ¤çº¿ç¨‹ä¸ä¼šå½±å“ JVM çš„é€€å‡ºã€‚

**æ³¨æ„äº‹é¡¹ï¼š**

1.  `setDaemon(true)` å¿…é¡»åœ¨ `start()` æ–¹æ³•å‰æ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ›å‡º `IllegalThreadStateException` å¼‚å¸¸
2.  åœ¨å®ˆæŠ¤çº¿ç¨‹ä¸­äº§ç”Ÿçš„æ–°çº¿ç¨‹ä¹Ÿæ˜¯å®ˆæŠ¤çº¿ç¨‹
3.  ä¸æ˜¯æ‰€æœ‰çš„ä»»åŠ¡éƒ½å¯ä»¥åˆ†é…ç»™å®ˆæŠ¤çº¿ç¨‹æ¥æ‰§è¡Œï¼Œæ¯”å¦‚è¯»å†™æ“ä½œæˆ–è€…è®¡ç®—é€»è¾‘
4.  å®ˆæŠ¤ (Daemon) çº¿ç¨‹ä¸­ä¸èƒ½ä¾é  finally å—çš„å†…å®¹æ¥ç¡®ä¿æ‰§è¡Œå…³é—­æˆ–æ¸…ç†èµ„æºçš„é€»è¾‘ã€‚å› ä¸ºæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´è¿‡äº†ä¸€æ—¦æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½ç»“æŸè¿è¡Œï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šéš JVM ä¸€èµ·ç»“æŸå·¥ä½œï¼Œæ‰€ä»¥å®ˆæŠ¤ (Daemon) çº¿ç¨‹ä¸­çš„ finally è¯­å¥å—å¯èƒ½æ— æ³•è¢«æ‰§è¡Œã€‚

#### å¦‚ä½•åœ¨ Windows å’Œ Linux ä¸ŠæŸ¥æ‰¾å“ªä¸ªçº¿ç¨‹ cpu åˆ©ç”¨ç‡æœ€é«˜ï¼Ÿ

windows ä¸Šé¢ç”¨ä»»åŠ¡ç®¡ç†å™¨çœ‹ï¼Œlinux ä¸‹å¯ä»¥ç”¨ top è¿™ä¸ªå·¥å…·çœ‹ã€‚

1.  æ‰¾å‡º cpu è€—ç”¨å‰å®³çš„è¿›ç¨‹ pidï¼Œ ç»ˆç«¯æ‰§è¡Œ top å‘½ä»¤ï¼Œç„¶åæŒ‰ä¸‹ shift+p æŸ¥æ‰¾å‡º cpu åˆ©ç”¨æœ€å‰å®³çš„ pid å·
2.  æ ¹æ®ä¸Šé¢ç¬¬ä¸€æ­¥æ‹¿åˆ°çš„ pid å·ï¼Œtop -H -p pidã€‚ç„¶åæŒ‰ä¸‹ shift+pï¼ŒæŸ¥æ‰¾å‡º cpu åˆ©ç”¨ç‡æœ€å‰å®³çš„çº¿ç¨‹å·ï¼Œæ¯”å¦‚ top -H -p 1328
3.  å°†è·å–åˆ°çš„çº¿ç¨‹å·è½¬æ¢æˆ 16 è¿›åˆ¶ï¼Œå»ç™¾åº¦è½¬æ¢ä¸€ä¸‹å°±è¡Œ
4.  ä½¿ç”¨ jstack å·¥å…·å°†è¿›ç¨‹ä¿¡æ¯æ‰“å°è¾“å‡ºï¼Œjstack pid å· > /tmp/t.datï¼Œæ¯”å¦‚ jstack 31365 > /tmp/t.dat
5.  ç¼–è¾‘ / tmp/t.dat æ–‡ä»¶ï¼ŒæŸ¥æ‰¾çº¿ç¨‹å·å¯¹åº”çš„ä¿¡æ¯

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”

`ç™¾åº¦ç™¾ç§‘`ï¼šæ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œè¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ç§°ä¸ºæ­»é”è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ã€‚

å¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A æŒæœ‰èµ„æº 2ï¼Œçº¿ç¨‹ B æŒæœ‰èµ„æº 1ï¼Œä»–ä»¬åŒæ—¶éƒ½æƒ³ç”³è¯·å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šäº’ç›¸ç­‰å¾…è€Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0pvdXJXb24vaW1hZ2UvbWFzdGVyL0phdmElRTUlQjklQjYlRTUlOEYlOTElRTclQkMlOTYlRTclQTglOEItJUU1JTlGJUJBJUU3JUExJTgwJUU3JTlGJUE1JUU4JUFGJTg2LyVFNyVCQSVCRiVFNyVBOCU4QiVFNiVBRCVCQiVFOSU5NCU4MS5wbmc)

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜çº¿ç¨‹æ­»é”ï¼Œä»£ç æ¨¡æ‹Ÿäº†ä¸Šå›¾çš„æ­»é”çš„æƒ…å†µ (ä»£ç æ¥æºäºã€Šå¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹)ï¼š

```
public class DeadLockDemo {
    private static Object resource1 = new Object();//èµ„æº 1
    private static Object resource2 = new Object();//èµ„æº 2

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread() + "get resource2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource1");
                synchronized (resource1) {
                    System.out.println(Thread.currentThread() + "get resource1");
                }
            }
        }, "çº¿ç¨‹ 2").start();
    }
}
```

è¾“å‡ºç»“æœ

```
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]get resource2
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]waiting get resource1
```

çº¿ç¨‹ A é€šè¿‡ synchronized (resource1) è·å¾— resource1 çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡ `Thread.sleep(1000)`ï¼›è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ° CPU æ‰§è¡Œæƒï¼Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”ã€‚ä¸Šé¢çš„ä¾‹å­ç¬¦åˆäº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ã€‚

#### å½¢æˆæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶æ˜¯ä»€ä¹ˆ

1.  äº’æ–¥æ¡ä»¶ï¼šçº¿ç¨‹ (è¿›ç¨‹) å¯¹äºæ‰€åˆ†é…åˆ°çš„èµ„æºå…·æœ‰æ’å®ƒæ€§ï¼Œå³ä¸€ä¸ªèµ„æºåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ (è¿›ç¨‹) å ç”¨ï¼Œç›´åˆ°è¢«è¯¥çº¿ç¨‹ (è¿›ç¨‹) é‡Šæ”¾
2.  è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªçº¿ç¨‹ (è¿›ç¨‹) å› è¯·æ±‚è¢«å ç”¨èµ„æºè€Œå‘ç”Ÿé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
3.  ä¸å‰¥å¤ºæ¡ä»¶ï¼šçº¿ç¨‹ (è¿›ç¨‹) å·²è·å¾—çš„èµ„æºåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªæœ‰è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰é‡Šæ”¾èµ„æºã€‚
4.  å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå½“å‘ç”Ÿæ­»é”æ—¶ï¼Œæ‰€ç­‰å¾…çš„çº¿ç¨‹ (è¿›ç¨‹) å¿…å®šä¼šå½¢æˆä¸€ä¸ªç¯è·¯ï¼ˆç±»ä¼¼äºæ­»å¾ªç¯ï¼‰ï¼Œé€ æˆæ°¸ä¹…é˜»å¡

#### å¦‚ä½•é¿å…çº¿ç¨‹æ­»é”

æˆ‘ä»¬åªè¦ç ´åäº§ç”Ÿæ­»é”çš„å››ä¸ªæ¡ä»¶ä¸­çš„å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚

**ç ´åäº’æ–¥æ¡ä»¶**

è¿™ä¸ªæ¡ä»¶æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç ´åï¼Œå› ä¸ºæˆ‘ä»¬ç”¨é”æœ¬æ¥å°±æ˜¯æƒ³è®©ä»–ä»¬äº’æ–¥çš„ï¼ˆä¸´ç•Œèµ„æºéœ€è¦äº’æ–¥è®¿é—®ï¼‰ã€‚

**ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶**

ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰çš„èµ„æºã€‚

**ç ´åä¸å‰¥å¤ºæ¡ä»¶**

å ç”¨éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºæ—¶ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å®ƒå æœ‰çš„èµ„æºã€‚

**ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶**

é æŒ‰åºç”³è¯·èµ„æºæ¥é¢„é˜²ã€‚æŒ‰æŸä¸€é¡ºåºç”³è¯·èµ„æºï¼Œé‡Šæ”¾èµ„æºåˆ™ååºé‡Šæ”¾ã€‚ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚

æˆ‘ä»¬å¯¹çº¿ç¨‹ 2 çš„ä»£ç ä¿®æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šäº§ç”Ÿæ­»é”äº†ã€‚

```
new Thread(() -> {
    synchronized (resource1) {
        System.out.println(Thread.currentThread() + "get resource1");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread() + "waiting get resource2");
        synchronized (resource2) {
            System.out.println(Thread.currentThread() + "get resource2");
        }
    }
}, "çº¿ç¨‹ 2").start();
```

è¾“å‡ºç»“æœ

```
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 1,5,main]get resource2
Thread[çº¿ç¨‹ 2,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]get resource2
```

æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ä¸ºä»€ä¹ˆé¿å…äº†æ­»é”çš„å‘ç”Ÿ?

çº¿ç¨‹ 1 é¦–å…ˆè·å¾—åˆ° resource1 çš„ç›‘è§†å™¨é”ï¼Œè¿™æ—¶å€™çº¿ç¨‹ 2 å°±è·å–ä¸åˆ°äº†ã€‚ç„¶åçº¿ç¨‹ 1 å†å»è·å– resource2 çš„ç›‘è§†å™¨é”ï¼Œå¯ä»¥è·å–åˆ°ã€‚ç„¶åçº¿ç¨‹ 1 é‡Šæ”¾äº†å¯¹ resource1ã€resource2 çš„ç›‘è§†å™¨é”çš„å ç”¨ï¼Œçº¿ç¨‹ 2 è·å–åˆ°å°±å¯ä»¥æ‰§è¡Œäº†ã€‚è¿™æ ·å°±ç ´åäº†ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå› æ­¤é¿å…äº†æ­»é”ã€‚

### åˆ›å»ºçº¿ç¨‹çš„å››ç§æ–¹å¼

#### åˆ›å»ºçº¿ç¨‹æœ‰å“ªå‡ ç§æ–¹å¼ï¼Ÿ

åˆ›å»ºçº¿ç¨‹æœ‰å››ç§æ–¹å¼ï¼š

*   ç»§æ‰¿ Thread ç±»ï¼›
*   å®ç° Runnable æ¥å£ï¼›
*   å®ç° Callable æ¥å£ï¼›
*   ä½¿ç”¨ Executors å·¥å…·ç±»åˆ›å»ºçº¿ç¨‹æ± 

**ç»§æ‰¿ Thread ç±»**

æ­¥éª¤

1.  å®šä¹‰ä¸€ä¸ª Thread ç±»çš„å­ç±»ï¼Œé‡å†™ run æ–¹æ³•ï¼Œå°†ç›¸å…³é€»è¾‘å®ç°ï¼Œrun() æ–¹æ³•å°±æ˜¯çº¿ç¨‹è¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•
2.  åˆ›å»ºè‡ªå®šä¹‰çš„çº¿ç¨‹å­ç±»å¯¹è±¡
3.  è°ƒç”¨å­ç±»å®ä¾‹çš„ star() æ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹

```
public class MyThread extends Thread {

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " run()æ–¹æ³•æ­£åœ¨æ‰§è¡Œ...");
    }

}
```

```
public class TheadTest {

    public static void main(String[] args) {
        MyThread myThread = new MyThread(); 	
        myThread.start();
        System.out.println(Thread.currentThread().getName() + " main()æ–¹æ³•æ‰§è¡Œç»“æŸ");
    }

}
```

è¿è¡Œç»“æœ

```
main main()æ–¹æ³•æ‰§è¡Œç»“æŸ
Thread-0 run()æ–¹æ³•æ­£åœ¨æ‰§è¡Œ...
```

**å®ç° Runnable æ¥å£**

æ­¥éª¤

1.  å®šä¹‰ Runnable æ¥å£å®ç°ç±» MyRunnableï¼Œå¹¶é‡å†™ run() æ–¹æ³•
2.  åˆ›å»º MyRunnable å®ä¾‹ myRunnableï¼Œä»¥ myRunnable ä½œä¸º target åˆ›å»º Thead å¯¹è±¡ï¼Œ**è¯¥ Thread å¯¹è±¡æ‰æ˜¯çœŸæ­£çš„çº¿ç¨‹å¯¹è±¡**
3.  è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start() æ–¹æ³•

```
public class MyRunnable implements Runnable {

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " run()æ–¹æ³•æ‰§è¡Œä¸­...");
    }

}
```

```
public class RunnableTest {

    public static void main(String[] args) {
        MyRunnable myRunnable = new MyRunnable();
        Thread thread = new Thread(myRunnable);
        thread.start();
        System.out.println(Thread.currentThread().getName() + " main()æ–¹æ³•æ‰§è¡Œå®Œæˆ");
    }

}
```

æ‰§è¡Œç»“æœ

```
main main()æ–¹æ³•æ‰§è¡Œå®Œæˆ
Thread-0 run()æ–¹æ³•æ‰§è¡Œä¸­...
```

**å®ç° Callable æ¥å£**

æ­¥éª¤

1.  åˆ›å»ºå®ç° Callable æ¥å£çš„ç±» myCallable
2.  ä»¥ myCallable ä¸ºå‚æ•°åˆ›å»º FutureTask å¯¹è±¡
3.  å°† FutureTask ä½œä¸ºå‚æ•°åˆ›å»º Thread å¯¹è±¡
4.  è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start() æ–¹æ³•

```
public class MyCallable implements Callable<Integer> {

    @Override
    public Integer call() {
        System.out.println(Thread.currentThread().getName() + " call()æ–¹æ³•æ‰§è¡Œä¸­...");
        return 1;
    }

}
```

```
public class CallableTest {

    public static void main(String[] args) {
        FutureTask<Integer> futureTask = new FutureTask<Integer>(new MyCallable());
        Thread thread = new Thread(futureTask);
        thread.start();

        try {
            Thread.sleep(1000);
            System.out.println("è¿”å›ç»“æœ " + futureTask.get());
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + " main()æ–¹æ³•æ‰§è¡Œå®Œæˆ");
    }

}
```

æ‰§è¡Œç»“æœ

```
Thread-0 call()æ–¹æ³•æ‰§è¡Œä¸­...
è¿”å›ç»“æœ 1
main main()æ–¹æ³•æ‰§è¡Œå®Œæˆ
```

**ä½¿ç”¨ Executors å·¥å…·ç±»åˆ›å»ºçº¿ç¨‹æ± **

Executors æä¾›äº†ä¸€ç³»åˆ—å·¥å‚æ–¹æ³•ç”¨äºåˆ›å…ˆçº¿ç¨‹æ± ï¼Œè¿”å›çš„çº¿ç¨‹æ± éƒ½å®ç°äº† ExecutorService æ¥å£ã€‚

ä¸»è¦æœ‰ newFixedThreadPoolï¼ŒnewCachedThreadPoolï¼ŒnewSingleThreadExecutorï¼ŒnewScheduledThreadPoolï¼Œåç»­è¯¦ç»†ä»‹ç»è¿™å››ç§çº¿ç¨‹æ± 

```
public class MyRunnable implements Runnable {

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " run()æ–¹æ³•æ‰§è¡Œä¸­...");
    }

}
```

```
public class SingleThreadExecutorTest {

    public static void main(String[] args) {
        ExecutorService executorService = Executors.newSingleThreadExecutor();
        MyRunnable runnableTest = new MyRunnable();
        for (int i = 0; i < 5; i++) {
            executorService.execute(runnableTest);
        }

        System.out.println("çº¿ç¨‹ä»»åŠ¡å¼€å§‹æ‰§è¡Œ");
        executorService.shutdown();
    }

}
```

æ‰§è¡Œç»“æœ

```
çº¿ç¨‹ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
pool-1-thread-1 is running...
pool-1-thread-1 is running...
pool-1-thread-1 is running...
pool-1-thread-1 is running...
pool-1-thread-1 is running...
```

#### è¯´ä¸€ä¸‹ runnable å’Œ callable æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ç›¸åŒç‚¹

*   éƒ½æ˜¯æ¥å£
    
*   éƒ½å¯ä»¥ç¼–å†™å¤šçº¿ç¨‹ç¨‹åº
    
*   éƒ½é‡‡ç”¨ Thread.start() å¯åŠ¨çº¿ç¨‹
    

ä¸»è¦åŒºåˆ«

*   Runnable æ¥å£ run æ–¹æ³•æ— è¿”å›å€¼ï¼›Callable æ¥å£ call æ–¹æ³•æœ‰è¿”å›å€¼ï¼Œæ˜¯ä¸ªæ³›å‹ï¼Œå’Œ Futureã€FutureTask é…åˆå¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœ
*   Runnable æ¥å£ run æ–¹æ³•åªèƒ½æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œä¸”æ— æ³•æ•è·å¤„ç†ï¼›Callable æ¥å£ call æ–¹æ³•å…è®¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥è·å–å¼‚å¸¸ä¿¡æ¯

**æ³¨**ï¼šCallalbe æ¥å£æ”¯æŒè¿”å›æ‰§è¡Œç»“æœï¼Œéœ€è¦è°ƒç”¨ FutureTask.get() å¾—åˆ°ï¼Œæ­¤æ–¹æ³•ä¼šé˜»å¡ä¸»è¿›ç¨‹çš„ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœä¸è°ƒç”¨ä¸ä¼šé˜»å¡ã€‚

#### çº¿ç¨‹çš„ run() å’Œ start() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯é€šè¿‡æŸä¸ªç‰¹å®š Thread å¯¹è±¡æ‰€å¯¹åº”çš„æ–¹æ³• run() æ¥å®Œæˆå…¶æ“ä½œçš„ï¼Œrun() æ–¹æ³•ç§°ä¸ºçº¿ç¨‹ä½“ã€‚é€šè¿‡è°ƒç”¨ Thread ç±»çš„ start() æ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ã€‚

start() æ–¹æ³•ç”¨äºå¯åŠ¨çº¿ç¨‹ï¼Œrun() æ–¹æ³•ç”¨äºæ‰§è¡Œçº¿ç¨‹çš„è¿è¡Œæ—¶ä»£ç ã€‚run() å¯ä»¥é‡å¤è°ƒç”¨ï¼Œè€Œ start() åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚

start() æ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼ŒçœŸæ­£å®ç°äº†å¤šçº¿ç¨‹è¿è¡Œã€‚è°ƒç”¨ start() æ–¹æ³•æ— éœ€ç­‰å¾… run æ–¹æ³•ä½“ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥ç›´æ¥ç»§ç»­æ‰§è¡Œå…¶ä»–çš„ä»£ç ï¼› æ­¤æ—¶çº¿ç¨‹æ˜¯å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¹¶æ²¡æœ‰è¿è¡Œã€‚ ç„¶åé€šè¿‡æ­¤ Thread ç±»è°ƒç”¨æ–¹æ³• run() æ¥å®Œæˆå…¶è¿è¡ŒçŠ¶æ€ï¼Œ run() æ–¹æ³•è¿è¡Œç»“æŸï¼Œ æ­¤çº¿ç¨‹ç»ˆæ­¢ã€‚ç„¶å CPU å†è°ƒåº¦å…¶å®ƒçº¿ç¨‹ã€‚

run() æ–¹æ³•æ˜¯åœ¨æœ¬çº¿ç¨‹é‡Œçš„ï¼Œåªæ˜¯çº¿ç¨‹é‡Œçš„ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹çš„ã€‚ å¦‚æœç›´æ¥è°ƒç”¨ run()ï¼Œå…¶å®å°±ç›¸å½“äºæ˜¯è°ƒç”¨äº†ä¸€ä¸ªæ™®é€šå‡½æ•°è€Œå·²ï¼Œç›´æ¥å¾…ç”¨ run() æ–¹æ³•å¿…é¡»ç­‰å¾… run() æ–¹æ³•æ‰§è¡Œå®Œæ¯•æ‰èƒ½æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œæ‰€ä»¥æ‰§è¡Œè·¯å¾„è¿˜æ˜¯åªæœ‰ä¸€æ¡ï¼Œæ ¹æœ¬å°±æ²¡æœ‰çº¿ç¨‹çš„ç‰¹å¾ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹æ‰§è¡Œæ—¶è¦ä½¿ç”¨ start() æ–¹æ³•è€Œä¸æ˜¯ run() æ–¹æ³•ã€‚

#### ä¸ºä»€ä¹ˆæˆ‘ä»¬è°ƒç”¨ start() æ–¹æ³•æ—¶ä¼šæ‰§è¡Œ run() æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Ÿ

è¿™æ˜¯å¦ä¸€ä¸ªéå¸¸ç»å…¸çš„ java å¤šçº¿ç¨‹é¢è¯•é—®é¢˜ï¼Œè€Œä¸”åœ¨é¢è¯•ä¸­ä¼šç»å¸¸è¢«é—®åˆ°ã€‚å¾ˆç®€å•ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½ä¼šç­”ä¸ä¸Šæ¥ï¼

new ä¸€ä¸ª Threadï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€ã€‚è°ƒç”¨ start() æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ start() ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ run() æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚

è€Œç›´æ¥æ‰§è¡Œ run() æ–¹æ³•ï¼Œä¼šæŠŠ run æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚

æ€»ç»“ï¼š è°ƒç”¨ start æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œè€Œ run æ–¹æ³•åªæ˜¯ thread çš„ä¸€ä¸ªæ™®é€šæ–¹æ³•è°ƒç”¨ï¼Œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œæ‰§è¡Œã€‚

#### ä»€ä¹ˆæ˜¯ Callable å’Œ Future?

Callable æ¥å£ç±»ä¼¼äº Runnableï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œä½†æ˜¯ Runnable ä¸ä¼šè¿”å›ç»“æœï¼Œå¹¶ä¸”æ— æ³•æŠ›å‡ºè¿”å›ç»“æœçš„å¼‚å¸¸ï¼Œè€Œ Callable åŠŸèƒ½æ›´å¼ºå¤§ä¸€äº›ï¼Œè¢«çº¿ç¨‹æ‰§è¡Œåï¼Œå¯ä»¥è¿”å›å€¼ï¼Œè¿™ä¸ªè¿”å›å€¼å¯ä»¥è¢« Future æ‹¿åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒFuture å¯ä»¥æ‹¿åˆ°å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„è¿”å›å€¼ã€‚

Future æ¥å£è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡ï¼Œæ˜¯ä¸€ä¸ªå¯èƒ½è¿˜æ²¡æœ‰å®Œæˆçš„å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚æ‰€ä»¥è¯´ Callable ç”¨äºäº§ç”Ÿç»“æœï¼ŒFuture ç”¨äºè·å–ç»“æœã€‚

#### ä»€ä¹ˆæ˜¯ FutureTask

FutureTask è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥è¿ç®—çš„ä»»åŠ¡ã€‚FutureTask é‡Œé¢å¯ä»¥ä¼ å…¥ä¸€ä¸ª Callable çš„å…·ä½“å®ç°ç±»ï¼Œå¯ä»¥å¯¹è¿™ä¸ªå¼‚æ­¥è¿ç®—çš„ä»»åŠ¡çš„ç»“æœè¿›è¡Œç­‰å¾…è·å–ã€åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆã€å–æ¶ˆä»»åŠ¡ç­‰æ“ä½œã€‚åªæœ‰å½“è¿ç®—å®Œæˆçš„æ—¶å€™ç»“æœæ‰èƒ½å–å›ï¼Œå¦‚æœè¿ç®—å°šæœªå®Œæˆ get æ–¹æ³•å°†ä¼šé˜»å¡ã€‚ä¸€ä¸ª FutureTask å¯¹è±¡å¯ä»¥å¯¹è°ƒç”¨äº† Callable å’Œ Runnable çš„å¯¹è±¡è¿›è¡ŒåŒ…è£…ï¼Œç”±äº FutureTask ä¹Ÿæ˜¯ Runnable æ¥å£çš„å®ç°ç±»ï¼Œæ‰€ä»¥ FutureTask ä¹Ÿå¯ä»¥æ”¾å…¥çº¿ç¨‹æ± ä¸­ã€‚

### çº¿ç¨‹çš„çŠ¶æ€å’ŒåŸºæœ¬æ“ä½œ

#### è¯´è¯´çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸåŠäº”ç§åŸºæœ¬çŠ¶æ€ï¼Ÿ

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxNy8xMi8xNS8xNjA1OWNjOTFlZThlZmIz?x-oss-process=image/format,png)

1.  **æ–°å»º (new)**ï¼šæ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚
    
2.  **å¯è¿è¡Œ (runnable)**ï¼šçº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå½“è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start() æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œç­‰å¾…è¢«çº¿ç¨‹è°ƒåº¦é€‰ä¸­ï¼Œè·å– cpu çš„ä½¿ç”¨æƒã€‚
    
3.  **è¿è¡Œ (running)**ï¼šå¯è¿è¡ŒçŠ¶æ€ (runnable) çš„çº¿ç¨‹è·å¾—äº† cpu æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰ï¼Œæ‰§è¡Œç¨‹åºä»£ç ã€‚æ³¨ï¼šå°±ç»ªçŠ¶æ€æ˜¯è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€çš„å”¯ä¸€å…¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹è¦æƒ³è¿›å…¥è¿è¡ŒçŠ¶æ€æ‰§è¡Œï¼Œé¦–å…ˆå¿…é¡»å¤„äºå°±ç»ªçŠ¶æ€ä¸­ï¼›
    
4.  **é˜»å¡ (block)**ï¼šå¤„äºè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ç”±äºæŸç§åŸå› ï¼Œæš‚æ—¶æ”¾å¼ƒå¯¹ CPU çš„ä½¿ç”¨æƒï¼Œåœæ­¢æ‰§è¡Œï¼Œæ­¤æ—¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€ï¼Œæ‰ æœ‰æœºä¼šå†æ¬¡è¢« CPU è°ƒç”¨ä»¥è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€ã€‚
    
    é˜»å¡çš„æƒ…å†µåˆ†ä¸‰ç§ï¼š  
    (ä¸€). ç­‰å¾…é˜»å¡ï¼šè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹æ‰§è¡Œ wait() æ–¹æ³•ï¼ŒJVM ä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ— (waitting queue) ä¸­ï¼Œä½¿æœ¬çº¿ç¨‹è¿›å…¥åˆ°ç­‰å¾…é˜»å¡çŠ¶æ€ï¼›  
    (äºŒ). åŒæ­¥é˜»å¡ï¼šçº¿ç¨‹åœ¨è·å– synchronized åŒæ­¥é”å¤±è´¥ (å› ä¸ºé”è¢«å…¶å®ƒçº¿ç¨‹æ‰€å ç”¨)ï¼Œï¼Œåˆ™ JVM ä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ±  (lock pool) ä¸­ï¼Œçº¿ç¨‹ä¼šè¿›å…¥åŒæ­¥é˜»å¡çŠ¶æ€ï¼›  
    (ä¸‰). å…¶ä»–é˜»å¡: é€šè¿‡è°ƒç”¨çº¿ç¨‹çš„ sleep() æˆ– join() æˆ–å‘å‡ºäº† I/O è¯·æ±‚æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚å½“ sleep() çŠ¶æ€è¶…æ—¶ã€join() ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢æˆ–è€…è¶…æ—¶ã€æˆ–è€… I/O å¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å°±ç»ªçŠ¶æ€ã€‚
    
5.  **æ­»äº¡ (dead)**ï¼šçº¿ç¨‹ run()ã€main() æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œæˆ–è€…å› å¼‚å¸¸é€€å‡ºäº† run() æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚æ­»äº¡çš„çº¿ç¨‹ä¸å¯å†æ¬¡å¤ç”Ÿã€‚
    

#### Java ä¸­ç”¨åˆ°çš„çº¿ç¨‹è°ƒåº¦ç®—æ³•æ˜¯ä»€ä¹ˆï¼Ÿ

è®¡ç®—æœºé€šå¸¸åªæœ‰ä¸€ä¸ª CPUï¼Œåœ¨ä»»æ„æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œæ¯ä¸ªçº¿ç¨‹åªæœ‰è·å¾— CPU çš„ä½¿ç”¨æƒæ‰èƒ½æ‰§è¡ŒæŒ‡ä»¤ã€‚æ‰€è°“å¤šçº¿ç¨‹çš„å¹¶å‘è¿è¡Œï¼Œå…¶å®æ˜¯æŒ‡ä»å®è§‚ä¸Šçœ‹ï¼Œå„ä¸ªçº¿ç¨‹è½®æµè·å¾— CPU çš„ä½¿ç”¨æƒï¼Œåˆ†åˆ«æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡ã€‚åœ¨è¿è¡Œæ± ä¸­ï¼Œä¼šæœ‰å¤šä¸ªå¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åœ¨ç­‰å¾… CPUï¼ŒJAVA è™šæ‹Ÿæœºçš„ä¸€é¡¹ä»»åŠ¡å°±æ˜¯è´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦ï¼Œçº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡æŒ‰ç…§ç‰¹å®šæœºåˆ¶ä¸ºå¤šä¸ªçº¿ç¨‹åˆ†é… CPU çš„ä½¿ç”¨æƒã€‚

æœ‰ä¸¤ç§è°ƒåº¦æ¨¡å‹ï¼šåˆ†æ—¶è°ƒåº¦æ¨¡å‹å’ŒæŠ¢å å¼è°ƒåº¦æ¨¡å‹ã€‚

åˆ†æ—¶è°ƒåº¦æ¨¡å‹æ˜¯æŒ‡è®©æ‰€æœ‰çš„çº¿ç¨‹è½®æµè·å¾— cpu çš„ä½¿ç”¨æƒï¼Œå¹¶ä¸”å¹³å‡åˆ†é…æ¯ä¸ªçº¿ç¨‹å ç”¨çš„ CPU çš„æ—¶é—´ç‰‡è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚

Java è™šæ‹Ÿæœºé‡‡ç”¨æŠ¢å å¼è°ƒåº¦æ¨¡å‹ï¼Œæ˜¯æŒ‡ä¼˜å…ˆè®©å¯è¿è¡Œæ± ä¸­ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹å ç”¨ CPUï¼Œå¦‚æœå¯è¿è¡Œæ± ä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆå°±éšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼Œä½¿å…¶å ç”¨ CPUã€‚å¤„äºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ä¼šä¸€ç›´è¿è¡Œï¼Œç›´è‡³å®ƒä¸å¾—ä¸æ”¾å¼ƒ CPUã€‚

#### çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥

çº¿ç¨‹è°ƒåº¦å™¨é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹è¿è¡Œï¼Œä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼Œå°±ä¼šç»ˆæ­¢çº¿ç¨‹çš„è¿è¡Œï¼š

ï¼ˆ1ï¼‰çº¿ç¨‹ä½“ä¸­è°ƒç”¨äº† yield æ–¹æ³•è®©å‡ºäº†å¯¹ cpu çš„å ç”¨æƒåˆ©

ï¼ˆ2ï¼‰çº¿ç¨‹ä½“ä¸­è°ƒç”¨äº† sleep æ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€

ï¼ˆ3ï¼‰çº¿ç¨‹ç”±äº IO æ“ä½œå—åˆ°é˜»å¡

ï¼ˆ4ï¼‰å¦å¤–ä¸€ä¸ªæ›´é«˜ä¼˜å…ˆçº§çº¿ç¨‹å‡ºç°

ï¼ˆ5ï¼‰åœ¨æ”¯æŒæ—¶é—´ç‰‡çš„ç³»ç»Ÿä¸­ï¼Œè¯¥çº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œ

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹è°ƒåº¦å™¨ (Thread Scheduler) å’Œæ—¶é—´åˆ†ç‰‡ (Time Slicing )ï¼Ÿ

çº¿ç¨‹è°ƒåº¦å™¨æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»ŸæœåŠ¡ï¼Œå®ƒè´Ÿè´£ä¸º Runnable çŠ¶æ€çš„çº¿ç¨‹åˆ†é… CPU æ—¶é—´ã€‚ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶å¯åŠ¨å®ƒï¼Œå®ƒçš„æ‰§è¡Œä¾¿ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨çš„å®ç°ã€‚

æ—¶é—´åˆ†ç‰‡æ˜¯æŒ‡å°†å¯ç”¨çš„ CPU æ—¶é—´åˆ†é…ç»™å¯ç”¨çš„ Runnable çº¿ç¨‹çš„è¿‡ç¨‹ã€‚åˆ†é… CPU æ—¶é—´å¯ä»¥åŸºäºçº¿ç¨‹ä¼˜å…ˆçº§æˆ–è€…çº¿ç¨‹ç­‰å¾…çš„æ—¶é—´ã€‚

çº¿ç¨‹è°ƒåº¦å¹¶ä¸å—åˆ° Java è™šæ‹Ÿæœºæ§åˆ¶ï¼Œæ‰€ä»¥ç”±åº”ç”¨ç¨‹åºæ¥æ§åˆ¶å®ƒæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸è¦è®©ä½ çš„ç¨‹åºä¾èµ–äºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼‰ã€‚

#### è¯·è¯´å‡ºä¸çº¿ç¨‹åŒæ­¥ä»¥åŠçº¿ç¨‹è°ƒåº¦ç›¸å…³çš„æ–¹æ³•ã€‚

ï¼ˆ1ï¼‰ wait()ï¼šä½¿ä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…ï¼ˆé˜»å¡ï¼‰çŠ¶æ€ï¼Œå¹¶ä¸”é‡Šæ”¾æ‰€æŒæœ‰çš„å¯¹è±¡çš„é”ï¼›

ï¼ˆ2ï¼‰sleep()ï¼šä½¿ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å¤„äºç¡çœ çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œè°ƒç”¨æ­¤æ–¹æ³•è¦å¤„ç† InterruptedException å¼‚å¸¸ï¼›

ï¼ˆ3ï¼‰notify()ï¼šå”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œå½“ç„¶åœ¨è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç¡®åˆ‡çš„å”¤é†’æŸä¸€ä¸ªç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè€Œæ˜¯ç”± JVM ç¡®å®šå”¤é†’å“ªä¸ªçº¿ç¨‹ï¼Œè€Œä¸”ä¸ä¼˜å…ˆçº§æ— å…³ï¼›

ï¼ˆ4ï¼‰notityAll()ï¼šå”¤é†’æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¯¥æ–¹æ³•å¹¶ä¸æ˜¯å°†å¯¹è±¡çš„é”ç»™æ‰€æœ‰çº¿ç¨‹ï¼Œè€Œæ˜¯è®©å®ƒä»¬ç«äº‰ï¼Œåªæœ‰è·å¾—é”çš„çº¿ç¨‹æ‰èƒ½è¿›å…¥å°±ç»ªçŠ¶æ€ï¼›

#### sleep() å’Œ wait() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œ

*   ç±»çš„ä¸åŒï¼šsleep() æ˜¯ Thread çº¿ç¨‹ç±»çš„é™æ€æ–¹æ³•ï¼Œwait() æ˜¯ Object ç±»çš„æ–¹æ³•ã€‚
*   æ˜¯å¦é‡Šæ”¾é”ï¼šsleep() ä¸é‡Šæ”¾é”ï¼›wait() é‡Šæ”¾é”ã€‚
*   ç”¨é€”ä¸åŒï¼šWait é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’ / é€šä¿¡ï¼Œsleep é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚
*   ç”¨æ³•ä¸åŒï¼šwait() æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ notify() æˆ–è€… notifyAll() æ–¹æ³•ã€‚sleep() æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚æˆ–è€…å¯ä»¥ä½¿ç”¨ wait(long timeout) è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚

#### ä½ æ˜¯å¦‚ä½•è°ƒç”¨ wait() æ–¹æ³•çš„ï¼Ÿä½¿ç”¨ if å—è¿˜æ˜¯å¾ªç¯ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹å¯èƒ½ä¼šæ”¶åˆ°é”™è¯¯è­¦æŠ¥å’Œä¼ªå”¤é†’ï¼Œå¦‚æœä¸åœ¨å¾ªç¯ä¸­æ£€æŸ¥ç­‰å¾…æ¡ä»¶ï¼Œç¨‹åºå°±ä¼šåœ¨æ²¡æœ‰æ»¡è¶³ç»“æŸæ¡ä»¶çš„æƒ…å†µä¸‹é€€å‡ºã€‚

wait() æ–¹æ³•åº”è¯¥åœ¨å¾ªç¯è°ƒç”¨ï¼Œå› ä¸ºå½“çº¿ç¨‹è·å–åˆ° CPU å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶ä»–æ¡ä»¶å¯èƒ½è¿˜æ²¡æœ‰æ»¡è¶³ï¼Œæ‰€ä»¥åœ¨å¤„ç†å‰ï¼Œå¾ªç¯æ£€æµ‹æ¡ä»¶æ˜¯å¦æ»¡è¶³ä¼šæ›´å¥½ã€‚ä¸‹é¢æ˜¯ä¸€æ®µæ ‡å‡†çš„ä½¿ç”¨ wait å’Œ notify æ–¹æ³•çš„ä»£ç ï¼š

```
synchronized (monitor) {
    //  åˆ¤æ–­æ¡ä»¶è°“è¯æ˜¯å¦å¾—åˆ°æ»¡è¶³
    while(!locked) {
        //  ç­‰å¾…å”¤é†’
        monitor.wait();
    }
    //  å¤„ç†å…¶ä»–çš„ä¸šåŠ¡é€»è¾‘
}
```

#### ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³• wait(), notify() å’Œ notifyAll() è¢«å®šä¹‰åœ¨ Object ç±»é‡Œï¼Ÿ

Java ä¸­ï¼Œä»»ä½•å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼Œå¹¶ä¸” wait()ï¼Œnotify() ç­‰æ–¹æ³•ç”¨äºç­‰å¾…å¯¹è±¡çš„é”æˆ–è€…å”¤é†’çº¿ç¨‹ï¼Œåœ¨ Java çš„çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰å¯ä¾›ä»»ä½•å¯¹è±¡ä½¿ç”¨çš„é”ï¼Œæ‰€ä»¥ä»»æ„å¯¹è±¡è°ƒç”¨æ–¹æ³•ä¸€å®šå®šä¹‰åœ¨ Object ç±»ä¸­ã€‚

wait(), notify() å’Œ notifyAll() è¿™äº›æ–¹æ³•åœ¨åŒæ­¥ä»£ç å—ä¸­è°ƒç”¨

æœ‰çš„äººä¼šè¯´ï¼Œæ—¢ç„¶æ˜¯çº¿ç¨‹æ”¾å¼ƒå¯¹è±¡é”ï¼Œé‚£ä¹Ÿå¯ä»¥æŠŠ wait() å®šä¹‰åœ¨ Thread ç±»é‡Œé¢å•Šï¼Œæ–°å®šä¹‰çš„çº¿ç¨‹ç»§æ‰¿äº Thread ç±»ï¼Œä¹Ÿä¸éœ€è¦é‡æ–°å®šä¹‰ wait() æ–¹æ³•çš„å®ç°ã€‚ç„¶è€Œï¼Œè¿™æ ·åšæœ‰ä¸€ä¸ªéå¸¸å¤§çš„é—®é¢˜ï¼Œä¸€ä¸ªçº¿ç¨‹å®Œå…¨å¯ä»¥æŒæœ‰å¾ˆå¤šé”ï¼Œä½ ä¸€ä¸ªçº¿ç¨‹æ”¾å¼ƒé”çš„æ—¶å€™ï¼Œåˆ°åº•è¦æ”¾å¼ƒå“ªä¸ªé”ï¼Ÿå½“ç„¶äº†ï¼Œè¿™ç§è®¾è®¡å¹¶ä¸æ˜¯ä¸èƒ½å®ç°ï¼Œåªæ˜¯ç®¡ç†èµ·æ¥æ›´åŠ å¤æ‚ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œwait()ã€notify() å’Œ notifyAll() æ–¹æ³•è¦å®šä¹‰åœ¨ Object ç±»ä¸­ã€‚

#### ä¸ºä»€ä¹ˆ wait(), notify() å’Œ notifyAll() å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ï¼Ÿ

å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ wait() æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹å¿…é¡»æ‹¥æœ‰è¯¥å¯¹è±¡çš„é”ï¼Œæ¥ç€å®ƒå°±ä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„ notify() æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ notify() æ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä»¥ä¾¿å…¶ä»–åœ¨ç­‰å¾…çš„çº¿ç¨‹å°±å¯ä»¥å¾—åˆ°è¿™ä¸ªå¯¹è±¡é”ã€‚ç”±äºæ‰€æœ‰çš„è¿™äº›æ–¹æ³•éƒ½éœ€è¦çº¿ç¨‹æŒæœ‰å¯¹è±¡çš„é”ï¼Œè¿™æ ·å°±åªèƒ½é€šè¿‡åŒæ­¥æ¥å®ç°ï¼Œæ‰€ä»¥ä»–ä»¬åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ã€‚

#### Thread ç±»ä¸­çš„ yield æ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

ä½¿å½“å‰çº¿ç¨‹ä»æ‰§è¡ŒçŠ¶æ€ï¼ˆè¿è¡ŒçŠ¶æ€ï¼‰å˜ä¸ºå¯æ‰§è¡Œæ€ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰ã€‚

å½“å‰çº¿ç¨‹åˆ°äº†å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å“ªä¸ªçº¿ç¨‹ä¼šä»å°±ç»ªçŠ¶æ€å˜æˆæ‰§è¡ŒçŠ¶æ€å‘¢ï¼Ÿå¯èƒ½æ˜¯å½“å‰çº¿ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–çº¿ç¨‹ï¼Œçœ‹ç³»ç»Ÿçš„åˆ†é…äº†ã€‚

#### ä¸ºä»€ä¹ˆ Thread ç±»çš„ sleep() å’Œ yield () æ–¹æ³•æ˜¯é™æ€çš„ï¼Ÿ

Thread ç±»çš„ sleep() å’Œ yield() æ–¹æ³•å°†åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚æ‰€ä»¥åœ¨å…¶ä»–å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ä¸Šè°ƒç”¨è¿™äº›æ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™äº›æ–¹æ³•æ˜¯é™æ€çš„ã€‚å®ƒä»¬å¯ä»¥åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸­å·¥ä½œï¼Œå¹¶é¿å…ç¨‹åºå‘˜é”™è¯¯çš„è®¤ä¸ºå¯ä»¥åœ¨å…¶ä»–éè¿è¡Œçº¿ç¨‹è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚

#### çº¿ç¨‹çš„ sleep() æ–¹æ³•å’Œ yield() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ï¼ˆ1ï¼‰ sleep() æ–¹æ³•ç»™å…¶ä»–çº¿ç¨‹è¿è¡Œæœºä¼šæ—¶ä¸è€ƒè™‘çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ä¼šç»™ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹ä»¥è¿è¡Œçš„æœºä¼šï¼›yield() æ–¹æ³•åªä¼šç»™ç›¸åŒä¼˜å…ˆçº§æˆ–æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä»¥è¿è¡Œçš„æœºä¼šï¼›

ï¼ˆ2ï¼‰ çº¿ç¨‹æ‰§è¡Œ sleep() æ–¹æ³•åè½¬å…¥é˜»å¡ï¼ˆblockedï¼‰çŠ¶æ€ï¼Œè€Œæ‰§è¡Œ yield() æ–¹æ³•åè½¬å…¥å°±ç»ªï¼ˆreadyï¼‰çŠ¶æ€ï¼›

ï¼ˆ3ï¼‰sleep() æ–¹æ³•å£°æ˜æŠ›å‡º InterruptedExceptionï¼Œè€Œ yield() æ–¹æ³•æ²¡æœ‰å£°æ˜ä»»ä½•å¼‚å¸¸ï¼›

ï¼ˆ4ï¼‰sleep() æ–¹æ³•æ¯” yield() æ–¹æ³•ï¼ˆè·Ÿæ“ä½œç³»ç»Ÿ CPU è°ƒåº¦ç›¸å…³ï¼‰å…·æœ‰æ›´å¥½çš„å¯ç§»æ¤æ€§ï¼Œé€šå¸¸ä¸å»ºè®®ä½¿ç”¨ yield() æ–¹æ³•æ¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ‰§è¡Œã€‚

#### å¦‚ä½•åœæ­¢ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Ÿ

åœ¨ java ä¸­æœ‰ä»¥ä¸‹ 3 ç§æ–¹æ³•å¯ä»¥ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼š

1.  ä½¿ç”¨é€€å‡ºæ ‡å¿—ï¼Œä½¿çº¿ç¨‹æ­£å¸¸é€€å‡ºï¼Œä¹Ÿå°±æ˜¯å½“ run æ–¹æ³•å®Œæˆåçº¿ç¨‹ç»ˆæ­¢ã€‚
2.  ä½¿ç”¨ stop æ–¹æ³•å¼ºè¡Œç»ˆæ­¢ï¼Œä½†æ˜¯ä¸æ¨èè¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸º stop å’Œ suspend åŠ resume ä¸€æ ·éƒ½æ˜¯è¿‡æœŸä½œåºŸçš„æ–¹æ³•ã€‚
3.  ä½¿ç”¨ interrupt æ–¹æ³•ä¸­æ–­çº¿ç¨‹ã€‚

#### Java ä¸­ interrupted å’Œ isInterrupted æ–¹æ³•çš„åŒºåˆ«ï¼Ÿ

interruptï¼šç”¨äºä¸­æ–­çº¿ç¨‹ã€‚è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹çš„çŠ¶æ€ä¸ºå°†è¢«ç½®ä¸ºâ€ ä¸­æ–­â€ çŠ¶æ€ã€‚

æ³¨æ„ï¼šçº¿ç¨‹ä¸­æ–­ä»…ä»…æ˜¯ç½®çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä½ï¼Œä¸ä¼šåœæ­¢çº¿ç¨‹ã€‚éœ€è¦ç”¨æˆ·è‡ªå·±å»ç›‘è§†çº¿ç¨‹çš„çŠ¶æ€ä¸ºå¹¶åšå¤„ç†ã€‚æ”¯æŒçº¿ç¨‹ä¸­æ–­çš„æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯çº¿ç¨‹ä¸­æ–­åä¼šæŠ›å‡º interruptedException çš„æ–¹æ³•ï¼‰å°±æ˜¯åœ¨ç›‘è§†çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œä¸€æ—¦çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€è¢«ç½®ä¸º â€œä¸­æ–­çŠ¶æ€â€ï¼Œå°±ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚

interruptedï¼šæ˜¯é™æ€æ–¹æ³•ï¼ŒæŸ¥çœ‹å½“å‰ä¸­æ–­ä¿¡å·æ˜¯ true è¿˜æ˜¯ false å¹¶ä¸”æ¸…é™¤ä¸­æ–­ä¿¡å·ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ interrupted åˆ™è¿”å› trueï¼Œç¬¬äºŒæ¬¡å’Œåé¢çš„å°±è¿”å› false äº†ã€‚

isInterruptedï¼šæŸ¥çœ‹å½“å‰ä¸­æ–­ä¿¡å·æ˜¯ true è¿˜æ˜¯ false

#### ä»€ä¹ˆæ˜¯é˜»å¡å¼æ–¹æ³•ï¼Ÿ

é˜»å¡å¼æ–¹æ³•æ˜¯æŒ‡ç¨‹åºä¼šä¸€ç›´ç­‰å¾…è¯¥æ–¹æ³•å®ŒæˆæœŸé—´ä¸åšå…¶ä»–äº‹æƒ…ï¼ŒServerSocket çš„ accept() æ–¹æ³•å°±æ˜¯ä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚è¿™é‡Œçš„é˜»å¡æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰å¼‚æ­¥å’Œéé˜»å¡å¼æ–¹æ³•åœ¨ä»»åŠ¡å®Œæˆå‰å°±è¿”å›ã€‚

#### Java ä¸­ä½ æ€æ ·å”¤é†’ä¸€ä¸ªé˜»å¡çš„çº¿ç¨‹ï¼Ÿ

é¦–å…ˆï¼Œwait()ã€notify() æ–¹æ³•æ˜¯é’ˆå¯¹å¯¹è±¡çš„ï¼Œè°ƒç”¨ä»»æ„å¯¹è±¡çš„ wait() æ–¹æ³•éƒ½å°†å¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œé˜»å¡çš„åŒæ—¶ä¹Ÿå°†é‡Šæ”¾è¯¥å¯¹è±¡çš„é”ï¼Œç›¸åº”åœ°ï¼Œè°ƒç”¨ä»»æ„å¯¹è±¡çš„ notify() æ–¹æ³•åˆ™å°†éšæœºè§£é™¤è¯¥å¯¹è±¡é˜»å¡çš„çº¿ç¨‹ï¼Œä½†å®ƒéœ€è¦é‡æ–°è·å–è¯¥å¯¹è±¡çš„é”ï¼Œç›´åˆ°è·å–æˆåŠŸæ‰èƒ½å¾€ä¸‹æ‰§è¡Œï¼›

å…¶æ¬¡ï¼Œwaitã€notify æ–¹æ³•å¿…é¡»åœ¨ synchronized å—æˆ–æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå¹¶ä¸”è¦ä¿è¯åŒæ­¥å—æˆ–æ–¹æ³•çš„é”å¯¹è±¡ä¸è°ƒç”¨ waitã€notify æ–¹æ³•çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æ­¤ä¸€æ¥åœ¨è°ƒç”¨ wait ä¹‹å‰å½“å‰çº¿ç¨‹å°±å·²ç»æˆåŠŸè·å–æŸå¯¹è±¡çš„é”ï¼Œæ‰§è¡Œ wait é˜»å¡åå½“å‰çº¿ç¨‹å°±å°†ä¹‹å‰è·å–çš„å¯¹è±¡é”é‡Šæ”¾ã€‚

#### notify() å’Œ notifyAll() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

å¦‚æœçº¿ç¨‹è°ƒç”¨äº†å¯¹è±¡çš„ wait() æ–¹æ³•ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¾¿ä¼šå¤„äºè¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­ï¼Œç­‰å¾…æ± ä¸­çš„çº¿ç¨‹ä¸ä¼šå»ç«äº‰è¯¥å¯¹è±¡çš„é”ã€‚

notifyAll() ä¼šå”¤é†’æ‰€æœ‰çš„çº¿ç¨‹ï¼Œnotify() åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ã€‚

notifyAll() è°ƒç”¨åï¼Œä¼šå°†å…¨éƒ¨çº¿ç¨‹ç”±ç­‰å¾…æ± ç§»åˆ°é”æ± ï¼Œç„¶åå‚ä¸é”çš„ç«äº‰ï¼Œç«äº‰æˆåŠŸåˆ™ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœä¸æˆåŠŸåˆ™ç•™åœ¨é”æ± ç­‰å¾…é”è¢«é‡Šæ”¾åå†æ¬¡å‚ä¸ç«äº‰ã€‚è€Œ notify() åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå…·ä½“å”¤é†’å“ªä¸€ä¸ªçº¿ç¨‹ç”±è™šæ‹Ÿæœºæ§åˆ¶ã€‚

#### å¦‚ä½•åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´å…±äº«æ•°æ®ï¼Ÿ

åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´å…±äº«å˜é‡å³å¯å®ç°å…±äº«ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå…±äº«å˜é‡è¦æ±‚å˜é‡æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç„¶ååœ¨çº¿ç¨‹å†…ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœæœ‰å¯¹å…±äº«å˜é‡çš„å¤åˆæ“ä½œï¼Œé‚£ä¹ˆä¹Ÿå¾—ä¿è¯å¤åˆæ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚

#### Java å¦‚ä½•å®ç°å¤šçº¿ç¨‹ä¹‹é—´çš„é€šè®¯å’Œåä½œï¼Ÿ

å¯ä»¥é€šè¿‡ä¸­æ–­ å’Œ å…±äº«å˜é‡çš„æ–¹å¼å®ç°çº¿ç¨‹é—´çš„é€šè®¯å’Œåä½œ

æ¯”å¦‚è¯´æœ€ç»å…¸çš„ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å‹ï¼šå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…éœ€è¦ç­‰å¾…é˜Ÿåˆ—æœ‰ç©ºé—´æ‰èƒ½ç»§ç»­å¾€é‡Œé¢æ”¾å…¥å•†å“ï¼Œè€Œ**åœ¨ç­‰å¾…çš„æœŸé—´å†…ï¼Œç”Ÿäº§è€…å¿…é¡»é‡Šæ”¾å¯¹ä¸´ç•Œèµ„æºï¼ˆå³é˜Ÿåˆ—ï¼‰çš„å ç”¨æƒ**ã€‚å› ä¸ºç”Ÿäº§è€…å¦‚æœä¸é‡Šæ”¾å¯¹ä¸´ç•Œèµ„æºçš„å ç”¨æƒï¼Œé‚£ä¹ˆ**æ¶ˆè´¹è€…å°±æ— æ³•æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„å•†å“**ï¼Œå°±ä¸ä¼šè®©é˜Ÿåˆ—æœ‰ç©ºé—´ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±ä¼šä¸€ç›´æ— é™ç­‰å¾…ä¸‹å»ã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œä¼šè®©ç”Ÿäº§è€…äº¤å‡ºå¯¹ä¸´ç•Œèµ„æºçš„å ç”¨æƒï¼Œå¹¶è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚ç„¶åç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹äº†å•†å“ï¼Œç„¶åæ¶ˆè´¹è€…é€šçŸ¥ç”Ÿäº§è€…é˜Ÿåˆ—æœ‰ç©ºé—´äº†ã€‚åŒæ ·åœ°ï¼Œå½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿå¿…é¡»ç­‰å¾…ï¼Œç­‰å¾…ç”Ÿäº§è€…é€šçŸ¥å®ƒé˜Ÿåˆ—ä¸­æœ‰å•†å“äº†ã€‚è¿™ç§äº’ç›¸é€šä¿¡çš„è¿‡ç¨‹å°±æ˜¯çº¿ç¨‹é—´çš„åä½œã€‚

Java ä¸­çº¿ç¨‹é€šä¿¡åä½œçš„æœ€å¸¸è§çš„ä¸¤ç§æ–¹å¼ï¼š

ä¸€. syncrhoized åŠ é”çš„çº¿ç¨‹çš„ **Object ç±»**çš„ wait()/notify()/notifyAll()

äºŒ. ReentrantLock ç±»åŠ é”çš„çº¿ç¨‹çš„ **Condition ç±»çš„** await()/signal()/signalAll()

çº¿ç¨‹é—´ç›´æ¥çš„æ•°æ®äº¤æ¢ï¼š

ä¸‰. é€šè¿‡ç®¡é“è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ï¼š1ï¼‰å­—èŠ‚æµï¼›2ï¼‰å­—ç¬¦æµ

#### åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥å—ï¼Œå“ªä¸ªæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Ÿ

åŒæ­¥å—æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒä¸ä¼šé”ä½æ•´ä¸ªå¯¹è±¡ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥è®©å®ƒé”ä½æ•´ä¸ªå¯¹è±¡ï¼‰ã€‚åŒæ­¥æ–¹æ³•ä¼šé”ä½æ•´ä¸ªå¯¹è±¡ï¼Œå“ªæ€•è¿™ä¸ªç±»ä¸­æœ‰å¤šä¸ªä¸ç›¸å…³è”çš„åŒæ­¥å—ï¼Œè¿™é€šå¸¸ä¼šå¯¼è‡´ä»–ä»¬åœæ­¢æ‰§è¡Œå¹¶éœ€è¦ç­‰å¾…è·å¾—è¿™ä¸ªå¯¹è±¡ä¸Šçš„é”ã€‚

åŒæ­¥å—æ›´è¦ç¬¦åˆå¼€æ”¾è°ƒç”¨çš„åŸåˆ™ï¼Œåªåœ¨éœ€è¦é”ä½çš„ä»£ç å—é”ä½ç›¸åº”çš„å¯¹è±¡ï¼Œè¿™æ ·ä»ä¾§é¢æ¥è¯´ä¹Ÿå¯ä»¥é¿å…æ­»é”ã€‚

è¯·çŸ¥é“ä¸€æ¡åŸåˆ™ï¼šåŒæ­¥çš„èŒƒå›´è¶Šå°è¶Šå¥½ã€‚

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹äº’æ–¥ï¼Œæœ‰å“ªå‡ ç§å®ç°æ–¹å¼ï¼Ÿ

å½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«çš„æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œåº”ä½¿ä¹‹æˆä¸ºä¸€ä¸ªâ€ åŸå­æ“ä½œ â€œï¼Œå³åœ¨æ²¡æœ‰å®Œæˆç›¸å…³æ“ä½œä¹‹å‰ï¼Œä¸å…è®¸å…¶ä»–çº¿ç¨‹æ‰“æ–­å®ƒï¼Œå¦åˆ™ï¼Œå°±ä¼šç ´åæ•°æ®çš„å®Œæ•´æ€§ï¼Œå¿…ç„¶ä¼šå¾—åˆ°é”™è¯¯çš„å¤„ç†ç»“æœï¼Œè¿™å°±æ˜¯çº¿ç¨‹çš„åŒæ­¥ã€‚

åœ¨å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œè€ƒè™‘ä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®åŒæ­¥å’Œé˜²æ­¢æ­»é”ã€‚å½“ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¹‹é—´åŒæ—¶ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºçš„æ—¶å€™å°±ä¼šå½¢æˆçº¿ç¨‹ä¹‹é—´çš„æ­»é”ã€‚ä¸ºäº†é˜²æ­¢æ­»é”çš„å‘ç”Ÿï¼Œéœ€è¦é€šè¿‡åŒæ­¥æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚

çº¿ç¨‹äº’æ–¥æ˜¯æŒ‡å¯¹äºå…±äº«çš„è¿›ç¨‹ç³»ç»Ÿèµ„æºï¼Œåœ¨å„å•ä¸ªçº¿ç¨‹è®¿é—®æ—¶çš„æ’å®ƒæ€§ã€‚å½“æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹éƒ½è¦ä½¿ç”¨æŸä¸€å…±äº«èµ„æºæ—¶ï¼Œä»»ä½•æ—¶åˆ»æœ€å¤šåªå…è®¸ä¸€ä¸ªçº¿ç¨‹å»ä½¿ç”¨ï¼Œå…¶å®ƒè¦ä½¿ç”¨è¯¥èµ„æºçš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°å ç”¨èµ„æºè€…é‡Šæ”¾è¯¥èµ„æºã€‚çº¿ç¨‹äº’æ–¥å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹åŒæ­¥ã€‚

çº¿ç¨‹é—´çš„åŒæ­¥æ–¹æ³•å¤§ä½“å¯åˆ†ä¸ºä¸¤ç±»ï¼šç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ã€‚é¡¾åæ€ä¹‰ï¼Œå†…æ ¸æ¨¡å¼å°±æ˜¯æŒ‡åˆ©ç”¨ç³»ç»Ÿå†…æ ¸å¯¹è±¡çš„å•ä¸€æ€§æ¥è¿›è¡ŒåŒæ­¥ï¼Œä½¿ç”¨æ—¶éœ€è¦åˆ‡æ¢å†…æ ¸æ€ä¸ç”¨æˆ·æ€ï¼Œè€Œç”¨æˆ·æ¨¡å¼å°±æ˜¯ä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œåªåœ¨ç”¨æˆ·æ€å®Œæˆæ“ä½œã€‚

ç”¨æˆ·æ¨¡å¼ä¸‹çš„æ–¹æ³•æœ‰ï¼šåŸå­æ“ä½œï¼ˆä¾‹å¦‚ä¸€ä¸ªå•ä¸€çš„å…¨å±€å˜é‡ï¼‰ï¼Œä¸´ç•ŒåŒºã€‚å†…æ ¸æ¨¡å¼ä¸‹çš„æ–¹æ³•æœ‰ï¼šäº‹ä»¶ï¼Œä¿¡å·é‡ï¼Œäº’æ–¥é‡ã€‚

å®ç°çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•

*   åŒæ­¥ä»£ç æ–¹æ³•ï¼šsychronized å…³é”®å­—ä¿®é¥°çš„æ–¹æ³•
    
*   åŒæ­¥ä»£ç å—ï¼šsychronized å…³é”®å­—ä¿®é¥°çš„ä»£ç å—
    
*   ä½¿ç”¨ç‰¹æ®Šå˜é‡åŸŸ volatile å®ç°çº¿ç¨‹åŒæ­¥ï¼švolatile å…³é”®å­—ä¸ºåŸŸå˜é‡çš„è®¿é—®æä¾›äº†ä¸€ç§å…é”æœºåˆ¶
    
*   ä½¿ç”¨é‡å…¥é”å®ç°çº¿ç¨‹åŒæ­¥ï¼šreentrantlock ç±»æ˜¯å¯å†²å…¥ã€äº’æ–¥ã€å®ç°äº† lock æ¥å£çš„é”ä»–ä¸ sychronized æ–¹æ³•å…·æœ‰ç›¸åŒçš„åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰
    

#### åœ¨ç›‘è§†å™¨ (Monitor) å†…éƒ¨ï¼Œæ˜¯å¦‚ä½•åšçº¿ç¨‹åŒæ­¥çš„ï¼Ÿç¨‹åºåº”è¯¥åšå“ªç§çº§åˆ«çš„åŒæ­¥ï¼Ÿ

åœ¨ java è™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªå¯¹è±¡ (Object å’Œ class) é€šè¿‡æŸç§é€»è¾‘å…³è”ç›‘è§†å™¨, æ¯ä¸ªç›‘è§†å™¨å’Œä¸€ä¸ªå¯¹è±¡å¼•ç”¨ç›¸å…³è”ï¼Œä¸ºäº†å®ç°ç›‘è§†å™¨çš„äº’æ–¥åŠŸèƒ½ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½å…³è”ç€ä¸€æŠŠé”ã€‚

ä¸€æ—¦æ–¹æ³•æˆ–è€…ä»£ç å—è¢« **synchronized** ä¿®é¥°ï¼Œé‚£ä¹ˆè¿™ä¸ªéƒ¨åˆ†å°±æ”¾å…¥äº†ç›‘è§†å™¨çš„ç›‘è§†åŒºåŸŸï¼Œ**ç¡®ä¿ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥éƒ¨åˆ†çš„ä»£ç **ï¼Œçº¿ç¨‹åœ¨è·å–é”ä¹‹å‰ä¸å…è®¸æ‰§è¡Œè¯¥éƒ¨åˆ†çš„ä»£ç 

å¦å¤– java è¿˜æä¾›äº†æ˜¾å¼ç›‘è§†å™¨ (Lock) å’Œéšå¼ç›‘è§†å™¨ ( synchronized ) ä¸¤ç§é”æ–¹æ¡ˆ

#### å¦‚æœä½ æäº¤ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± é˜Ÿåˆ—å·²æ»¡ï¼Œè¿™æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ

è¿™é‡ŒåŒºåˆ†ä¸€ä¸‹ï¼š

ï¼ˆ1ï¼‰å¦‚æœä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueueï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—çš„è¯ï¼Œæ²¡å…³ç³»ï¼Œç»§ç»­æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼Œå› ä¸º LinkedBlockingQueue å¯ä»¥è¿‘ä¹è®¤ä¸ºæ˜¯ä¸€ä¸ªæ— ç©·å¤§çš„é˜Ÿåˆ—ï¼Œå¯ä»¥æ— é™å­˜æ”¾ä»»åŠ¡

ï¼ˆ2ï¼‰å¦‚æœä½¿ç”¨çš„æ˜¯æœ‰ç•Œé˜Ÿåˆ—æ¯”å¦‚ ArrayBlockingQueueï¼Œä»»åŠ¡é¦–å…ˆä¼šè¢«æ·»åŠ åˆ° ArrayBlockingQueue ä¸­ï¼ŒArrayBlockingQueue æ»¡äº†ï¼Œä¼šæ ¹æ® maximumPoolSize çš„å€¼å¢åŠ çº¿ç¨‹æ•°é‡ï¼Œå¦‚æœå¢åŠ äº†çº¿ç¨‹æ•°é‡è¿˜æ˜¯å¤„ç†ä¸è¿‡æ¥ï¼ŒArrayBlockingQueue ç»§ç»­æ»¡ï¼Œé‚£ä¹ˆåˆ™ä¼šä½¿ç”¨æ‹’ç»ç­–ç•¥ RejectedExecutionHandler å¤„ç†æ»¡äº†çš„ä»»åŠ¡ï¼Œé»˜è®¤æ˜¯ AbortPolicy

#### ä»€ä¹ˆå«çº¿ç¨‹å®‰å…¨ï¼Ÿservlet æ˜¯çº¿ç¨‹å®‰å…¨å—?

çº¿ç¨‹å®‰å…¨æ˜¯ç¼–ç¨‹ä¸­çš„æœ¯è¯­ï¼ŒæŒ‡æŸä¸ªæ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«è°ƒç”¨æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°å¤„ç†å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡ï¼Œä½¿ç¨‹åºåŠŸèƒ½æ­£ç¡®å®Œæˆã€‚

Servlet ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œservlet æ˜¯å•å®ä¾‹å¤šçº¿ç¨‹çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¸èƒ½ä¿è¯å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§çš„ã€‚

Struts2 çš„ action æ˜¯å¤šå®ä¾‹å¤šçº¿ç¨‹çš„ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½ä¼š new ä¸€ä¸ªæ–°çš„ action åˆ†é…ç»™è¿™ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚å®Œæˆåé”€æ¯ã€‚

SpringMVC çš„ Controller æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿä¸æ˜¯çš„ï¼Œå’Œ Servlet ç±»ä¼¼çš„å¤„ç†æµç¨‹ã€‚

Struts2 å¥½å¤„æ˜¯ä¸ç”¨è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›Servlet å’Œ SpringMVC éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½å¯ä»¥æå‡ä¸ç”¨å¤„ç†å¤ªå¤šçš„ gcï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal æ¥å¤„ç†å¤šçº¿ç¨‹çš„é—®é¢˜ã€‚

#### åœ¨ Java ç¨‹åºä¸­æ€ä¹ˆä¿è¯å¤šçº¿ç¨‹çš„è¿è¡Œå®‰å…¨ï¼Ÿ

*   æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®‰å…¨ç±»ï¼Œæ¯”å¦‚ java.util.concurrent ä¸‹çš„ç±»ï¼Œä½¿ç”¨åŸå­ç±» AtomicInteger
*   æ–¹æ³•äºŒï¼šä½¿ç”¨è‡ªåŠ¨é” synchronizedã€‚
*   æ–¹æ³•ä¸‰ï¼šä½¿ç”¨æ‰‹åŠ¨é” Lockã€‚

æ‰‹åŠ¨é” Java ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```
Lock lock = new ReentrantLock();
lock. lock();
try {
    System. out. println("è·å¾—é”");
} catch (Exception e) {
    // TODO: handle exception
} finally {
    System. out. println("é‡Šæ”¾é”");
    lock. unlock();
}
```

#### ä½ å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„ç†è§£æ˜¯ä»€ä¹ˆï¼Ÿ

æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå…·æœ‰ä¼˜å…ˆæƒï¼Œä½†è¿™ä¾èµ–äºçº¿ç¨‹è°ƒåº¦çš„å®ç°ï¼Œè¿™ä¸ªå®ç°æ˜¯å’Œæ“ä½œç³»ç»Ÿç›¸å…³çš„ (OS dependent)ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ä¿è¯é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¼šåœ¨ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å‰æ‰§è¡Œã€‚çº¿ç¨‹ä¼˜å…ˆçº§æ˜¯ä¸€ä¸ª int å˜é‡ (ä» 1-10)ï¼Œ1 ä»£è¡¨æœ€ä½ä¼˜å…ˆçº§ï¼Œ10 ä»£è¡¨æœ€é«˜ä¼˜å…ˆçº§ã€‚

Java çš„çº¿ç¨‹ä¼˜å…ˆçº§è°ƒåº¦ä¼šå§”æ‰˜ç»™æ“ä½œç³»ç»Ÿå»å¤„ç†ï¼Œæ‰€ä»¥ä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿä¼˜å…ˆçº§æœ‰å…³ï¼Œå¦‚éç‰¹åˆ«éœ€è¦ï¼Œä¸€èˆ¬æ— éœ€è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚

#### çº¿ç¨‹ç±»çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯è¢«å“ªä¸ªçº¿ç¨‹è°ƒç”¨çš„

è¿™æ˜¯ä¸€ä¸ªéå¸¸åˆé’»å’Œç‹¡çŒ¾çš„é—®é¢˜ã€‚è¯·è®°ä½ï¼šçº¿ç¨‹ç±»çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯è¢« new è¿™ä¸ªçº¿ç¨‹ç±»æ‰€åœ¨çš„çº¿ç¨‹æ‰€è°ƒç”¨çš„ï¼Œè€Œ run æ–¹æ³•é‡Œé¢çš„ä»£ç æ‰æ˜¯è¢«çº¿ç¨‹è‡ªèº«æ‰€è°ƒç”¨çš„ã€‚

å¦‚æœè¯´ä¸Šé¢çš„è¯´æ³•è®©ä½ æ„Ÿåˆ°å›°æƒ‘ï¼Œé‚£ä¹ˆæˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ Thread2 ä¸­ new äº† Thread1ï¼Œmain å‡½æ•°ä¸­ new äº† Thread2ï¼Œé‚£ä¹ˆï¼š

ï¼ˆ1ï¼‰Thread2 çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯ main çº¿ç¨‹è°ƒç”¨çš„ï¼ŒThread2 çš„ run() æ–¹æ³•æ˜¯ Thread2 è‡ªå·±è°ƒç”¨çš„

ï¼ˆ2ï¼‰Thread1 çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯ Thread2 è°ƒç”¨çš„ï¼ŒThread1 çš„ run() æ–¹æ³•æ˜¯ Thread1 è‡ªå·±è°ƒç”¨çš„

#### Java ä¸­æ€ä¹ˆè·å–ä¸€ä»½çº¿ç¨‹ dump æ–‡ä»¶ï¼Ÿä½ å¦‚ä½•åœ¨ Java ä¸­è·å–çº¿ç¨‹å †æ ˆï¼Ÿ

Dump æ–‡ä»¶æ˜¯è¿›ç¨‹çš„å†…å­˜é•œåƒã€‚å¯ä»¥æŠŠç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€é€šè¿‡è°ƒè¯•å™¨ä¿å­˜åˆ° dump æ–‡ä»¶ä¸­ã€‚

åœ¨ Linux ä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡å‘½ä»¤ kill -3 PID ï¼ˆJava è¿›ç¨‹çš„è¿›ç¨‹ IDï¼‰æ¥è·å– Java åº”ç”¨çš„ dump æ–‡ä»¶ã€‚

åœ¨ Windows ä¸‹ï¼Œä½ å¯ä»¥æŒ‰ä¸‹ Ctrl + Break æ¥è·å–ã€‚è¿™æ · JVM å°±ä¼šå°†çº¿ç¨‹çš„ dump æ–‡ä»¶æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºæˆ–é”™è¯¯æ–‡ä»¶ä¸­ï¼Œå®ƒå¯èƒ½æ‰“å°åœ¨æ§åˆ¶å°æˆ–è€…æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå…·ä½“ä½ç½®ä¾èµ–åº”ç”¨çš„é…ç½®ã€‚

#### ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ—¶å‘ç”Ÿå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ

å¦‚æœå¼‚å¸¸æ²¡æœ‰è¢«æ•è·è¯¥çº¿ç¨‹å°†ä¼šåœæ­¢æ‰§è¡Œã€‚Thread.UncaughtExceptionHandler æ˜¯ç”¨äºå¤„ç†æœªæ•è·å¼‚å¸¸é€ æˆçº¿ç¨‹çªç„¶ä¸­æ–­æƒ…å†µçš„ä¸€ä¸ªå†…åµŒæ¥å£ã€‚å½“ä¸€ä¸ªæœªæ•è·å¼‚å¸¸å°†é€ æˆçº¿ç¨‹ä¸­æ–­çš„æ—¶å€™ï¼ŒJVM ä¼šä½¿ç”¨ Thread.getUncaughtExceptionHandler() æ¥æŸ¥è¯¢çº¿ç¨‹çš„ UncaughtExceptionHandler å¹¶å°†çº¿ç¨‹å’Œå¼‚å¸¸ä½œä¸ºå‚æ•°ä¼ é€’ç»™ handler çš„ uncaughtException() æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

#### Java çº¿ç¨‹æ•°è¿‡å¤šä¼šé€ æˆä»€ä¹ˆå¼‚å¸¸ï¼Ÿ

*   çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¼€é”€éå¸¸é«˜
    
*   æ¶ˆè€—è¿‡å¤šçš„ CPU
    
    èµ„æºå¦‚æœå¯è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤šäºå¯ç”¨å¤„ç†å™¨çš„æ•°é‡ï¼Œé‚£ä¹ˆæœ‰çº¿ç¨‹å°†ä¼šè¢«é—²ç½®ã€‚å¤§é‡ç©ºé—²çš„çº¿ç¨‹ä¼šå ç”¨è®¸å¤šå†…å­˜ï¼Œç»™åƒåœ¾å›æ”¶å™¨å¸¦æ¥å‹åŠ›ï¼Œè€Œä¸”å¤§é‡çš„çº¿ç¨‹åœ¨ç«äº‰ CPU èµ„æºæ—¶è¿˜å°†äº§ç”Ÿå…¶ä»–æ€§èƒ½çš„å¼€é”€ã€‚
    
*   é™ä½ç¨³å®šæ€§ JVM
    
    åœ¨å¯åˆ›å»ºçº¿ç¨‹çš„æ•°é‡ä¸Šå­˜åœ¨ä¸€ä¸ªé™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶å€¼å°†éšç€å¹³å°çš„ä¸åŒè€Œä¸åŒï¼Œå¹¶ä¸”æ‰¿å—ç€å¤šä¸ªå› ç´ åˆ¶çº¦ï¼ŒåŒ…æ‹¬ JVM çš„å¯åŠ¨å‚æ•°ã€Thread æ„é€ å‡½æ•°ä¸­è¯·æ±‚æ ˆçš„å¤§å°ï¼Œä»¥åŠåº•å±‚æ“ä½œç³»ç»Ÿå¯¹çº¿ç¨‹çš„é™åˆ¶ç­‰ã€‚å¦‚æœç ´åäº†è¿™äº›é™åˆ¶ï¼Œé‚£ä¹ˆå¯èƒ½æŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚
    

å¹¶å‘ç†è®º
----

### Java å†…å­˜æ¨¡å‹

#### Java ä¸­åƒåœ¾å›æ”¶æœ‰ä»€ä¹ˆç›®çš„ï¼Ÿä»€ä¹ˆæ—¶å€™è¿›è¡Œåƒåœ¾å›æ”¶ï¼Ÿ

åƒåœ¾å›æ”¶æ˜¯åœ¨å†…å­˜ä¸­å­˜åœ¨æ²¡æœ‰å¼•ç”¨çš„å¯¹è±¡æˆ–è¶…è¿‡ä½œç”¨åŸŸçš„å¯¹è±¡æ—¶è¿›è¡Œçš„ã€‚

åƒåœ¾å›æ”¶çš„ç›®çš„æ˜¯è¯†åˆ«å¹¶ä¸”ä¸¢å¼ƒåº”ç”¨ä¸å†ä½¿ç”¨çš„å¯¹è±¡æ¥é‡Šæ”¾å’Œé‡ç”¨èµ„æºã€‚

#### å¦‚æœå¯¹è±¡çš„å¼•ç”¨è¢«ç½®ä¸º nullï¼Œåƒåœ¾æ”¶é›†å™¨æ˜¯å¦ä¼šç«‹å³é‡Šæ”¾å¯¹è±¡å ç”¨çš„å†…å­˜ï¼Ÿ

ä¸ä¼šï¼Œåœ¨ä¸‹ä¸€ä¸ªåƒåœ¾å›è°ƒå‘¨æœŸä¸­ï¼Œè¿™ä¸ªå¯¹è±¡å°†æ˜¯è¢«å¯å›æ”¶çš„ã€‚

ä¹Ÿå°±æ˜¯è¯´å¹¶ä¸ä¼šç«‹å³è¢«åƒåœ¾æ”¶é›†å™¨ç«‹åˆ»å›æ”¶ï¼Œè€Œæ˜¯åœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶æ‰ä¼šé‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ã€‚

#### finalize() æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Ÿææ„å‡½æ•° (finalization) çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ

1ï¼‰åƒåœ¾å›æ”¶å™¨ï¼ˆgarbage colectorï¼‰å†³å®šå›æ”¶æŸå¯¹è±¡æ—¶ï¼Œå°±ä¼šè¿è¡Œè¯¥å¯¹è±¡çš„ finalize() æ–¹æ³•ï¼›  
finalize æ˜¯ Object ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ Object ç±»ä¸­çš„å£°æ˜ protected void finalize() throws Throwable {}  
åœ¨åƒåœ¾å›æ”¶å™¨æ‰§è¡Œæ—¶ä¼šè°ƒç”¨è¢«å›æ”¶å¯¹è±¡çš„ finalize() æ–¹æ³•ï¼Œå¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æ¥å®ç°å¯¹å…¶èµ„æºçš„å›æ”¶ã€‚æ³¨æ„ï¼šä¸€æ—¦åƒåœ¾å›æ”¶å™¨å‡†å¤‡é‡Šæ”¾å¯¹è±¡å ç”¨çš„å†…å­˜ï¼Œå°†é¦–å…ˆè°ƒç”¨è¯¥å¯¹è±¡çš„ finalize() æ–¹æ³•ï¼Œå¹¶ä¸”ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶åŠ¨ä½œå‘ç”Ÿæ—¶ï¼Œæ‰çœŸæ­£å›æ”¶å¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´

2ï¼‰GC æœ¬æ¥å°±æ˜¯å†…å­˜å›æ”¶äº†ï¼Œåº”ç”¨è¿˜éœ€è¦åœ¨ finalization åšä»€ä¹ˆå‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯å¤§éƒ¨åˆ†æ—¶å€™ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åš (ä¹Ÿå°±æ˜¯ä¸éœ€è¦é‡è½½)ã€‚åªæœ‰åœ¨æŸäº›å¾ˆç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ä½ è°ƒç”¨äº†ä¸€äº› native çš„æ–¹æ³• (ä¸€èˆ¬æ˜¯ C å†™çš„)ï¼Œå¯ä»¥è¦åœ¨ finaliztion é‡Œå»è°ƒç”¨ C çš„é‡Šæ”¾å‡½æ•°ã€‚

### é‡æ’åºä¸æ•°æ®ä¾èµ–æ€§

#### ä¸ºä»€ä¹ˆä»£ç ä¼šé‡æ’åºï¼Ÿ

åœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æä¾›æ€§èƒ½ï¼Œå¤„ç†å™¨å’Œç¼–è¯‘å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯ä¸èƒ½éšæ„é‡æ’åºï¼Œä¸æ˜¯ä½ æƒ³æ€ä¹ˆæ’åºå°±æ€ä¹ˆæ’åºï¼Œå®ƒéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š

*   åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸èƒ½æ”¹å˜ç¨‹åºè¿è¡Œçš„ç»“æœï¼›
    
*   å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ä¸å…è®¸é‡æ’åº
    

éœ€è¦æ³¨æ„çš„æ˜¯ï¼šé‡æ’åºä¸ä¼šå½±å“å•çº¿ç¨‹ç¯å¢ƒçš„æ‰§è¡Œç»“æœï¼Œä½†æ˜¯ä¼šç ´åå¤šçº¿ç¨‹çš„æ‰§è¡Œè¯­ä¹‰ã€‚

### as-if-serial è§„åˆ™å’Œ happens-before è§„åˆ™çš„åŒºåˆ«

*   as-if-serial è¯­ä¹‰ä¿è¯å•çº¿ç¨‹å†…ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¢«æ”¹å˜ï¼Œhappens-before å…³ç³»ä¿è¯æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¢«æ”¹å˜ã€‚
    
*   as-if-serial è¯­ä¹‰ç»™ç¼–å†™å•çº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›é€ äº†ä¸€ä¸ªå¹»å¢ƒï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚happens-before å…³ç³»ç»™ç¼–å†™æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›é€ äº†ä¸€ä¸ªå¹»å¢ƒï¼šæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ happens-before æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚
    
*   as-if-serial è¯­ä¹‰å’Œ happens-before è¿™ä¹ˆåšçš„ç›®çš„ï¼Œéƒ½æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°æé«˜ç¨‹åºæ‰§è¡Œçš„å¹¶è¡Œåº¦ã€‚
    

å¹¶å‘å…³é”®å­—
-----

### synchronized

#### synchronized çš„ä½œç”¨ï¼Ÿ

åœ¨ Java ä¸­ï¼Œsynchronized å…³é”®å­—æ˜¯ç”¨æ¥æ§åˆ¶çº¿ç¨‹åŒæ­¥çš„ï¼Œå°±æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œæ§åˆ¶ synchronized ä»£ç æ®µä¸è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚synchronized å¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å˜é‡ã€‚

å¦å¤–ï¼Œåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œsynchronized å±äºé‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ Mutex Lock æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ—©æœŸçš„ synchronized æ•ˆç‡ä½çš„åŸå› ã€‚åº†å¹¸çš„æ˜¯åœ¨ Java 6 ä¹‹å Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹ synchronized è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ synchronized é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚

#### è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨ synchronized å…³é”®å­—ï¼Œåœ¨é¡¹ç›®ä¸­ç”¨åˆ°äº†å—

**synchronized å…³é”®å­—æœ€ä¸»è¦çš„ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š**

*   **ä¿®é¥°å®ä¾‹æ–¹æ³•:** ä½œç”¨äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å¯¹è±¡å®ä¾‹çš„é”
*   **ä¿®é¥°é™æ€æ–¹æ³•:** ä¹Ÿå°±æ˜¯ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ï¼Œå› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ï¼ˆ static è¡¨æ˜è¿™æ˜¯è¯¥ç±»çš„ä¸€ä¸ªé™æ€èµ„æºï¼Œä¸ç®¡ new äº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåªæœ‰ä¸€ä»½ï¼‰ã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ synchronized æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ synchronized æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œ**å› ä¸ºè®¿é—®é™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”**ã€‚
*   **ä¿®é¥°ä»£ç å—:** æŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚

**æ€»ç»“ï¼š** synchronized å…³é”®å­—åŠ åˆ° static é™æ€æ–¹æ³•å’Œ synchronized(class) ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ã€‚synchronized å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ã€‚å°½é‡ä¸è¦ä½¿ç”¨ synchronized(String a) å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ï¼

ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ synchronized å…³é”®å­—çš„å…·ä½“ä½¿ç”¨ã€‚

é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€

**åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**

```
public class Singleton {

    private volatile static Singleton uniqueInstance;

    private Singleton() {
    }

    public static Singleton getUniqueInstance() {
       //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç 
        if (uniqueInstance == null) {
            //ç±»å¯¹è±¡åŠ é”
            synchronized (Singleton.class) {
                if (uniqueInstance == null) {
                    uniqueInstance = new Singleton();
                }
            }
        }
        return uniqueInstance;
    }
}
```

å¦å¤–ï¼Œéœ€è¦æ³¨æ„ uniqueInstance é‡‡ç”¨ volatile å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ã€‚

uniqueInstance é‡‡ç”¨ volatile å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ uniqueInstance = new Singleton(); è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š

1.  ä¸º uniqueInstance åˆ†é…å†…å­˜ç©ºé—´
2.  åˆå§‹åŒ– uniqueInstance
3.  å°† uniqueInstance æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€

ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1->3->2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ getUniqueInstance() åå‘ç° uniqueInstance ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› uniqueInstanceï¼Œä½†æ­¤æ—¶ uniqueInstance è¿˜æœªè¢«åˆå§‹åŒ–ã€‚

ä½¿ç”¨ volatile å¯ä»¥ç¦æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚

#### è¯´ä¸€ä¸‹ synchronized åº•å±‚å®ç°åŸç†ï¼Ÿ

synchronized æ˜¯ Java ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°æ˜¾ç¤ºçš„åŠ é”å’Œè§£é”è¿‡ç¨‹ã€‚å› æ­¤æœ‰å¿…è¦é€šè¿‡ javap å‘½ä»¤ï¼ŒæŸ¥çœ‹ç›¸åº”çš„å­—èŠ‚ç æ–‡ä»¶ã€‚

synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}
```

é€šè¿‡ JDK åæ±‡ç¼–æŒ‡ä»¤ javap -c -v SynchronizedDemo

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS8xMS8yNS8xNmVhMDQ3NGY5ODYyMzE5?x-oss-process=image/format,png)

å¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒåŒæ­¥ä»£ç å—ä¹‹å‰ä¹‹åéƒ½æœ‰ä¸€ä¸ª monitor å­—æ ·ï¼Œå…¶ä¸­å‰é¢çš„æ˜¯ monitorenterï¼Œåé¢çš„æ˜¯ç¦»å¼€ monitorexitï¼Œä¸éš¾æƒ³è±¡ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œé¦–å…ˆè¦è·å–é”ï¼Œè€Œè·å–é”çš„è¿‡ç¨‹å°±æ˜¯ monitorenterï¼Œåœ¨æ‰§è¡Œå®Œä»£ç å—ä¹‹åï¼Œè¦é‡Šæ”¾é”ï¼Œé‡Šæ”¾é”å°±æ˜¯æ‰§è¡Œ monitorexit æŒ‡ä»¤ã€‚

ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ª monitorexit å‘¢ï¼Ÿ

è¿™ä¸ªä¸»è¦æ˜¯é˜²æ­¢åœ¨åŒæ­¥ä»£ç å—ä¸­çº¿ç¨‹å› å¼‚å¸¸é€€å‡ºï¼Œè€Œé”æ²¡æœ‰å¾—åˆ°é‡Šæ”¾ï¼Œè¿™å¿…ç„¶ä¼šé€ æˆæ­»é”ï¼ˆç­‰å¾…çš„çº¿ç¨‹æ°¸è¿œè·å–ä¸åˆ°é”ï¼‰ã€‚å› æ­¤æœ€åä¸€ä¸ª monitorexit æ˜¯ä¿è¯åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œé”ä¹Ÿå¯ä»¥å¾—åˆ°é‡Šæ”¾ï¼Œé¿å…æ­»é”ã€‚  
ä»…æœ‰ ACC_SYNCHRONIZED è¿™ä¹ˆä¸€ä¸ªæ ‡å¿—ï¼Œè¯¥æ ‡è®°è¡¨æ˜çº¿ç¨‹è¿›å…¥è¯¥æ–¹æ³•æ—¶ï¼Œéœ€è¦ monitorenterï¼Œé€€å‡ºè¯¥æ–¹æ³•æ—¶éœ€è¦ monitorexitã€‚

synchronized å¯é‡å…¥çš„åŸç†

é‡å…¥é”æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°è¯¥é”ä¹‹åï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­è·å¾—è¯¥é”ã€‚åº•å±‚åŸç†ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“çº¿ç¨‹è·å–è¯¥é”æ—¶ï¼Œè®¡æ•°å™¨åŠ ä¸€ï¼Œå†æ¬¡è·å¾—è¯¥é”æ—¶ç»§ç»­åŠ ä¸€ï¼Œé‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨å‡ä¸€ï¼Œå½“è®¡æ•°å™¨å€¼ä¸º 0 æ—¶ï¼Œè¡¨æ˜è¯¥é”æœªè¢«ä»»ä½•çº¿ç¨‹æ‰€æŒæœ‰ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥ç«äº‰è·å–é”ã€‚

#### ä»€ä¹ˆæ˜¯è‡ªæ—‹

å¾ˆå¤š synchronized é‡Œé¢çš„ä»£ç åªæ˜¯ä¸€äº›å¾ˆç®€å•çš„ä»£ç ï¼Œæ‰§è¡Œæ—¶é—´éå¸¸å¿«ï¼Œæ­¤æ—¶ç­‰å¾…çš„çº¿ç¨‹éƒ½åŠ é”å¯èƒ½æ˜¯ä¸€ç§ä¸å¤ªå€¼å¾—çš„æ“ä½œï¼Œå› ä¸ºçº¿ç¨‹é˜»å¡æ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„é—®é¢˜ã€‚æ—¢ç„¶ synchronized é‡Œé¢çš„ä»£ç æ‰§è¡Œå¾—éå¸¸å¿«ï¼Œä¸å¦¨è®©ç­‰å¾…é”çš„çº¿ç¨‹ä¸è¦è¢«é˜»å¡ï¼Œè€Œæ˜¯åœ¨ synchronized çš„è¾¹ç•Œåšå¿™å¾ªç¯ï¼Œè¿™å°±æ˜¯è‡ªæ—‹ã€‚å¦‚æœåšäº†å¤šæ¬¡å¾ªç¯å‘ç°è¿˜æ²¡æœ‰è·å¾—é”ï¼Œå†é˜»å¡ï¼Œè¿™æ ·å¯èƒ½æ˜¯ä¸€ç§æ›´å¥½çš„ç­–ç•¥ã€‚

#### å¤šçº¿ç¨‹ä¸­ synchronized é”å‡çº§çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

synchronized é”å‡çº§åŸç†ï¼šåœ¨é”å¯¹è±¡çš„å¯¹è±¡å¤´é‡Œé¢æœ‰ä¸€ä¸ª threadid å­—æ®µï¼Œåœ¨ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™ threadid ä¸ºç©ºï¼Œjvm è®©å…¶æŒæœ‰åå‘é”ï¼Œå¹¶å°† threadid è®¾ç½®ä¸ºå…¶çº¿ç¨‹ idï¼Œå†æ¬¡è¿›å…¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­ threadid æ˜¯å¦ä¸å…¶çº¿ç¨‹ id ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨æ­¤å¯¹è±¡ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™å‡çº§åå‘é”ä¸ºè½»é‡çº§é”ï¼Œé€šè¿‡è‡ªæ—‹å¾ªç¯ä¸€å®šæ¬¡æ•°æ¥è·å–é”ï¼Œæ‰§è¡Œä¸€å®šæ¬¡æ•°ä¹‹åï¼Œå¦‚æœè¿˜æ²¡æœ‰æ­£å¸¸è·å–åˆ°è¦ä½¿ç”¨çš„å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¼šæŠŠé”ä»è½»é‡çº§å‡çº§ä¸ºé‡é‡çº§é”ï¼Œæ­¤è¿‡ç¨‹å°±æ„æˆäº† synchronized é”çš„å‡çº§ã€‚

é”çš„å‡çº§çš„ç›®çš„ï¼šé”å‡çº§æ˜¯ä¸ºäº†å‡ä½äº†é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚åœ¨ Java 6 ä¹‹åä¼˜åŒ– synchronized çš„å®ç°æ–¹å¼ï¼Œä½¿ç”¨äº†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”å†å‡çº§åˆ°é‡é‡çº§é”çš„æ–¹å¼ï¼Œä»è€Œå‡ä½äº†é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚

#### çº¿ç¨‹ B æ€ä¹ˆçŸ¥é“çº¿ç¨‹ A ä¿®æ”¹äº†å˜é‡

ï¼ˆ1ï¼‰volatile ä¿®é¥°å˜é‡

ï¼ˆ2ï¼‰synchronized ä¿®é¥°ä¿®æ”¹å˜é‡çš„æ–¹æ³•

ï¼ˆ3ï¼‰wait/notify

ï¼ˆ4ï¼‰while è½®è¯¢

#### å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸€ä¸ªå¯¹è±¡çš„ synchronized æ–¹æ³• A ä¹‹åï¼Œå…¶å®ƒçº¿ç¨‹æ˜¯å¦å¯è¿›å…¥æ­¤å¯¹è±¡çš„ synchronized æ–¹æ³• Bï¼Ÿ

ä¸èƒ½ã€‚å…¶å®ƒçº¿ç¨‹åªèƒ½è®¿é—®è¯¥å¯¹è±¡çš„éåŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥æ–¹æ³•åˆ™ä¸èƒ½è¿›å…¥ã€‚å› ä¸ºéé™æ€æ–¹æ³•ä¸Šçš„ synchronized ä¿®é¥°ç¬¦è¦æ±‚æ‰§è¡Œæ–¹æ³•æ—¶è¦è·å¾—å¯¹è±¡çš„é”ï¼Œå¦‚æœå·²ç»è¿›å…¥ A æ–¹æ³•è¯´æ˜å¯¹è±¡é”å·²ç»è¢«å–èµ°ï¼Œé‚£ä¹ˆè¯•å›¾è¿›å…¥ B æ–¹æ³•çš„çº¿ç¨‹å°±åªèƒ½åœ¨ç­‰é”æ± ï¼ˆæ³¨æ„ä¸æ˜¯ç­‰å¾…æ± å“¦ï¼‰ä¸­ç­‰å¾…å¯¹è±¡çš„é”ã€‚

#### synchronizedã€volatileã€CAS æ¯”è¾ƒ

ï¼ˆ1ï¼‰synchronized æ˜¯æ‚²è§‚é”ï¼Œå±äºæŠ¢å å¼ï¼Œä¼šå¼•èµ·å…¶ä»–çº¿ç¨‹é˜»å¡ã€‚

ï¼ˆ2ï¼‰volatile æä¾›å¤šçº¿ç¨‹å…±äº«å˜é‡å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚

ï¼ˆ3ï¼‰CAS æ˜¯åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚é”ï¼ˆéé˜»å¡ï¼‰

#### synchronized å’Œ Lock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

*   é¦–å…ˆ synchronized æ˜¯ Java å†…ç½®å…³é”®å­—ï¼Œåœ¨ JVM å±‚é¢ï¼ŒLock æ˜¯ä¸ª Java ç±»ï¼›
*   synchronized å¯ä»¥ç»™ç±»ã€æ–¹æ³•ã€ä»£ç å—åŠ é”ï¼›è€Œ lock åªèƒ½ç»™ä»£ç å—åŠ é”ã€‚
*   synchronized ä¸éœ€è¦æ‰‹åŠ¨è·å–é”å’Œé‡Šæ”¾é”ï¼Œä½¿ç”¨ç®€å•ï¼Œå‘ç”Ÿå¼‚å¸¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œä¸ä¼šé€ æˆæ­»é”ï¼›è€Œ lock éœ€è¦è‡ªå·±åŠ é”å’Œé‡Šæ”¾é”ï¼Œå¦‚æœä½¿ç”¨ä¸å½“æ²¡æœ‰ unLock() å»é‡Šæ”¾é”å°±ä¼šé€ æˆæ­»é”ã€‚
*   é€šè¿‡ Lock å¯ä»¥çŸ¥é“æœ‰æ²¡æœ‰æˆåŠŸè·å–é”ï¼Œè€Œ synchronized å´æ— æ³•åŠåˆ°ã€‚

#### synchronized å’Œ ReentrantLock åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

synchronized æ˜¯å’Œ ifã€elseã€forã€while ä¸€æ ·çš„å…³é”®å­—ï¼ŒReentrantLock æ˜¯ç±»ï¼Œè¿™æ˜¯äºŒè€…çš„æœ¬è´¨åŒºåˆ«ã€‚æ—¢ç„¶ ReentrantLock æ˜¯ç±»ï¼Œé‚£ä¹ˆå®ƒå°±æä¾›äº†æ¯” synchronized æ›´å¤šæ›´çµæ´»çš„ç‰¹æ€§ï¼Œå¯ä»¥è¢«ç»§æ‰¿ã€å¯ä»¥æœ‰æ–¹æ³•ã€å¯ä»¥æœ‰å„ç§å„æ ·çš„ç±»å˜é‡

synchronized æ—©æœŸçš„å®ç°æ¯”è¾ƒä½æ•ˆï¼Œå¯¹æ¯” ReentrantLockï¼Œå¤§å¤šæ•°åœºæ™¯æ€§èƒ½éƒ½ç›¸å·®è¾ƒå¤§ï¼Œä½†æ˜¯åœ¨ Java 6 ä¸­å¯¹ synchronized è¿›è¡Œäº†éå¸¸å¤šçš„æ”¹è¿›ã€‚

ç›¸åŒç‚¹ï¼šä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”ã€‚â€œå¯é‡å…¥é”â€ æ¦‚å¿µæ˜¯ï¼šè‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœä¸å¯é”é‡å…¥çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢ 1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º 0 æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚

ä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š

*   ReentrantLock ä½¿ç”¨èµ·æ¥æ¯”è¾ƒçµæ´»ï¼Œä½†æ˜¯å¿…é¡»æœ‰é‡Šæ”¾é”çš„é…åˆåŠ¨ä½œï¼›
*   ReentrantLock å¿…é¡»æ‰‹åŠ¨è·å–ä¸é‡Šæ”¾é”ï¼Œè€Œ synchronized ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾å’Œå¼€å¯é”ï¼›
*   ReentrantLock åªé€‚ç”¨äºä»£ç å—é”ï¼Œè€Œ synchronized å¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å˜é‡ç­‰ã€‚
*   äºŒè€…çš„é”æœºåˆ¶å…¶å®ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚ReentrantLock åº•å±‚è°ƒç”¨çš„æ˜¯ Unsafe çš„ park æ–¹æ³•åŠ é”ï¼Œsynchronized æ“ä½œçš„åº”è¯¥æ˜¯å¯¹è±¡å¤´ä¸­ mark word

Java ä¸­æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼Œè¿™æ˜¯ synchronized å®ç°åŒæ­¥çš„åŸºç¡€ï¼š

*   æ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡
*   é™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„ class å¯¹è±¡
*   åŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯æ‹¬å·é‡Œé¢çš„å¯¹è±¡

### volatile

#### volatile å…³é”®å­—çš„ä½œç”¨

å¯¹äºå¯è§æ€§ï¼ŒJava æä¾›äº† volatile å…³é”®å­—æ¥ä¿è¯å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚ volatile æä¾› happens-before çš„ä¿è¯ï¼Œç¡®ä¿ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹èƒ½å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚å½“ä¸€ä¸ªå…±äº«å˜é‡è¢« volatile ä¿®é¥°æ—¶ï¼Œå®ƒä¼šä¿è¯ä¿®æ”¹çš„å€¼ä¼šç«‹å³è¢«æ›´æ–°åˆ°ä¸»å­˜ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¼šå»å†…å­˜ä¸­è¯»å–æ–°å€¼ã€‚

ä»å®è·µè§’åº¦è€Œè¨€ï¼Œvolatile çš„ä¸€ä¸ªé‡è¦ä½œç”¨å°±æ˜¯å’Œ CAS ç»“åˆï¼Œä¿è¯äº†åŸå­æ€§ï¼Œè¯¦ç»†çš„å¯ä»¥å‚è§ java.util.concurrent.atomic åŒ…ä¸‹çš„ç±»ï¼Œæ¯”å¦‚ AtomicIntegerã€‚

volatile å¸¸ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å•æ¬¡æ“ä½œ (å•æ¬¡è¯»æˆ–è€…å•æ¬¡å†™)ã€‚

#### Java ä¸­èƒ½åˆ›å»º volatile æ•°ç»„å—ï¼Ÿ

èƒ½ï¼ŒJava ä¸­å¯ä»¥åˆ›å»º volatile ç±»å‹æ•°ç»„ï¼Œä¸è¿‡åªæ˜¯ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°ç»„ã€‚æ„æ€æ˜¯ï¼Œå¦‚æœæ”¹å˜å¼•ç”¨æŒ‡å‘çš„æ•°ç»„ï¼Œå°†ä¼šå—åˆ° volatile çš„ä¿æŠ¤ï¼Œä½†æ˜¯å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ”¹å˜æ•°ç»„çš„å…ƒç´ ï¼Œvolatile æ ‡ç¤ºç¬¦å°±ä¸èƒ½èµ·åˆ°ä¹‹å‰çš„ä¿æŠ¤ä½œç”¨äº†ã€‚

#### volatile å˜é‡å’Œ atomic å˜é‡æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

volatile å˜é‡å¯ä»¥ç¡®ä¿å…ˆè¡Œå…³ç³»ï¼Œå³å†™æ“ä½œä¼šå‘ç”Ÿåœ¨åç»­çš„è¯»æ“ä½œä¹‹å‰, ä½†å®ƒå¹¶ä¸èƒ½ä¿è¯åŸå­æ€§ã€‚ä¾‹å¦‚ç”¨ volatile ä¿®é¥° count å˜é‡ï¼Œé‚£ä¹ˆ count++ æ“ä½œå°±ä¸æ˜¯åŸå­æ€§çš„ã€‚

è€Œ AtomicInteger ç±»æä¾›çš„ atomic æ–¹æ³•å¯ä»¥è®©è¿™ç§æ“ä½œå…·æœ‰åŸå­æ€§å¦‚ getAndIncrement() æ–¹æ³•ä¼šåŸå­æ€§çš„è¿›è¡Œå¢é‡æ“ä½œæŠŠå½“å‰å€¼åŠ ä¸€ï¼Œå…¶å®ƒæ•°æ®ç±»å‹å’Œå¼•ç”¨å˜é‡ä¹Ÿå¯ä»¥è¿›è¡Œç›¸ä¼¼æ“ä½œã€‚

#### volatile èƒ½ä½¿å¾—ä¸€ä¸ªéåŸå­æ“ä½œå˜æˆåŸå­æ“ä½œå—ï¼Ÿ

å…³é”®å­— volatile çš„ä¸»è¦ä½œç”¨æ˜¯ä½¿å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹é—´å¯è§ï¼Œä½†æ— æ³•ä¿è¯åŸå­æ€§ï¼Œå¯¹äºå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå®ä¾‹å˜é‡éœ€è¦åŠ é”è¿›è¡ŒåŒæ­¥ã€‚

è™½ç„¶ volatile åªèƒ½ä¿è¯å¯è§æ€§ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä½†ç”¨ volatile ä¿®é¥° long å’Œ double å¯ä»¥ä¿è¯å…¶æ“ä½œåŸå­æ€§ã€‚

æ‰€ä»¥ä» Oracle Java Spec é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼š

*   å¯¹äº 64 ä½çš„ long å’Œ doubleï¼Œå¦‚æœæ²¡æœ‰è¢« volatile ä¿®é¥°ï¼Œé‚£ä¹ˆå¯¹å…¶æ“ä½œå¯ä»¥ä¸æ˜¯åŸå­çš„ã€‚åœ¨æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥åˆ†æˆä¸¤æ­¥ï¼Œæ¯æ¬¡å¯¹ 32 ä½æ“ä½œã€‚
*   å¦‚æœä½¿ç”¨ volatile ä¿®é¥° long å’Œ doubleï¼Œé‚£ä¹ˆå…¶è¯»å†™éƒ½æ˜¯åŸå­æ“ä½œ
*   å¯¹äº 64 ä½çš„å¼•ç”¨åœ°å€çš„è¯»å†™ï¼Œéƒ½æ˜¯åŸå­æ“ä½œ
*   åœ¨å®ç° JVM æ—¶ï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©æ˜¯å¦æŠŠè¯»å†™ long å’Œ double ä½œä¸ºåŸå­æ“ä½œ
*   æ¨è JVM å®ç°ä¸ºåŸå­æ“ä½œ

#### volatile ä¿®é¥°ç¬¦çš„æœ‰è¿‡ä»€ä¹ˆå®è·µï¼Ÿ

å•ä¾‹æ¨¡å¼

æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šæ˜¯

æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯

å®ç°éš¾åº¦ï¼šè¾ƒå¤æ‚

æè¿°ï¼šå¯¹äº Double-Check è¿™ç§å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼ˆå½“ç„¶è¿™ç§æ¦‚ç‡å·²ç»éå¸¸å°äº†ï¼Œä½†æ¯•ç«Ÿè¿˜æ˜¯æœ‰çš„å˜›~ï¼‰ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ï¼šåªéœ€è¦ç»™ instance çš„å£°æ˜åŠ ä¸Š volatile å…³é”®å­—å³å¯ volatile å…³é”®å­—çš„ä¸€ä¸ªä½œç”¨æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼ŒæŠŠ instance å£°æ˜ä¸º volatile ä¹‹åï¼Œå¯¹å®ƒçš„å†™æ“ä½œå°±ä¼šæœ‰ä¸€ä¸ªå†…å­˜å±éšœï¼ˆä»€ä¹ˆæ˜¯å†…å­˜å±éšœï¼Ÿï¼‰ï¼Œè¿™æ ·ï¼Œåœ¨å®ƒçš„èµ‹å€¼å®Œæˆä¹‹å‰ï¼Œå°±ä¸ç”¨ä¼šè°ƒç”¨è¯»æ“ä½œã€‚æ³¨æ„ï¼švolatile é˜»æ­¢çš„ä¸æ˜¯ singleton = newSingleton() è¿™å¥è¯å†…éƒ¨ [1-2-3] çš„æŒ‡ä»¤é‡æ’ï¼Œè€Œæ˜¯ä¿è¯äº†åœ¨ä¸€ä¸ªå†™æ“ä½œï¼ˆ[1-2-3]ï¼‰å®Œæˆä¹‹å‰ï¼Œä¸ä¼šè°ƒç”¨è¯»æ“ä½œï¼ˆif (instance == null)ï¼‰ã€‚

```
public class Singleton7 {

    private static volatile Singleton7 instance = null;

    private Singleton7() {}

    public static Singleton7 getInstance() {
        if (instance == null) {
            synchronized (Singleton7.class) {
                if (instance == null) {
                    instance = new Singleton7();
                }
            }
        }

        return instance;
    }

}
```

#### synchronized å’Œ volatile çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

synchronized è¡¨ç¤ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–ä½œç”¨å¯¹è±¡çš„é”ï¼Œæ‰§è¡Œä»£ç ï¼Œé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚

volatile è¡¨ç¤ºå˜é‡åœ¨ CPU çš„å¯„å­˜å™¨ä¸­æ˜¯ä¸ç¡®å®šçš„ï¼Œå¿…é¡»ä»ä¸»å­˜ä¸­è¯»å–ã€‚ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å˜é‡çš„å¯è§æ€§ï¼›ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚

**åŒºåˆ«**

*   volatile æ˜¯å˜é‡ä¿®é¥°ç¬¦ï¼›synchronized å¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å˜é‡ã€‚
    
*   volatile ä»…èƒ½å®ç°å˜é‡çš„ä¿®æ”¹å¯è§æ€§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ï¼›è€Œ synchronized åˆ™å¯ä»¥ä¿è¯å˜é‡çš„ä¿®æ”¹å¯è§æ€§å’ŒåŸå­æ€§ã€‚
    
*   volatile ä¸ä¼šé€ æˆçº¿ç¨‹çš„é˜»å¡ï¼›synchronized å¯èƒ½ä¼šé€ æˆçº¿ç¨‹çš„é˜»å¡ã€‚
    
*   volatile æ ‡è®°çš„å˜é‡ä¸ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼›synchronized æ ‡è®°çš„å˜é‡å¯ä»¥è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚
    
*   **volatile å…³é”®å­—**æ˜¯çº¿ç¨‹åŒæ­¥çš„**è½»é‡çº§å®ç°**ï¼Œæ‰€ä»¥ **volatile æ€§èƒ½è‚¯å®šæ¯” synchronized å…³é”®å­—è¦å¥½**ã€‚ä½†æ˜¯ **volatile å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ synchronized å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å—**ã€‚synchronized å…³é”®å­—åœ¨ JavaSE1.6 ä¹‹åè¿›è¡Œäº†ä¸»è¦åŒ…æ‹¬ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—è€Œå¼•å…¥çš„åå‘é”å’Œè½»é‡çº§é”ä»¥åŠå…¶å®ƒå„ç§ä¼˜åŒ–ä¹‹åæ‰§è¡Œæ•ˆç‡æœ‰äº†æ˜¾è‘—æå‡ï¼Œ**å®é™…å¼€å‘ä¸­ä½¿ç”¨ synchronized å…³é”®å­—çš„åœºæ™¯è¿˜æ˜¯æ›´å¤šä¸€äº›**ã€‚
    

### final

#### ä»€ä¹ˆæ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œå®ƒå¯¹å†™å¹¶å‘åº”ç”¨æœ‰ä»€ä¹ˆå¸®åŠ©ï¼Ÿ

ä¸å¯å˜å¯¹è±¡ (Immutable Objects) å³å¯¹è±¡ä¸€æ—¦è¢«åˆ›å»ºå®ƒçš„çŠ¶æ€ï¼ˆå¯¹è±¡çš„æ•°æ®ï¼Œä¹Ÿå³å¯¹è±¡å±æ€§å€¼ï¼‰å°±ä¸èƒ½æ”¹å˜ï¼Œåä¹‹å³ä¸ºå¯å˜å¯¹è±¡ (Mutable Objects)ã€‚

ä¸å¯å˜å¯¹è±¡çš„ç±»å³ä¸ºä¸å¯å˜ç±» (Immutable Class)ã€‚Java å¹³å°ç±»åº“ä¸­åŒ…å«è®¸å¤šä¸å¯å˜ç±»ï¼Œå¦‚ Stringã€åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»ã€BigInteger å’Œ BigDecimal ç­‰ã€‚

åªæœ‰æ»¡è¶³å¦‚ä¸‹çŠ¶æ€ï¼Œä¸€ä¸ªå¯¹è±¡æ‰æ˜¯ä¸å¯å˜çš„ï¼›

*   å®ƒçš„çŠ¶æ€ä¸èƒ½åœ¨åˆ›å»ºåå†è¢«ä¿®æ”¹ï¼›
    
*   æ‰€æœ‰åŸŸéƒ½æ˜¯ final ç±»å‹ï¼›å¹¶ä¸”ï¼Œå®ƒè¢«æ­£ç¡®åˆ›å»ºï¼ˆåˆ›å»ºæœŸé—´æ²¡æœ‰å‘ç”Ÿ this å¼•ç”¨çš„é€¸å‡ºï¼‰ã€‚
    

ä¸å¯å˜å¯¹è±¡ä¿è¯äº†å¯¹è±¡çš„å†…å­˜å¯è§æ€§ï¼Œå¯¹ä¸å¯å˜å¯¹è±¡çš„è¯»å–ä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥æ‰‹æ®µï¼Œæå‡äº†ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚

Lock ä½“ç³»
-------

### Lock ç®€ä»‹ä¸åˆè¯† AQS

#### Java Concurrency API ä¸­çš„ Lock æ¥å£ (Lock interface) æ˜¯ä»€ä¹ˆï¼Ÿå¯¹æ¯”åŒæ­¥å®ƒæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

Lock æ¥å£æ¯”åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥å—æä¾›äº†æ›´å…·æ‰©å±•æ€§çš„é”æ“ä½œã€‚ä»–ä»¬å…è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯ä»¥å…·æœ‰å®Œå…¨ä¸åŒçš„æ€§è´¨ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒå¤šä¸ªç›¸å…³ç±»çš„æ¡ä»¶å¯¹è±¡ã€‚

å®ƒçš„ä¼˜åŠ¿æœ‰ï¼š

ï¼ˆ1ï¼‰å¯ä»¥ä½¿é”æ›´å…¬å¹³

ï¼ˆ2ï¼‰å¯ä»¥ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™å“åº”ä¸­æ–­

ï¼ˆ3ï¼‰å¯ä»¥è®©çº¿ç¨‹å°è¯•è·å–é”ï¼Œå¹¶åœ¨æ— æ³•è·å–é”çš„æ—¶å€™ç«‹å³è¿”å›æˆ–è€…ç­‰å¾…ä¸€æ®µæ—¶é—´

ï¼ˆ4ï¼‰å¯ä»¥åœ¨ä¸åŒçš„èŒƒå›´ï¼Œä»¥ä¸åŒçš„é¡ºåºè·å–å’Œé‡Šæ”¾é”

æ•´ä½“ä¸Šæ¥è¯´ Lock æ˜¯ synchronized çš„æ‰©å±•ç‰ˆï¼ŒLock æä¾›äº†æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„ (tryLock æ–¹æ³•)ã€å®šæ—¶çš„ (tryLock å¸¦å‚æ–¹æ³•)ã€å¯ä¸­æ–­çš„ (lockInterruptibly)ã€å¯å¤šæ¡ä»¶é˜Ÿåˆ—çš„ (newCondition æ–¹æ³•) é”æ“ä½œã€‚å¦å¤– Lock çš„å®ç°ç±»åŸºæœ¬éƒ½æ”¯æŒéå…¬å¹³é” (é»˜è®¤) å’Œå…¬å¹³é”ï¼Œsynchronized åªæ”¯æŒéå…¬å¹³é”ï¼Œå½“ç„¶ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéå…¬å¹³é”æ˜¯é«˜æ•ˆçš„é€‰æ‹©ã€‚

#### ä¹è§‚é”å’Œæ‚²è§‚é”çš„ç†è§£åŠå¦‚ä½•å®ç°ï¼Œæœ‰å“ªäº›å®ç°æ–¹å¼ï¼Ÿ

æ‚²è§‚é”ï¼šæ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ç›´åˆ°å®ƒæ‹¿åˆ°é”ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“é‡Œè¾¹å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚å†æ¯”å¦‚ Java é‡Œé¢çš„åŒæ­¥åŸè¯­ synchronized å…³é”®å­—çš„å®ç°ä¹Ÿæ˜¯æ‚²è§‚é”ã€‚

ä¹è§‚é”ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·ç­‰æœºåˆ¶ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ï¼Œåƒæ•°æ®åº“æä¾›çš„ç±»ä¼¼äº write_condition æœºåˆ¶ï¼Œå…¶å®éƒ½æ˜¯æä¾›çš„ä¹è§‚é”ã€‚åœ¨ Java ä¸­ java.util.concurrent.atomic åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ CAS å®ç°çš„ã€‚

ä¹è§‚é”çš„å®ç°æ–¹å¼ï¼š

1ã€ä½¿ç”¨ç‰ˆæœ¬æ ‡è¯†æ¥ç¡®å®šè¯»åˆ°çš„æ•°æ®ä¸æäº¤æ—¶çš„æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚æäº¤åä¿®æ”¹ç‰ˆæœ¬æ ‡è¯†ï¼Œä¸ä¸€è‡´æ—¶å¯ä»¥é‡‡å–ä¸¢å¼ƒå’Œå†æ¬¡å°è¯•çš„ç­–ç•¥ã€‚

2ã€java ä¸­çš„ Compare and Swap å³ CASï¼Œå½“å¤šä¸ªçº¿ç¨‹å°è¯•ä½¿ç”¨ CAS åŒæ—¶æ›´æ–°åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹èƒ½æ›´æ–°å˜é‡çš„å€¼ï¼Œè€Œå…¶å®ƒçº¿ç¨‹éƒ½å¤±è´¥ï¼Œå¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯è¢«å‘ŠçŸ¥è¿™æ¬¡ç«äº‰ä¸­å¤±è´¥ï¼Œå¹¶å¯ä»¥å†æ¬¡å°è¯•ã€‚ CAS æ“ä½œä¸­åŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€”â€” éœ€è¦è¯»å†™çš„å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€è¿›è¡Œæ¯”è¾ƒçš„é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ‹Ÿå†™å…¥çš„æ–°å€¼ (B)ã€‚å¦‚æœå†…å­˜ä½ç½® V çš„å€¼ä¸é¢„æœŸåŸå€¼ A ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼ Bã€‚å¦åˆ™å¤„ç†å™¨ä¸åšä»»ä½•æ“ä½œã€‚

#### ä»€ä¹ˆæ˜¯ CAS

CAS æ˜¯ compare and swap çš„ç¼©å†™ï¼Œå³æˆ‘ä»¬æ‰€è¯´çš„æ¯”è¾ƒäº¤æ¢ã€‚

cas æ˜¯ä¸€ç§åŸºäºé”çš„æ“ä½œï¼Œè€Œä¸”æ˜¯ä¹è§‚é”ã€‚åœ¨ java ä¸­é”åˆ†ä¸ºä¹è§‚é”å’Œæ‚²è§‚é”ã€‚æ‚²è§‚é”æ˜¯å°†èµ„æºé”ä½ï¼Œç­‰ä¸€ä¸ªä¹‹å‰è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰å¯ä»¥è®¿é—®ã€‚è€Œä¹è§‚é”é‡‡å–äº†ä¸€ç§å®½æ³›çš„æ€åº¦ï¼Œé€šè¿‡æŸç§æ–¹å¼ä¸åŠ é”æ¥å¤„ç†èµ„æºï¼Œæ¯”å¦‚é€šè¿‡ç»™è®°å½•åŠ  version æ¥è·å–æ•°æ®ï¼Œæ€§èƒ½è¾ƒæ‚²è§‚é”æœ‰å¾ˆå¤§çš„æé«˜ã€‚

CAS æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€”â€” å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼ (B)ã€‚å¦‚æœå†…å­˜åœ°å€é‡Œé¢çš„å€¼å’Œ A çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±å°†å†…å­˜é‡Œé¢çš„å€¼æ›´æ–°æˆ Bã€‚CAS æ˜¯é€šè¿‡æ— é™å¾ªç¯æ¥è·å–æ•°æ®çš„ï¼Œè‹¥æœåœ¨ç¬¬ä¸€è½®å¾ªç¯ä¸­ï¼Œa çº¿ç¨‹è·å–åœ°å€é‡Œé¢çš„å€¼è¢« b çº¿ç¨‹ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆ a çº¿ç¨‹éœ€è¦è‡ªæ—‹ï¼Œåˆ°ä¸‹æ¬¡å¾ªç¯æ‰æœ‰å¯èƒ½æœºä¼šæ‰§è¡Œã€‚

java.util.concurrent.atomic åŒ…ä¸‹çš„ç±»å¤§å¤šæ˜¯ä½¿ç”¨ CAS æ“ä½œæ¥å®ç°çš„ (AtomicInteger,AtomicBoolean,AtomicLong)ã€‚

#### CAS çš„ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Ÿ

1ã€ABA é—®é¢˜ï¼š

æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹ one ä»å†…å­˜ä½ç½® V ä¸­å–å‡º Aï¼Œè¿™æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹ two ä¹Ÿä»å†…å­˜ä¸­å–å‡º Aï¼Œå¹¶ä¸” two è¿›è¡Œäº†ä¸€äº›æ“ä½œå˜æˆäº† Bï¼Œç„¶å two åˆå°† V ä½ç½®çš„æ•°æ®å˜æˆ Aï¼Œè¿™æ—¶å€™çº¿ç¨‹ one è¿›è¡Œ CAS æ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯ Aï¼Œç„¶å one æ“ä½œæˆåŠŸã€‚å°½ç®¡çº¿ç¨‹ one çš„ CAS æ“ä½œæˆåŠŸï¼Œä½†å¯èƒ½å­˜åœ¨æ½œè—çš„é—®é¢˜ã€‚ä» Java1.5 å¼€å§‹ JDK çš„ atomic åŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±» AtomicStampedReference æ¥è§£å†³ ABA é—®é¢˜ã€‚

2ã€å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ï¼š

å¯¹äºèµ„æºç«äº‰ä¸¥é‡ï¼ˆçº¿ç¨‹å†²çªä¸¥é‡ï¼‰çš„æƒ…å†µï¼ŒCAS è‡ªæ—‹çš„æ¦‚ç‡ä¼šæ¯”è¾ƒå¤§ï¼Œä»è€Œæµªè´¹æ›´å¤šçš„ CPU èµ„æºï¼Œæ•ˆç‡ä½äº synchronizedã€‚

3ã€åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œï¼š

å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚

#### ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ

å½“çº¿ç¨‹ A æŒæœ‰ç‹¬å é” aï¼Œå¹¶å°è¯•å»è·å–ç‹¬å é” b çš„åŒæ—¶ï¼Œçº¿ç¨‹ B æŒæœ‰ç‹¬å é” bï¼Œå¹¶å°è¯•è·å–ç‹¬å é” a çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå‘ç”Ÿ AB ä¸¤ä¸ªçº¿ç¨‹ç”±äºäº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œè€Œå‘ç”Ÿçš„é˜»å¡ç°è±¡ï¼Œæˆ‘ä»¬ç§°ä¸ºæ­»é”ã€‚

#### äº§ç”Ÿæ­»é”çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆé˜²æ­¢æ­»é”ï¼Ÿ

äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶ï¼š

1ã€äº’æ–¥æ¡ä»¶ï¼šæ‰€è°“äº’æ–¥å°±æ˜¯è¿›ç¨‹åœ¨æŸä¸€æ—¶é—´å†…ç‹¬å èµ„æºã€‚

2ã€è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚

3ã€ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚

4ã€å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

è¿™å››ä¸ªæ¡ä»¶æ˜¯æ­»é”çš„å¿…è¦æ¡ä»¶ï¼Œåªè¦ç³»ç»Ÿå‘ç”Ÿæ­»é”ï¼Œè¿™äº›æ¡ä»¶å¿…ç„¶æˆç«‹ï¼Œè€Œåªè¦ä¸Šè¿°æ¡ä»¶ä¹‹ ä¸€ä¸æ»¡è¶³ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚

ç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œ è§£é™¤æ­»é”ã€‚

é˜²æ­¢æ­»é”å¯ä»¥é‡‡ç”¨ä»¥ä¸‹çš„æ–¹æ³•ï¼š

*   å°½é‡ä½¿ç”¨ tryLock(long timeout, TimeUnit unit) çš„æ–¹æ³• (ReentrantLockã€ReentrantReadWriteLock)ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶å¯ä»¥é€€å‡ºé˜²æ­¢æ­»é”ã€‚
*   å°½é‡ä½¿ç”¨ Java. util. concurrent å¹¶å‘ç±»ä»£æ›¿è‡ªå·±æ‰‹å†™é”ã€‚
*   å°½é‡é™ä½é”çš„ä½¿ç”¨ç²’åº¦ï¼Œå°½é‡ä¸è¦å‡ ä¸ªåŠŸèƒ½ç”¨åŒä¸€æŠŠé”ã€‚
*   å°½é‡å‡å°‘åŒæ­¥çš„ä»£ç å—ã€‚

#### æ­»é”ä¸æ´»é”çš„åŒºåˆ«ï¼Œæ­»é”ä¸é¥¥é¥¿çš„åŒºåˆ«ï¼Ÿ

æ­»é”ï¼šæ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚

æ´»é”ï¼šä»»åŠ¡æˆ–è€…æ‰§è¡Œè€…æ²¡æœ‰è¢«é˜»å¡ï¼Œç”±äºæŸäº›æ¡ä»¶æ²¡æœ‰æ»¡è¶³ï¼Œå¯¼è‡´ä¸€ç›´é‡å¤å°è¯•ï¼Œå¤±è´¥ï¼Œå°è¯•ï¼Œå¤±è´¥ã€‚

æ´»é”å’Œæ­»é”çš„åŒºåˆ«åœ¨äºï¼Œå¤„äºæ´»é”çš„å®ä½“æ˜¯åœ¨ä¸æ–­çš„æ”¹å˜çŠ¶æ€ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ â€œæ´»â€ï¼Œ è€Œå¤„äºæ­»é”çš„å®ä½“è¡¨ç°ä¸ºç­‰å¾…ï¼›æ´»é”æœ‰å¯èƒ½è‡ªè¡Œè§£å¼€ï¼Œæ­»é”åˆ™ä¸èƒ½ã€‚

é¥¥é¥¿ï¼šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹å› ä¸ºç§ç§åŸå› æ— æ³•è·å¾—æ‰€éœ€è¦çš„èµ„æºï¼Œå¯¼è‡´ä¸€ç›´æ— æ³•æ‰§è¡Œçš„çŠ¶æ€ã€‚

Java ä¸­å¯¼è‡´é¥¥é¥¿çš„åŸå› ï¼š

1ã€é«˜ä¼˜å…ˆçº§çº¿ç¨‹åå™¬æ‰€æœ‰çš„ä½ä¼˜å…ˆçº§çº¿ç¨‹çš„ CPU æ—¶é—´ã€‚

2ã€çº¿ç¨‹è¢«æ°¸ä¹…å µå¡åœ¨ä¸€ä¸ªç­‰å¾…è¿›å…¥åŒæ­¥å—çš„çŠ¶æ€ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹æ€»æ˜¯èƒ½åœ¨å®ƒä¹‹å‰æŒç»­åœ°å¯¹è¯¥åŒæ­¥å—è¿›è¡Œè®¿é—®ã€‚

3ã€çº¿ç¨‹åœ¨ç­‰å¾…ä¸€ä¸ªæœ¬èº«ä¹Ÿå¤„äºæ°¸ä¹…ç­‰å¾…å®Œæˆçš„å¯¹è±¡ (æ¯”å¦‚è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ wait æ–¹æ³•)ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹æ€»æ˜¯è¢«æŒç»­åœ°è·å¾—å”¤é†’ã€‚

#### å¤šçº¿ç¨‹é”çš„å‡çº§åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ Java ä¸­ï¼Œé”å…±æœ‰ 4 ç§çŠ¶æ€ï¼Œçº§åˆ«ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šæ— çŠ¶æ€é”ï¼Œåå‘é”ï¼Œè½»é‡çº§é”å’Œé‡é‡çº§é”çŠ¶æ€ï¼Œè¿™å‡ ä¸ªçŠ¶æ€ä¼šéšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ã€‚é”å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§ã€‚

### AQS(AbstractQueuedSynchronizer) è¯¦è§£ä¸æºç åˆ†æ

#### AQS ä»‹ç»

AQS çš„å…¨ç§°ä¸ºï¼ˆAbstractQueuedSynchronizerï¼‰ï¼Œè¿™ä¸ªç±»åœ¨ java.util.concurrent.locks åŒ…ä¸‹é¢ã€‚

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS8xMS8yNS8xNmVhMDQ3NjU1ZDBlNDEy?x-oss-process=image/format,png)

AQS æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œä½¿ç”¨ AQS èƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ ReentrantLockï¼ŒSemaphoreï¼Œå…¶ä»–çš„è¯¸å¦‚ ReentrantReadWriteLockï¼ŒSynchronousQueueï¼ŒFutureTask ç­‰ç­‰çš†æ˜¯åŸºäº AQS çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿèƒ½åˆ©ç”¨ AQS éå¸¸è½»æ¾å®¹æ˜“åœ°æ„é€ å‡ºç¬¦åˆæˆ‘ä»¬è‡ªå·±éœ€æ±‚çš„åŒæ­¥å™¨ã€‚

#### AQS åŸç†åˆ†æ

ä¸‹é¢å¤§éƒ¨åˆ†å†…å®¹å…¶å®åœ¨ AQS ç±»æ³¨é‡Šä¸Šå·²ç»ç»™å‡ºäº†ï¼Œä¸è¿‡æ˜¯è‹±è¯­çœ‹ç€æ¯”è¾ƒåƒåŠ›ä¸€ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹æºç ã€‚

**AQS åŸç†æ¦‚è§ˆ**

**AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯ç”¨ CLH é˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚**

> CLH(Craig,Landin,and Hagersten) é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ã€‚AQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚

çœ‹ä¸ª AQS(AbstractQueuedSynchronizer) åŸç†å›¾ï¼š

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS8xMS8yNS8xNmVhMDQ3Njc4NGNkMzJi?x-oss-process=image/format,png)

AQS ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFO é˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQS ä½¿ç”¨ CAS å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚

```
private volatile int state;//å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§
```

çŠ¶æ€ä¿¡æ¯é€šè¿‡ protected ç±»å‹çš„ getStateï¼ŒsetStateï¼ŒcompareAndSetState è¿›è¡Œæ“ä½œ

```
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {  
        return state;
}
 // è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) { 
        state = newState;
}
//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
        return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

**AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼**

AQS å®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼

*   Exclusiveï¼ˆç‹¬å ï¼‰ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ ReentrantLockã€‚åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼š
    
    *   å…¬å¹³é”ï¼šæŒ‰ç…§çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿé¡ºåºï¼Œå…ˆåˆ°è€…å…ˆæ‹¿åˆ°é”
    *   éå…¬å¹³é”ï¼šå½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œæ— è§†é˜Ÿåˆ—é¡ºåºç›´æ¥å»æŠ¢é”ï¼Œè°æŠ¢åˆ°å°±æ˜¯è°çš„
*   **Share**ï¼ˆå…±äº«ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚ Semaphore/CountDownLatchã€‚Semaphoreã€CountDownLatchã€ CyclicBarrierã€ReadWriteLock æˆ‘ä»¬éƒ½ä¼šåœ¨åé¢è®²åˆ°ã€‚
    

ReentrantReadWriteLock å¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå› ä¸º ReentrantReadWriteLock ä¹Ÿå°±æ˜¯è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚

ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦å®ç°å…±äº«èµ„æº state çš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ / å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQS å·²ç»åœ¨é¡¶å±‚å®ç°å¥½äº†ã€‚

**AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼**

åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨ä¸€èˆ¬çš„æ–¹å¼æ˜¯è¿™æ ·ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨ï¼‰ï¼š

1.  ä½¿ç”¨è€…ç»§æ‰¿ AbstractQueuedSynchronizer å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ã€‚ï¼ˆè¿™äº›é‡å†™æ–¹æ³•å¾ˆç®€å•ï¼Œæ— éæ˜¯å¯¹äºå…±äº«èµ„æº state çš„è·å–å’Œé‡Šæ”¾ï¼‰
2.  å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚

è¿™å’Œæˆ‘ä»¬ä»¥å¾€é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¿™æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªè¿ç”¨ã€‚

**AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š**

```
isHeldExclusively()//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚
tryAcquire(int)//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚
tryRelease(int)//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚
tryAcquireShared(int)//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚
tryReleaseShared(int)//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º`UnsupportedOperationException`ã€‚ è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”é€šå¸¸åº”è¯¥ç®€çŸ­è€Œä¸æ˜¯é˜»å¡ã€‚AQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ finalï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨ã€‚

ä»¥ ReentrantLock ä¸ºä¾‹ï¼Œstate åˆå§‹åŒ–ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ lock() æ—¶ï¼Œä¼šè°ƒç”¨ tryAcquire() ç‹¬å è¯¥é”å¹¶å°† state+1ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† tryAcquire() æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ unlock() åˆ° state=0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆstate ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šä¹ˆæ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚

å†ä»¥ CountDownLatch ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œstate ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå countDown() ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap) å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå (å³ state=0)ï¼Œä¼š unpark() ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» await() å‡½æ•°è¿”å›ï¼Œç»§ç»­åä½™åŠ¨ä½œã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œä»–ä»¬ä¹Ÿåªéœ€å®ç°`tryAcquire-tryRelease`ã€`tryAcquireShared-tryReleaseShared` ä¸­çš„ä¸€ç§å³å¯ã€‚ä½† AQS ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚`ReentrantReadWriteLock`ã€‚

### ReentrantLock(é‡å…¥é”) å®ç°åŸç†ä¸å…¬å¹³é”éå…¬å¹³é”åŒºåˆ«

#### ä»€ä¹ˆæ˜¯å¯é‡å…¥é”ï¼ˆReentrantLockï¼‰ï¼Ÿ

ReentrantLock é‡å…¥é”ï¼Œæ˜¯å®ç° Lock æ¥å£çš„ä¸€ä¸ªç±»ï¼Œä¹Ÿæ˜¯åœ¨å®é™…ç¼–ç¨‹ä¸­ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ä¸€ä¸ªé”ï¼Œæ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡ã€‚

åœ¨ java å…³é”®å­— synchronized éšå¼æ”¯æŒé‡å…¥æ€§ï¼Œsynchronized é€šè¿‡è·å–è‡ªå¢ï¼Œé‡Šæ”¾è‡ªå‡çš„æ–¹å¼å®ç°é‡å…¥ã€‚ä¸æ­¤åŒæ—¶ï¼ŒReentrantLock è¿˜æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§æ–¹å¼ã€‚é‚£ä¹ˆï¼Œè¦æƒ³å®Œå®Œå…¨å…¨çš„å¼„æ‡‚ ReentrantLock çš„è¯ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯ ReentrantLock åŒæ­¥è¯­ä¹‰çš„å­¦ä¹ ï¼š1. é‡å…¥æ€§çš„å®ç°åŸç†ï¼›2. å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚

é‡å…¥æ€§çš„å®ç°åŸç†

è¦æƒ³æ”¯æŒé‡å…¥æ€§ï¼Œå°±è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š**1. åœ¨çº¿ç¨‹è·å–é”çš„æ—¶å€™ï¼Œå¦‚æœå·²ç»è·å–é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹çš„è¯åˆ™ç›´æ¥å†æ¬¡è·å–æˆåŠŸï¼›2. ç”±äºé”ä¼šè¢«è·å– n æ¬¡ï¼Œé‚£ä¹ˆåªæœ‰é”åœ¨è¢«é‡Šæ”¾åŒæ ·çš„ n æ¬¡ä¹‹åï¼Œè¯¥é”æ‰ç®—æ˜¯å®Œå…¨é‡Šæ”¾æˆåŠŸ**ã€‚

ReentrantLock æ”¯æŒä¸¤ç§é”ï¼š**å…¬å¹³é”**å’Œ**éå…¬å¹³é”**ã€‚**ä½•è°“å…¬å¹³æ€§ï¼Œæ˜¯é’ˆå¯¹è·å–é”è€Œè¨€çš„ï¼Œå¦‚æœä¸€ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œé‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚ä¸Šçš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œæ»¡è¶³ FIFO**ã€‚

### è¯»å†™é” ReentrantReadWriteLock æºç åˆ†æ

#### ReadWriteLock æ˜¯ä»€ä¹ˆ

é¦–å…ˆæ˜ç¡®ä¸€ä¸‹ï¼Œä¸æ˜¯è¯´ ReentrantLock ä¸å¥½ï¼Œåªæ˜¯ ReentrantLock æŸäº›æ—¶å€™æœ‰å±€é™ã€‚å¦‚æœä½¿ç”¨ ReentrantLockï¼Œå¯èƒ½æœ¬èº«æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹ A åœ¨å†™æ•°æ®ã€çº¿ç¨‹ B åœ¨è¯»æ•°æ®é€ æˆçš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¿™æ ·ï¼Œå¦‚æœçº¿ç¨‹ C åœ¨è¯»æ•°æ®ã€çº¿ç¨‹ D ä¹Ÿåœ¨è¯»æ•°æ®ï¼Œè¯»æ•°æ®æ˜¯ä¸ä¼šæ”¹å˜æ•°æ®çš„ï¼Œæ²¡æœ‰å¿…è¦åŠ é”ï¼Œä½†æ˜¯è¿˜æ˜¯åŠ é”äº†ï¼Œé™ä½äº†ç¨‹åºçš„æ€§èƒ½ã€‚å› ä¸ºè¿™ä¸ªï¼Œæ‰è¯ç”Ÿäº†è¯»å†™é” ReadWriteLockã€‚

ReadWriteLock æ˜¯ä¸€ä¸ªè¯»å†™é”æ¥å£ï¼Œè¯»å†™é”æ˜¯ç”¨æ¥æå‡å¹¶å‘ç¨‹åºæ€§èƒ½çš„é”åˆ†ç¦»æŠ€æœ¯ï¼ŒReentrantReadWriteLock æ˜¯ ReadWriteLock æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå®ç°äº†è¯»å†™çš„åˆ†ç¦»ï¼Œè¯»é”æ˜¯å…±äº«çš„ï¼Œå†™é”æ˜¯ç‹¬å çš„ï¼Œè¯»å’Œè¯»ä¹‹é—´ä¸ä¼šäº’æ–¥ï¼Œè¯»å’Œå†™ã€å†™å’Œè¯»ã€å†™å’Œå†™ä¹‹é—´æ‰ä¼šäº’æ–¥ï¼Œæå‡äº†è¯»å†™çš„æ€§èƒ½ã€‚

è€Œè¯»å†™é”æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š

ï¼ˆ1ï¼‰å…¬å¹³é€‰æ‹©æ€§ï¼šæ”¯æŒéå…¬å¹³ï¼ˆé»˜è®¤ï¼‰å’Œå…¬å¹³çš„é”è·å–æ–¹å¼ï¼Œååé‡è¿˜æ˜¯éå…¬å¹³ä¼˜äºå…¬å¹³ã€‚

ï¼ˆ2ï¼‰é‡è¿›å…¥ï¼šè¯»é”å’Œå†™é”éƒ½æ”¯æŒçº¿ç¨‹é‡è¿›å…¥ã€‚

ï¼ˆ3ï¼‰é”é™çº§ï¼šéµå¾ªè·å–å†™é”ã€è·å–è¯»é”å†é‡Šæ”¾å†™é”çš„æ¬¡åºï¼Œå†™é”èƒ½å¤Ÿé™çº§æˆä¸ºè¯»é”ã€‚

### Condition æºç åˆ†æä¸ç­‰å¾…é€šçŸ¥æœºåˆ¶

### LockSupport è¯¦è§£

å¹¶å‘å®¹å™¨
----

### å¹¶å‘å®¹å™¨ä¹‹ ConcurrentHashMap è¯¦è§£ (JDK1.8 ç‰ˆæœ¬) ä¸æºç åˆ†æ

#### ä»€ä¹ˆæ˜¯ ConcurrentHashMapï¼Ÿ

ConcurrentHashMap æ˜¯ Java ä¸­çš„ä¸€ä¸ª**çº¿ç¨‹å®‰å…¨ä¸”é«˜æ•ˆçš„ HashMap å®ç°**ã€‚å¹³æ—¶æ¶‰åŠé«˜å¹¶å‘å¦‚æœè¦ç”¨ map ç»“æ„ï¼Œé‚£ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯å®ƒã€‚ç›¸å¯¹äº hashmap æ¥è¯´ï¼ŒConcurrentHashMap å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ mapï¼Œå…¶ä¸­åˆ©ç”¨äº†é”åˆ†æ®µçš„æ€æƒ³æé«˜äº†å¹¶å‘åº¦ã€‚

é‚£ä¹ˆå®ƒåˆ°åº•æ˜¯å¦‚ä½•å®ç°çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ

JDK 1.6 ç‰ˆæœ¬å…³é”®è¦ç´ ï¼š

*   segment ç»§æ‰¿äº† ReentrantLock å……å½“é”çš„è§’è‰²ï¼Œä¸ºæ¯ä¸€ä¸ª segment æä¾›äº†çº¿ç¨‹å®‰å…¨çš„ä¿éšœï¼›
    
*   segment ç»´æŠ¤äº†å“ˆå¸Œæ•£åˆ—è¡¨çš„è‹¥å¹²ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶ç”± HashEntry æ„æˆçš„é“¾è¡¨ã€‚
    

JDK1.8 åï¼ŒConcurrentHashMap æŠ›å¼ƒäº†åŸæœ‰çš„ **Segment åˆ†æ®µé”ï¼Œè€Œé‡‡ç”¨äº† CAS + synchronized æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§**ã€‚

#### Java ä¸­ ConcurrentHashMap çš„å¹¶å‘åº¦æ˜¯ä»€ä¹ˆï¼Ÿ

ConcurrentHashMap æŠŠå®é™… map åˆ’åˆ†æˆè‹¥å¹²éƒ¨åˆ†æ¥å®ç°å®ƒçš„å¯æ‰©å±•æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚è¿™ç§åˆ’åˆ†æ˜¯ä½¿ç”¨å¹¶å‘åº¦è·å¾—çš„ï¼Œå®ƒæ˜¯ ConcurrentHashMap ç±»æ„é€ å‡½æ•°çš„ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼ä¸º 16ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å°±èƒ½é¿å…äº‰ç”¨ã€‚

åœ¨ JDK8 åï¼Œå®ƒæ‘’å¼ƒäº† Segmentï¼ˆé”æ®µï¼‰çš„æ¦‚å¿µï¼Œè€Œæ˜¯å¯ç”¨äº†ä¸€ç§å…¨æ–°çš„æ–¹å¼å®ç°, åˆ©ç”¨ CAS ç®—æ³•ã€‚åŒæ—¶åŠ å…¥äº†æ›´å¤šçš„è¾…åŠ©å˜é‡æ¥æé«˜å¹¶å‘åº¦ï¼Œå…·ä½“å†…å®¹è¿˜æ˜¯æŸ¥çœ‹æºç å§ã€‚

#### ä»€ä¹ˆæ˜¯å¹¶å‘å®¹å™¨çš„å®ç°ï¼Ÿ

ä½•ä¸ºåŒæ­¥å®¹å™¨ï¼šå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºé€šè¿‡ synchronized æ¥å®ç°åŒæ­¥çš„å®¹å™¨ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒæ­¥å®¹å™¨çš„æ–¹æ³•ï¼Œå®ƒä»¬å°†ä¼šä¸²è¡Œæ‰§è¡Œã€‚æ¯”å¦‚ Vectorï¼ŒHashtableï¼Œä»¥åŠ Collections.synchronizedSetï¼ŒsynchronizedList ç­‰æ–¹æ³•è¿”å›çš„å®¹å™¨ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹ Vectorï¼ŒHashtable ç­‰è¿™äº›åŒæ­¥å®¹å™¨çš„å®ç°ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°è¿™äº›å®¹å™¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼å°±æ˜¯å°†å®ƒä»¬çš„çŠ¶æ€å°è£…èµ·æ¥ï¼Œå¹¶åœ¨éœ€è¦åŒæ­¥çš„æ–¹æ³•ä¸ŠåŠ ä¸Šå…³é”®å­— synchronizedã€‚

å¹¶å‘å®¹å™¨ä½¿ç”¨äº†ä¸åŒæ­¥å®¹å™¨å®Œå…¨ä¸åŒçš„åŠ é”ç­–ç•¥æ¥æä¾›æ›´é«˜çš„å¹¶å‘æ€§å’Œä¼¸ç¼©æ€§ï¼Œä¾‹å¦‚åœ¨ ConcurrentHashMap ä¸­é‡‡ç”¨äº†ä¸€ç§ç²’åº¦æ›´ç»†çš„åŠ é”æœºåˆ¶ï¼Œå¯ä»¥ç§°ä¸ºåˆ†æ®µé”ï¼Œåœ¨è¿™ç§é”æœºåˆ¶ä¸‹ï¼Œå…è®¸ä»»æ„æ•°é‡çš„è¯»çº¿ç¨‹å¹¶å‘åœ°è®¿é—® mapï¼Œå¹¶ä¸”æ‰§è¡Œè¯»æ“ä½œçš„çº¿ç¨‹å’Œå†™æ“ä½œçš„çº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘çš„è®¿é—® mapï¼ŒåŒæ—¶å…è®¸ä¸€å®šæ•°é‡çš„å†™æ“ä½œçº¿ç¨‹å¹¶å‘åœ°ä¿®æ”¹ mapï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸‹å®ç°æ›´é«˜çš„ååé‡ã€‚

#### Java ä¸­çš„åŒæ­¥é›†åˆä¸å¹¶å‘é›†åˆæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

åŒæ­¥é›†åˆä¸å¹¶å‘é›†åˆéƒ½ä¸ºå¤šçº¿ç¨‹å’Œå¹¶å‘æä¾›äº†åˆé€‚çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œä¸è¿‡å¹¶å‘é›†åˆçš„å¯æ‰©å±•æ€§æ›´é«˜ã€‚åœ¨ Java1.5 ä¹‹å‰ç¨‹åºå‘˜ä»¬åªæœ‰åŒæ­¥é›†åˆæ¥ç”¨ä¸”åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æ—¶å€™ä¼šå¯¼è‡´äº‰ç”¨ï¼Œé˜»ç¢äº†ç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚Java5 ä»‹ç»äº†å¹¶å‘é›†åˆåƒ ConcurrentHashMapï¼Œä¸ä»…æä¾›çº¿ç¨‹å®‰å…¨è¿˜ç”¨é”åˆ†ç¦»å’Œå†…éƒ¨åˆ†åŒºç­‰ç°ä»£æŠ€æœ¯æé«˜äº†å¯æ‰©å±•æ€§ã€‚

#### SynchronizedMap å’Œ ConcurrentHashMap æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

SynchronizedMap ä¸€æ¬¡é”ä½æ•´å¼ è¡¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥è®¿ä¸º mapã€‚

ConcurrentHashMap ä½¿ç”¨åˆ†æ®µé”æ¥ä¿è¯åœ¨å¤šçº¿ç¨‹ä¸‹çš„æ€§èƒ½ã€‚

ConcurrentHashMap ä¸­åˆ™æ˜¯ä¸€æ¬¡é”ä½ä¸€ä¸ªæ¡¶ã€‚ConcurrentHashMap é»˜è®¤å°† hash è¡¨åˆ†ä¸º 16 ä¸ªæ¡¶ï¼Œè¯¸å¦‚ getï¼Œputï¼Œremove ç­‰å¸¸ç”¨æ“ä½œåªé”å½“å‰éœ€è¦ç”¨åˆ°çš„æ¡¶ã€‚

è¿™æ ·ï¼ŒåŸæ¥åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œç°åœ¨å´èƒ½åŒæ—¶æœ‰ 16 ä¸ªå†™çº¿ç¨‹æ‰§è¡Œï¼Œå¹¶å‘æ€§èƒ½çš„æå‡æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚

å¦å¤– ConcurrentHashMap ä½¿ç”¨äº†ä¸€ç§ä¸åŒçš„è¿­ä»£æ–¹å¼ã€‚åœ¨è¿™ç§è¿­ä»£æ–¹å¼ä¸­ï¼Œå½“ iterator è¢«åˆ›å»ºåé›†åˆå†å‘ç”Ÿæ”¹å˜å°±ä¸å†æ˜¯æŠ›å‡º ConcurrentModificationExceptionï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åœ¨æ”¹å˜æ—¶ new æ–°çš„æ•°æ®ä»è€Œä¸å½±å“åŸæœ‰çš„æ•°æ®ï¼Œiterator å®Œæˆåå†å°†å¤´æŒ‡é’ˆæ›¿æ¢ä¸ºæ–°çš„æ•°æ®ï¼Œè¿™æ · iterator çº¿ç¨‹å¯ä»¥ä½¿ç”¨åŸæ¥è€çš„æ•°æ®ï¼Œè€Œå†™çº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘çš„å®Œæˆæ”¹å˜ã€‚

### å¹¶å‘å®¹å™¨ä¹‹ CopyOnWriteArrayList è¯¦è§£

#### CopyOnWriteArrayList æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥ç”¨äºä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Ÿæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ

CopyOnWriteArrayList æ˜¯ä¸€ä¸ªå¹¶å‘å®¹å™¨ã€‚æœ‰å¾ˆå¤šäººç§°å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘è®¤ä¸ºè¿™å¥è¯ä¸ä¸¥è°¨ï¼Œç¼ºå°‘ä¸€ä¸ªå‰ææ¡ä»¶ï¼Œé‚£å°±æ˜¯éå¤åˆåœºæ™¯ä¸‹æ“ä½œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

CopyOnWriteArrayList(å…é”å®¹å™¨) çš„å¥½å¤„ä¹‹ä¸€æ˜¯å½“å¤šä¸ªè¿­ä»£å™¨åŒæ—¶éå†å’Œä¿®æ”¹è¿™ä¸ªåˆ—è¡¨æ—¶ï¼Œä¸ä¼šæŠ›å‡º ConcurrentModificationExceptionã€‚åœ¨ CopyOnWriteArrayList ä¸­ï¼Œå†™å…¥å°†å¯¼è‡´åˆ›å»ºæ•´ä¸ªåº•å±‚æ•°ç»„çš„å‰¯æœ¬ï¼Œè€Œæºæ•°ç»„å°†ä¿ç•™åœ¨åŸåœ°ï¼Œä½¿å¾—å¤åˆ¶çš„æ•°ç»„åœ¨è¢«ä¿®æ”¹æ—¶ï¼Œè¯»å–æ“ä½œå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œã€‚

CopyOnWriteArrayList çš„ä½¿ç”¨åœºæ™¯

é€šè¿‡æºç åˆ†æï¼Œæˆ‘ä»¬çœ‹å‡ºå®ƒçš„ä¼˜ç¼ºç‚¹æ¯”è¾ƒæ˜æ˜¾ï¼Œæ‰€ä»¥ä½¿ç”¨åœºæ™¯ä¹Ÿå°±æ¯”è¾ƒæ˜æ˜¾ã€‚å°±æ˜¯åˆé€‚è¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚

CopyOnWriteArrayList çš„ç¼ºç‚¹

1.  ç”±äºå†™æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦æ‹·è´æ•°ç»„ï¼Œä¼šæ¶ˆè€—å†…å­˜ï¼Œå¦‚æœåŸæ•°ç»„çš„å†…å®¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´ young gc æˆ–è€… full gcã€‚
2.  ä¸èƒ½ç”¨äºå®æ—¶è¯»çš„åœºæ™¯ï¼Œåƒæ‹·è´æ•°ç»„ã€æ–°å¢å…ƒç´ éƒ½éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥è°ƒç”¨ä¸€ä¸ª set æ“ä½œåï¼Œè¯»å–åˆ°æ•°æ®å¯èƒ½è¿˜æ˜¯æ—§çš„ï¼Œè™½ç„¶ CopyOnWriteArrayList èƒ½åšåˆ°æœ€ç»ˆä¸€è‡´æ€§, ä½†æ˜¯è¿˜æ˜¯æ²¡æ³•æ»¡è¶³å®æ—¶æ€§è¦æ±‚ã€‚
3.  ç”±äºå®é™…ä½¿ç”¨ä¸­å¯èƒ½æ²¡æ³•ä¿è¯ CopyOnWriteArrayList åˆ°åº•è¦æ”¾ç½®å¤šå°‘æ•°æ®ï¼Œä¸‡ä¸€æ•°æ®ç¨å¾®æœ‰ç‚¹å¤šï¼Œæ¯æ¬¡ add/set éƒ½è¦é‡æ–°å¤åˆ¶æ•°ç»„ï¼Œè¿™ä¸ªä»£ä»·å®åœ¨å¤ªé«˜æ˜‚äº†ã€‚åœ¨é«˜æ€§èƒ½çš„äº’è”ç½‘åº”ç”¨ä¸­ï¼Œè¿™ç§æ“ä½œåˆ†åˆ†é’Ÿå¼•èµ·æ•…éšœã€‚

CopyOnWriteArrayList çš„è®¾è®¡æ€æƒ³

1.  è¯»å†™åˆ†ç¦»ï¼Œè¯»å’Œå†™åˆ†å¼€
2.  æœ€ç»ˆä¸€è‡´æ€§
3.  ä½¿ç”¨å¦å¤–å¼€è¾Ÿç©ºé—´çš„æ€è·¯ï¼Œæ¥è§£å†³å¹¶å‘å†²çª

### å¹¶å‘å®¹å™¨ä¹‹ ThreadLocal è¯¦è§£

#### ThreadLocal æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ï¼Ÿ

ThreadLocal æ˜¯ä¸€ä¸ªæœ¬åœ°çº¿ç¨‹å‰¯æœ¬å˜é‡å·¥å…·ç±»ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ª ThreadLocalMap å¯¹è±¡ï¼Œç®€å•è¯´ ThreadLocal å°±æ˜¯ä¸€ç§ä»¥ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨ ThreadLocalMap å¯¹è±¡å†…çš„ valueã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œé¿å…èµ„æºåœ¨å¤šçº¿ç¨‹é—´å…±äº«ã€‚

åŸç†ï¼šçº¿ç¨‹å±€éƒ¨å˜é‡æ˜¯å±€é™äºçº¿ç¨‹å†…éƒ¨çš„å˜é‡ï¼Œå±äºçº¿ç¨‹è‡ªèº«æ‰€æœ‰ï¼Œä¸åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ã€‚Java æä¾› ThreadLocal ç±»æ¥æ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ˜¯ä¸€ç§å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ã€‚ä½†æ˜¯åœ¨ç®¡ç†ç¯å¢ƒä¸‹ï¼ˆå¦‚ web æœåŠ¡å™¨ï¼‰ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ¯”ä»»ä½•åº”ç”¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸéƒ½è¦é•¿ã€‚ä»»ä½•çº¿ç¨‹å±€éƒ¨å˜é‡ä¸€æ—¦åœ¨å·¥ä½œå®Œæˆåæ²¡æœ‰é‡Šæ”¾ï¼ŒJava åº”ç”¨å°±å­˜åœ¨å†…å­˜æ³„éœ²çš„é£é™©ã€‚

ç»å…¸çš„ä½¿ç”¨åœºæ™¯æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª JDBC è¿æ¥ Connectionã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯æ¯ä¸ªçº¿ç¨‹çš„éƒ½åœ¨å„è‡ªçš„ Connection ä¸Šè¿›è¡Œæ•°æ®åº“çš„æ“ä½œï¼Œä¸ä¼šå‡ºç° A çº¿ç¨‹å…³äº† B çº¿ç¨‹æ­£åœ¨ä½¿ç”¨çš„ Connectionï¼› è¿˜æœ‰ Session ç®¡ç† ç­‰é—®é¢˜ã€‚

ThreadLocal ä½¿ç”¨ä¾‹å­ï¼š

```
public class TestThreadLocal {
    
    //çº¿ç¨‹æœ¬åœ°å­˜å‚¨å˜é‡
    private static final ThreadLocal<Integer> THREAD_LOCAL_NUM 
        = new ThreadLocal<Integer>() {
        @Override
        protected Integer initialValue() {
            return 0;
        }
    };
 
    public static void main(String[] args) {
        for (int i = 0; i <3; i++) {//å¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹
            Thread t = new Thread() {
                @Override
                public void run() {
                    add10ByThreadLocal();
                }
            };
            t.start();
        }
    }
    
    /**
     * çº¿ç¨‹æœ¬åœ°å­˜å‚¨å˜é‡åŠ  5
     */
    private static void add10ByThreadLocal() {
        for (int i = 0; i <5; i++) {
            Integer n = THREAD_LOCAL_NUM.get();
            n += 1;
            THREAD_LOCAL_NUM.set(n);
            System.out.println(Thread.currentThread().getName() + " : ThreadLocal num=" + n);
        }
    }
    
}
```

æ‰“å°ç»“æœï¼šå¯åŠ¨äº† 3 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æœ€åéƒ½æ‰“å°åˆ° â€œThreadLocal num=5â€ï¼Œè€Œä¸æ˜¯ num ä¸€ç›´åœ¨ç´¯åŠ ç›´åˆ°å€¼ç­‰äº 15

```
Thread-0 : ThreadLocal num=1
Thread-1 : ThreadLocal num=1
Thread-0 : ThreadLocal num=2
Thread-0 : ThreadLocal num=3
Thread-1 : ThreadLocal num=2
Thread-2 : ThreadLocal num=1
Thread-0 : ThreadLocal num=4
Thread-2 : ThreadLocal num=2
Thread-1 : ThreadLocal num=3
Thread-1 : ThreadLocal num=4
Thread-2 : ThreadLocal num=3
Thread-0 : ThreadLocal num=5
Thread-2 : ThreadLocal num=4
Thread-2 : ThreadLocal num=5
Thread-1 : ThreadLocal num=5
```

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Ÿ

çº¿ç¨‹å±€éƒ¨å˜é‡æ˜¯å±€é™äºçº¿ç¨‹å†…éƒ¨çš„å˜é‡ï¼Œå±äºçº¿ç¨‹è‡ªèº«æ‰€æœ‰ï¼Œä¸åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ã€‚Java æä¾› ThreadLocal ç±»æ¥æ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ˜¯ä¸€ç§å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ã€‚ä½†æ˜¯åœ¨ç®¡ç†ç¯å¢ƒä¸‹ï¼ˆå¦‚ web æœåŠ¡å™¨ï¼‰ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ¯”ä»»ä½•åº”ç”¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸéƒ½è¦é•¿ã€‚ä»»ä½•çº¿ç¨‹å±€éƒ¨å˜é‡ä¸€æ—¦åœ¨å·¥ä½œå®Œæˆåæ²¡æœ‰é‡Šæ”¾ï¼ŒJava åº”ç”¨å°±å­˜åœ¨å†…å­˜æ³„éœ²çš„é£é™©ã€‚

### ThreadLocal å†…å­˜æ³„æ¼åˆ†æä¸è§£å†³æ–¹æ¡ˆ

#### ThreadLocal é€ æˆå†…å­˜æ³„æ¼çš„åŸå› ï¼Ÿ

`ThreadLocalMap` ä¸­ä½¿ç”¨çš„ key ä¸º `ThreadLocal` çš„å¼±å¼•ç”¨, è€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ `ThreadLocal` æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œ`ThreadLocalMap` ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚ThreadLocalMap å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ `set()`ã€`get()`ã€`remove()` æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ `ThreadLocal` æ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨ `remove()` æ–¹æ³•

#### ThreadLocal å†…å­˜æ³„æ¼è§£å†³æ–¹æ¡ˆï¼Ÿ

*   æ¯æ¬¡ä½¿ç”¨å®Œ ThreadLocalï¼Œéƒ½è°ƒç”¨å®ƒçš„ remove() æ–¹æ³•ï¼Œæ¸…é™¤æ•°æ®ã€‚
    
*   åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰åŠæ—¶æ¸…ç† ThreadLocalï¼Œä¸ä»…æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ›´ä¸¥é‡çš„æ˜¯å¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘å‡ºç°é—®é¢˜ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ ThreadLocal å°±è·ŸåŠ é”å®Œè¦è§£é”ä¸€æ ·ï¼Œç”¨å®Œå°±æ¸…ç†ã€‚
    

### å¹¶å‘å®¹å™¨ä¹‹ BlockingQueue è¯¦è§£

#### ä»€ä¹ˆæ˜¯é˜»å¡é˜Ÿåˆ—ï¼Ÿé˜»å¡é˜Ÿåˆ—çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨é˜»å¡é˜Ÿåˆ—æ¥å®ç°ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å‹ï¼Ÿ

é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚

è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚

é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚

JDK7 æä¾›äº† 7 ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚åˆ†åˆ«æ˜¯ï¼š

ArrayBlockingQueue ï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚

LinkedBlockingQueue ï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚

PriorityBlockingQueue ï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚

DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚

SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚

LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚

LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚

Java 5 ä¹‹å‰å®ç°åŒæ­¥å­˜å–æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ™®é€šçš„ä¸€ä¸ªé›†åˆï¼Œç„¶ååœ¨ä½¿ç”¨çº¿ç¨‹çš„åä½œå’Œçº¿ç¨‹åŒæ­¥å¯ä»¥å®ç°ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…æ¨¡å¼ï¼Œä¸»è¦çš„æŠ€æœ¯å°±æ˜¯ç”¨å¥½ï¼Œwait,notify,notifyAll,sychronized è¿™äº›å…³é”®å­—ã€‚è€Œåœ¨ java 5 ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨é˜»å¡é˜Ÿåˆ—æ¥å®ç°ï¼Œæ­¤æ–¹å¼å¤§å¤§ç®€å°‘äº†ä»£ç é‡ï¼Œä½¿å¾—å¤šçº¿ç¨‹ç¼–ç¨‹æ›´åŠ å®¹æ˜“ï¼Œå®‰å…¨æ–¹é¢ä¹Ÿæœ‰ä¿éšœã€‚

BlockingQueue æ¥å£æ˜¯ Queue çš„å­æ¥å£ï¼Œå®ƒçš„ä¸»è¦ç”¨é€”å¹¶ä¸æ˜¯ä½œä¸ºå®¹å™¨ï¼Œè€Œæ˜¯ä½œä¸ºçº¿ç¨‹åŒæ­¥çš„çš„å·¥å…·ï¼Œå› æ­¤ä»–å…·æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç‰¹æ€§ï¼Œå½“ç”Ÿäº§è€…çº¿ç¨‹è¯•å›¾å‘ BlockingQueue æ”¾å…¥å…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™çº¿ç¨‹è¢«é˜»å¡ï¼Œå½“æ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œæ­£æ˜¯å› ä¸ºå®ƒæ‰€å…·æœ‰è¿™ä¸ªç‰¹æ€§ï¼Œæ‰€ä»¥åœ¨ç¨‹åºä¸­å¤šä¸ªçº¿ç¨‹äº¤æ›¿å‘ BlockingQueue ä¸­æ”¾å…¥å…ƒç´ ï¼Œå–å‡ºå…ƒç´ ï¼Œå®ƒå¯ä»¥å¾ˆå¥½çš„æ§åˆ¶çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚

é˜»å¡é˜Ÿåˆ—ä½¿ç”¨æœ€ç»å…¸çš„åœºæ™¯å°±æ˜¯ socket å®¢æˆ·ç«¯æ•°æ®çš„è¯»å–å’Œè§£æï¼Œè¯»å–æ•°æ®çš„çº¿ç¨‹ä¸æ–­å°†æ•°æ®æ”¾å…¥é˜Ÿåˆ—ï¼Œç„¶åè§£æçº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—å–æ•°æ®è§£æã€‚

### å¹¶å‘å®¹å™¨ä¹‹ ConcurrentLinkedQueue è¯¦è§£ä¸æºç åˆ†æ

### å¹¶å‘å®¹å™¨ä¹‹ ArrayBlockingQueue ä¸ LinkedBlockingQueue è¯¦è§£

çº¿ç¨‹æ± 
---

### Executors ç±»åˆ›å»ºå››ç§å¸¸è§çº¿ç¨‹æ± 

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ï¼Ÿæœ‰å“ªå‡ ç§åˆ›å»ºæ–¹å¼ï¼Ÿ

> æ± åŒ–æŠ€æœ¯ç›¸æ¯”å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚

åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œåˆ›å»ºå’Œé”€æ¯å¯¹è±¡æ˜¯å¾ˆè´¹æ—¶é—´çš„ï¼Œå› ä¸ºåˆ›å»ºä¸€ä¸ªå¯¹è±¡è¦è·å–å†…å­˜èµ„æºæˆ–è€…å…¶å®ƒæ›´å¤šèµ„æºã€‚åœ¨ Java ä¸­æ›´æ˜¯å¦‚æ­¤ï¼Œè™šæ‹Ÿæœºå°†è¯•å›¾è·Ÿè¸ªæ¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨å¯¹è±¡é”€æ¯åè¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥æé«˜æœåŠ¡ç¨‹åºæ•ˆç‡çš„ä¸€ä¸ªæ‰‹æ®µå°±æ˜¯å°½å¯èƒ½å‡å°‘åˆ›å»ºå’Œé”€æ¯å¯¹è±¡çš„æ¬¡æ•°ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›å¾ˆè€—èµ„æºçš„å¯¹è±¡åˆ›å»ºå’Œé”€æ¯ï¼Œè¿™å°±æ˜¯â€ æ± åŒ–èµ„æºâ€ æŠ€æœ¯äº§ç”Ÿçš„åŸå› ã€‚

çº¿ç¨‹æ± é¡¾åæ€ä¹‰å°±æ˜¯äº‹å…ˆåˆ›å»ºè‹¥å¹²ä¸ªå¯æ‰§è¡Œçš„çº¿ç¨‹æ”¾å…¥ä¸€ä¸ªæ± ï¼ˆå®¹å™¨ï¼‰ä¸­ï¼Œéœ€è¦çš„æ—¶å€™ä»æ± ä¸­è·å–çº¿ç¨‹ä¸ç”¨è‡ªè¡Œåˆ›å»ºï¼Œä½¿ç”¨å®Œæ¯•ä¸éœ€è¦é”€æ¯çº¿ç¨‹è€Œæ˜¯æ”¾å›æ± ä¸­ï¼Œä»è€Œå‡å°‘åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¯¹è±¡çš„å¼€é”€ã€‚Java 5 + ä¸­çš„ Executor æ¥å£å®šä¹‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹çš„å·¥å…·ã€‚å®ƒçš„å­ç±»å‹å³çº¿ç¨‹æ± æ¥å£æ˜¯ ExecutorServiceã€‚è¦é…ç½®ä¸€ä¸ªçº¿ç¨‹æ± æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå°¤å…¶æ˜¯å¯¹äºçº¿ç¨‹æ± çš„åŸç†ä¸æ˜¯å¾ˆæ¸…æ¥šçš„æƒ…å†µä¸‹ï¼Œå› æ­¤åœ¨å·¥å…·ç±» Executors é¢æä¾›äº†ä¸€äº›é™æ€å·¥å‚æ–¹æ³•ï¼Œç”Ÿæˆä¸€äº›å¸¸ç”¨çš„çº¿ç¨‹æ± ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

ï¼ˆ1ï¼‰newSingleThreadExecutorï¼šåˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è¿™ä¸ªçº¿ç¨‹æ± åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚å¦‚æœè¿™ä¸ªå”¯ä¸€çš„çº¿ç¨‹å› ä¸ºå¼‚å¸¸ç»“æŸï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ›¿ä»£å®ƒã€‚æ­¤çº¿ç¨‹æ± ä¿è¯æ‰€æœ‰ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæŒ‰ç…§ä»»åŠ¡çš„æäº¤é¡ºåºæ‰§è¡Œã€‚

ï¼ˆ2ï¼‰newFixedThreadPoolï¼šåˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ã€‚æ¯æ¬¡æäº¤ä¸€ä¸ªä»»åŠ¡å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç›´åˆ°çº¿ç¨‹è¾¾åˆ°çº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ã€‚çº¿ç¨‹æ± çš„å¤§å°ä¸€æ—¦è¾¾åˆ°æœ€å¤§å€¼å°±ä¼šä¿æŒä¸å˜ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹å› ä¸ºæ‰§è¡Œå¼‚å¸¸è€Œç»“æŸï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šè¡¥å……ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚å¦‚æœå¸Œæœ›åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨çº¿ç¨‹æ± ï¼Œå»ºè®®ä½¿ç”¨ newFixedThreadPool æ–¹æ³•æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚

ï¼ˆ3ï¼‰ newCachedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ã€‚å¦‚æœçº¿ç¨‹æ± çš„å¤§å°è¶…è¿‡äº†å¤„ç†ä»»åŠ¡æ‰€éœ€è¦çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ä¼šå›æ”¶éƒ¨åˆ†ç©ºé—²ï¼ˆ60 ç§’ä¸æ‰§è¡Œä»»åŠ¡ï¼‰çš„çº¿ç¨‹ï¼Œå½“ä»»åŠ¡æ•°å¢åŠ æ—¶ï¼Œæ­¤çº¿ç¨‹æ± åˆå¯ä»¥æ™ºèƒ½çš„æ·»åŠ æ–°çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚æ­¤çº¿ç¨‹æ± ä¸ä¼šå¯¹çº¿ç¨‹æ± å¤§å°åšé™åˆ¶ï¼Œçº¿ç¨‹æ± å¤§å°å®Œå…¨ä¾èµ–äºæ“ä½œç³»ç»Ÿï¼ˆæˆ–è€…è¯´ JVMï¼‰èƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹å¤§å°ã€‚

ï¼ˆ4ï¼‰newScheduledThreadPoolï¼šåˆ›å»ºä¸€ä¸ªå¤§å°æ— é™çš„çº¿ç¨‹æ± ã€‚æ­¤çº¿ç¨‹æ± æ”¯æŒå®šæ—¶ä»¥åŠå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„éœ€æ±‚ã€‚

#### çº¿ç¨‹æ± æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ

*   é™ä½èµ„æºæ¶ˆè€—ï¼šé‡ç”¨å­˜åœ¨çš„çº¿ç¨‹ï¼Œå‡å°‘å¯¹è±¡åˆ›å»ºé”€æ¯çš„å¼€é”€ã€‚
    
*   æé«˜å“åº”é€Ÿåº¦ã€‚å¯æœ‰æ•ˆçš„æ§åˆ¶æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°ï¼Œæé«˜ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ç‡ï¼ŒåŒæ—¶é¿å…è¿‡å¤šèµ„æºç«äº‰ï¼Œé¿å…å µå¡ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
    
*   æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚
    
*   é™„åŠ åŠŸèƒ½ï¼šæä¾›å®šæ—¶æ‰§è¡Œã€å®šæœŸæ‰§è¡Œã€å•çº¿ç¨‹ã€å¹¶å‘æ•°æ§åˆ¶ç­‰åŠŸèƒ½ã€‚
    

ç»¼ä¸Šæ‰€è¿°ä½¿ç”¨çº¿ç¨‹æ± æ¡†æ¶ Executor èƒ½æ›´å¥½çš„ç®¡ç†çº¿ç¨‹ã€æä¾›ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡ã€‚

#### çº¿ç¨‹æ± éƒ½æœ‰å“ªäº›çŠ¶æ€ï¼Ÿ

*   RUNNINGï¼šè¿™æ˜¯æœ€æ­£å¸¸çš„çŠ¶æ€ï¼Œæ¥å—æ–°çš„ä»»åŠ¡ï¼Œå¤„ç†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
*   SHUTDOWNï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡æäº¤ï¼Œä½†æ˜¯ä¼šç»§ç»­å¤„ç†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
*   STOPï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡æäº¤ï¼Œä¸å†å¤„ç†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚
*   TIDYINGï¼šæ‰€æœ‰çš„ä»»åŠ¡éƒ½é”€æ¯äº†ï¼ŒworkCount ä¸º 0ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€åœ¨è½¬æ¢ä¸º TIDYING çŠ¶æ€æ—¶ï¼Œä¼šæ‰§è¡Œé’©å­æ–¹æ³• terminated()ã€‚
*   TERMINATEDï¼šterminated() æ–¹æ³•ç»“æŸåï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å°±ä¼šå˜æˆè¿™ä¸ªã€‚

#### ä»€ä¹ˆæ˜¯ Executor æ¡†æ¶ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨ Executor æ¡†æ¶ï¼Ÿ

Executor æ¡†æ¶æ˜¯ä¸€ä¸ªæ ¹æ®ä¸€ç»„æ‰§è¡Œç­–ç•¥è°ƒç”¨ï¼Œè°ƒåº¦ï¼Œæ‰§è¡Œå’Œæ§åˆ¶çš„å¼‚æ­¥ä»»åŠ¡çš„æ¡†æ¶ã€‚

æ¯æ¬¡æ‰§è¡Œä»»åŠ¡åˆ›å»ºçº¿ç¨‹ new Thread() æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶ã€è€—èµ„æºçš„ï¼Œè€Œä¸”æ— é™åˆ¶çš„åˆ›å»ºçº¿ç¨‹ä¼šå¼•èµ·åº”ç”¨ç¨‹åºå†…å­˜æº¢å‡ºã€‚

æ‰€ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± æ˜¯ä¸ªæ›´å¥½çš„çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå¯ä»¥é™åˆ¶çº¿ç¨‹çš„æ•°é‡å¹¶ä¸”å¯ä»¥å›æ”¶å†åˆ©ç”¨è¿™äº›çº¿ç¨‹ã€‚åˆ©ç”¨ Executors æ¡†æ¶å¯ä»¥éå¸¸æ–¹ä¾¿çš„åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ã€‚

#### åœ¨ Java ä¸­ Executor å’Œ Executors çš„åŒºåˆ«ï¼Ÿ

*   Executors å·¥å…·ç±»çš„ä¸åŒæ–¹æ³•æŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚åˆ›å»ºäº†ä¸åŒçš„çº¿ç¨‹æ± ï¼Œæ¥æ»¡è¶³ä¸šåŠ¡çš„éœ€æ±‚ã€‚
    
*   Executor æ¥å£å¯¹è±¡èƒ½æ‰§è¡Œæˆ‘ä»¬çš„çº¿ç¨‹ä»»åŠ¡ã€‚
    
*   ExecutorService æ¥å£ç»§æ‰¿äº† Executor æ¥å£å¹¶è¿›è¡Œäº†æ‰©å±•ï¼Œæä¾›äº†æ›´å¤šçš„æ–¹æ³•æˆ‘ä»¬èƒ½è·å¾—ä»»åŠ¡æ‰§è¡Œçš„çŠ¶æ€å¹¶ä¸”å¯ä»¥è·å–ä»»åŠ¡çš„è¿”å›å€¼ã€‚
    
*   ä½¿ç”¨ ThreadPoolExecutor å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹æ± ã€‚
    
*   Future è¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœï¼Œä»–æä¾›äº†æ£€æŸ¥è®¡ç®—æ˜¯å¦å®Œæˆçš„æ–¹æ³•ï¼Œä»¥ç­‰å¾…è®¡ç®—çš„å®Œæˆï¼Œå¹¶å¯ä»¥ä½¿ç”¨ get() æ–¹æ³•è·å–è®¡ç®—çš„ç»“æœã€‚
    

#### çº¿ç¨‹æ± ä¸­ submit() å’Œ execute() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

æ¥æ”¶å‚æ•°ï¼šexecute() åªèƒ½æ‰§è¡Œ Runnable ç±»å‹çš„ä»»åŠ¡ã€‚submit() å¯ä»¥æ‰§è¡Œ Runnable å’Œ Callable ç±»å‹çš„ä»»åŠ¡ã€‚

è¿”å›å€¼ï¼šsubmit() æ–¹æ³•å¯ä»¥è¿”å›æŒæœ‰è®¡ç®—ç»“æœçš„ Future å¯¹è±¡ï¼Œè€Œ execute() æ²¡æœ‰

å¼‚å¸¸å¤„ç†ï¼šsubmit() æ–¹ä¾¿ Exception å¤„ç†

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹ç»„ï¼Œä¸ºä»€ä¹ˆåœ¨ Java ä¸­ä¸æ¨èä½¿ç”¨ï¼Ÿ

ThreadGroup ç±»ï¼Œå¯ä»¥æŠŠçº¿ç¨‹å½’å±åˆ°æŸä¸€ä¸ªçº¿ç¨‹ç»„ä¸­ï¼Œçº¿ç¨‹ç»„ä¸­å¯ä»¥æœ‰çº¿ç¨‹å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æœ‰çº¿ç¨‹ç»„ï¼Œç»„ä¸­è¿˜å¯ä»¥æœ‰çº¿ç¨‹ï¼Œè¿™æ ·çš„ç»„ç»‡ç»“æ„æœ‰ç‚¹ç±»ä¼¼äºæ ‘çš„å½¢å¼ã€‚

çº¿ç¨‹ç»„å’Œçº¿ç¨‹æ± æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œä»–ä»¬çš„ä½œç”¨å®Œå…¨ä¸åŒï¼Œå‰è€…æ˜¯ä¸ºäº†æ–¹ä¾¿çº¿ç¨‹çš„ç®¡ç†ï¼Œåè€…æ˜¯ä¸ºäº†ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¤ç”¨çº¿ç¨‹ï¼Œå‡å°‘åˆ›å»ºé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚

ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨çº¿ç¨‹ç»„ï¼Ÿå› ä¸ºä½¿ç”¨æœ‰å¾ˆå¤šçš„å®‰å…¨éšæ‚£å§ï¼Œæ²¡æœ‰å…·ä½“è¿½ç©¶ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ï¼Œæ¨èä½¿ç”¨çº¿ç¨‹æ± ã€‚

### çº¿ç¨‹æ± ä¹‹ ThreadPoolExecutor è¯¦è§£

#### Executors å’Œ ThreaPoolExecutor åˆ›å»ºçº¿ç¨‹æ± çš„åŒºåˆ«

ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

Executors å„ä¸ªæ–¹æ³•çš„å¼Šç«¯ï¼š

*   newFixedThreadPool å’Œ newSingleThreadExecutor:  
    ä¸»è¦é—®é¢˜æ˜¯å †ç§¯çš„è¯·æ±‚å¤„ç†é˜Ÿåˆ—å¯èƒ½ä¼šè€—è´¹éå¸¸å¤§çš„å†…å­˜ï¼Œç”šè‡³ OOMã€‚
    
*   newCachedThreadPool å’Œ newScheduledThreadPool:  
    ä¸»è¦é—®é¢˜æ˜¯çº¿ç¨‹æ•°æœ€å¤§æ•°æ˜¯ Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºæ•°é‡éå¸¸å¤šçš„çº¿ç¨‹ï¼Œç”šè‡³ OOMã€‚
    

ThreaPoolExecutor åˆ›å»ºçº¿ç¨‹æ± æ–¹å¼åªæœ‰ä¸€ç§ï¼Œå°±æ˜¯èµ°å®ƒçš„æ„é€ å‡½æ•°ï¼Œå‚æ•°è‡ªå·±æŒ‡å®š

#### ä½ çŸ¥é“æ€ä¹ˆåˆ›å»ºçº¿ç¨‹æ± å—ï¼Ÿ

åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼æœ‰å¤šç§ï¼Œè¿™é‡Œä½ åªéœ€è¦ç­” ThreadPoolExecutor å³å¯ã€‚

ThreadPoolExecutor() æ˜¯æœ€åŸå§‹çš„çº¿ç¨‹æ± åˆ›å»ºï¼Œä¹Ÿæ˜¯é˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œä¸­æ˜ç¡®è§„èŒƒçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼ã€‚

#### ThreadPoolExecutor æ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ

**`ThreadPoolExecutor`** **3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š**

*   **`corePoolSize`** ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
*   **`maximumPoolSize`** ï¼šçº¿ç¨‹æ± ä¸­å…è®¸å­˜åœ¨çš„å·¥ä½œçº¿ç¨‹çš„æœ€å¤§æ•°é‡
*   **`workQueue`**ï¼šå½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor` å…¶ä»–å¸¸è§å‚æ•°:

1.  **`keepAliveTime`**ï¼šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime` æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›
2.  **`unit`** ï¼š`keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
3.  **`threadFactory`**ï¼šä¸ºçº¿ç¨‹æ± æä¾›åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹å·¥å‚
4.  **`handler`** ï¼šçº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—è¶…è¿‡ maxinumPoolSize ä¹‹åçš„æ‹’ç»ç­–ç•¥

#### ThreadPoolExecutor é¥±å’Œç­–ç•¥

**`ThreadPoolExecutor`** **é¥±å’Œç­–ç•¥å®šä¹‰:**

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»æ—¶ï¼Œ`ThreadPoolTaskExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

*   **`ThreadPoolExecutor.AbortPolicy`**ï¼šæŠ›å‡º `RejectedExecutionException` æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
*   **`ThreadPoolExecutor.CallerRunsPolicy`**ï¼šè°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ã€‚æ‚¨ä¸ä¼šä»»åŠ¡è¯·æ±‚ã€‚ä½†æ˜¯è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦å¤–ï¼Œè¿™ä¸ªç­–ç•¥å–œæ¬¢å¢åŠ é˜Ÿåˆ—å®¹é‡ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ ä¸èƒ½ä»»åŠ¡ä¸¢å¼ƒä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚çš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
*   **`ThreadPoolExecutor.DiscardPolicy`**ï¼šä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
*   **`ThreadPoolExecutor.DiscardOldestPolicy`**ï¼š æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š Spring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` é¥±å’Œç­–ç•¥çš„è¯æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™é»˜è®¤ä½¿ç”¨çš„æ˜¯`ThreadPoolExecutor.AbortPolicy`ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚ å¯¹äºå¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºï¼Œå»ºè®®ä½¿ç”¨`ThreadPoolExecutor.CallerRunsPolicy`ã€‚å½“æœ€å¤§æ± è¢«å¡«æ»¡æ—¶ï¼Œæ­¤ç­–ç•¥ä¸ºæˆ‘ä»¬æä¾›å¯ä¼¸ç¼©é˜Ÿåˆ—ã€‚ï¼ˆè¿™ä¸ªç›´æ¥æŸ¥çœ‹ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æºç å°±å¯ä»¥çœ‹å‡ºï¼Œæ¯”è¾ƒç®€å•çš„åŸå› ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼‰

#### ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demo:`Runnable`+`ThreadPoolExecutor`

çº¿ç¨‹æ± å®ç°åŸç†

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS8xMS8yNS8xNmVhMDQ3NjEyOTVlNzY2?x-oss-process=image/format,png)

ä¸ºäº†è®©å¤§å®¶æ›´æ¸…æ¥šä¸Šé¢çš„é¢è¯•é¢˜ä¸­çš„ä¸€äº›æ¦‚å¿µï¼Œæˆ‘å†™äº†ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demoã€‚

é¦–å…ˆåˆ›å»ºä¸€ä¸ª `Runnable` æ¥å£çš„å®ç°ç±»ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ `Callable` æ¥å£ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´äº†ä¸¤è€…çš„åŒºåˆ«ã€‚ï¼‰

```
import java.util.Date;

/**
 * è¿™æ˜¯ä¸€ä¸ªç®€å•çš„Runnableç±»ï¼Œéœ€è¦å¤§çº¦5ç§’é’Ÿæ¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚
 */
public class MyRunnable implements Runnable {

    private String command;

    public MyRunnable(String s) {
        this.command = s;
    }

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " Start. Time = " + new Date());
        processCommand();
        System.out.println(Thread.currentThread().getName() + " End. Time = " + new Date());
    }

    private void processCommand() {
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String toString() {
        return this.command;
    }
}
```

ç¼–å†™æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é˜¿é‡Œå·´å·´æ¨èçš„ä½¿ç”¨ `ThreadPoolExecutor` æ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

```
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class ThreadPoolExecutorDemo {

    private static final int CORE_POOL_SIZE = 5;
    private static final int MAX_POOL_SIZE = 10;
    private static final int QUEUE_CAPACITY = 100;
    private static final Long KEEP_ALIVE_TIME = 1L;
    public static void main(String[] args) {

        //ä½¿ç”¨é˜¿é‡Œå·´å·´æ¨èçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼
        //é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(QUEUE_CAPACITY),
                new ThreadPoolExecutor.CallerRunsPolicy());

        for (int i = 0; i < 10; i++) {
            //åˆ›å»ºWorkerThreadå¯¹è±¡ï¼ˆWorkerThreadç±»å®ç°äº†Runnable æ¥å£ï¼‰
            Runnable worker = new MyRunnable("" + i);
            //æ‰§è¡ŒRunnable
            executor.execute(worker);
        }
        //ç»ˆæ­¢çº¿ç¨‹æ± 
        executor.shutdown();
        while (!executor.isTerminated()) {
        }
        System.out.println("Finished all threads");
    }
}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šé¢çš„ä»£ç æŒ‡å®šäº†ï¼š

1.  `corePoolSize`: æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5ã€‚
2.  `maximumPoolSize` ï¼šæœ€å¤§çº¿ç¨‹æ•° 10
3.  `keepAliveTime` : ç­‰å¾…æ—¶é—´ä¸º 1Lã€‚
4.  `unit`: ç­‰å¾…æ—¶é—´çš„å•ä½ä¸º TimeUnit.SECONDSã€‚
5.  `workQueue`ï¼šä»»åŠ¡é˜Ÿåˆ—ä¸º`ArrayBlockingQueue`ï¼Œå¹¶ä¸”å®¹é‡ä¸º 100;
6.  `handler`: é¥±å’Œç­–ç•¥ä¸º`CallerRunsPolicy`ã€‚

**Outputï¼š**

```
pool-1-thread-2 Start. Time = Tue Nov 12 20:59:44 CST 2019
pool-1-thread-5 Start. Time = Tue Nov 12 20:59:44 CST 2019
pool-1-thread-4 Start. Time = Tue Nov 12 20:59:44 CST 2019
pool-1-thread-1 Start. Time = Tue Nov 12 20:59:44 CST 2019
pool-1-thread-3 Start. Time = Tue Nov 12 20:59:44 CST 2019
pool-1-thread-5 End. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-3 End. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-2 End. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-4 End. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-1 End. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-2 Start. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-1 Start. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-4 Start. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-3 Start. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-5 Start. Time = Tue Nov 12 20:59:49 CST 2019
pool-1-thread-2 End. Time = Tue Nov 12 20:59:54 CST 2019
pool-1-thread-3 End. Time = Tue Nov 12 20:59:54 CST 2019
pool-1-thread-4 End. Time = Tue Nov 12 20:59:54 CST 2019
pool-1-thread-5 End. Time = Tue Nov 12 20:59:54 CST 2019
pool-1-thread-1 End. Time = Tue Nov 12 20:59:54 CST 2019
```

### çº¿ç¨‹æ± ä¹‹ ScheduledThreadPoolExecutor è¯¦è§£

### FutureTask è¯¦è§£

åŸå­æ“ä½œç±»
-----

#### ä»€ä¹ˆæ˜¯åŸå­æ“ä½œï¼Ÿåœ¨ Java Concurrency API ä¸­æœ‰å“ªäº›åŸå­ç±» (atomic classes)ï¼Ÿ

åŸå­æ“ä½œï¼ˆatomic operationï¼‰æ„ä¸ºâ€ ä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œâ€ã€‚

å¤„ç†å™¨ä½¿ç”¨åŸºäºå¯¹ç¼“å­˜åŠ é”æˆ–æ€»çº¿åŠ é”çš„æ–¹å¼æ¥å®ç°å¤šå¤„ç†å™¨ä¹‹é—´çš„åŸå­æ“ä½œã€‚åœ¨ Java ä¸­å¯ä»¥é€šè¿‡é”å’Œå¾ªç¯ CAS çš„æ–¹å¼æ¥å®ç°åŸå­æ“ä½œã€‚ CAS æ“ä½œâ€”â€”Compare & Setï¼Œæˆ–æ˜¯ Compare & Swapï¼Œç°åœ¨å‡ ä¹æ‰€æœ‰çš„ CPU æŒ‡ä»¤éƒ½æ”¯æŒ CAS çš„åŸå­æ“ä½œã€‚

åŸå­æ“ä½œæ˜¯æŒ‡ä¸€ä¸ªä¸å—å…¶ä»–æ“ä½œå½±å“çš„æ“ä½œä»»åŠ¡å•å…ƒã€‚åŸå­æ“ä½œæ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹é¿å…æ•°æ®ä¸ä¸€è‡´å¿…é¡»çš„æ‰‹æ®µã€‚

int++ å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œæ‰€ä»¥å½“ä¸€ä¸ªçº¿ç¨‹è¯»å–å®ƒçš„å€¼å¹¶åŠ  1 æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹æœ‰å¯èƒ½ä¼šè¯»åˆ°ä¹‹å‰çš„å€¼ï¼Œè¿™å°±ä¼šå¼•å‘é”™è¯¯ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»ä¿è¯å¢åŠ æ“ä½œæ˜¯åŸå­çš„ï¼Œåœ¨ JDK1.5 ä¹‹å‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŒæ­¥æŠ€æœ¯æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚åˆ° JDK1.5ï¼Œjava.util.concurrent.atomic åŒ…æä¾›äº† int å’Œ long ç±»å‹çš„åŸå­åŒ…è£…ç±»ï¼Œå®ƒä»¬å¯ä»¥è‡ªåŠ¨çš„ä¿è¯å¯¹äºä»–ä»¬çš„æ“ä½œæ˜¯åŸå­çš„å¹¶ä¸”ä¸éœ€è¦ä½¿ç”¨åŒæ­¥ã€‚

java.util.concurrent è¿™ä¸ªåŒ…é‡Œé¢æä¾›äº†ä¸€ç»„åŸå­ç±»ã€‚å…¶åŸºæœ¬çš„ç‰¹æ€§å°±æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œè¿™äº›ç±»çš„å®ä¾‹åŒ…å«çš„æ–¹æ³•æ—¶ï¼Œå…·æœ‰æ’ä»–æ€§ï¼Œå³å½“æŸä¸ªçº¿ç¨‹è¿›å…¥æ–¹æ³•ï¼Œæ‰§è¡Œå…¶ä¸­çš„æŒ‡ä»¤æ—¶ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼Œè€Œåˆ«çš„çº¿ç¨‹å°±åƒè‡ªæ—‹é”ä¸€æ ·ï¼Œä¸€ç›´ç­‰åˆ°è¯¥æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œæ‰ç”± JVM ä»ç­‰å¾…é˜Ÿåˆ—ä¸­é€‰æ‹©å¦ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œè¿™åªæ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„ç†è§£ã€‚

åŸå­ç±»ï¼šAtomicBooleanï¼ŒAtomicIntegerï¼ŒAtomicLongï¼ŒAtomicReference

åŸå­æ•°ç»„ï¼šAtomicIntegerArrayï¼ŒAtomicLongArrayï¼ŒAtomicReferenceArray

åŸå­å±æ€§æ›´æ–°å™¨ï¼šAtomicLongFieldUpdaterï¼ŒAtomicIntegerFieldUpdaterï¼ŒAtomicReferenceFieldUpdater

è§£å†³ ABA é—®é¢˜çš„åŸå­ç±»ï¼šAtomicMarkableReferenceï¼ˆé€šè¿‡å¼•å…¥ä¸€ä¸ª boolean æ¥åæ˜ ä¸­é—´æœ‰æ²¡æœ‰å˜è¿‡ï¼‰ï¼ŒAtomicStampedReferenceï¼ˆé€šè¿‡å¼•å…¥ä¸€ä¸ª int æ¥ç´¯åŠ æ¥åæ˜ ä¸­é—´æœ‰æ²¡æœ‰å˜è¿‡ï¼‰

#### è¯´ä¸€ä¸‹ atomic çš„åŸç†ï¼Ÿ

Atomic åŒ…ä¸­çš„ç±»åŸºæœ¬çš„ç‰¹æ€§å°±æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹å•ä¸ªï¼ˆåŒ…æ‹¬åŸºæœ¬ç±»å‹åŠå¼•ç”¨ç±»å‹ï¼‰å˜é‡è¿›è¡Œæ“ä½œæ—¶ï¼Œå…·æœ‰æ’ä»–æ€§ï¼Œå³å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹è¯¥å˜é‡çš„å€¼è¿›è¡Œæ›´æ–°æ—¶ï¼Œä»…æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸï¼Œè€ŒæœªæˆåŠŸçš„çº¿ç¨‹å¯ä»¥å‘è‡ªæ—‹é”ä¸€æ ·ï¼Œç»§ç»­å°è¯•ï¼Œä¸€ç›´ç­‰åˆ°æ‰§è¡ŒæˆåŠŸã€‚

AtomicInteger ç±»çš„éƒ¨åˆ†æºç ï¼š

```
// setup to use Unsafe.compareAndSwapInt for updatesï¼ˆæ›´æ–°æ“ä½œæ—¶æä¾›â€œæ¯”è¾ƒå¹¶æ›¿æ¢â€çš„ä½œç”¨ï¼‰
private static final Unsafe unsafe = Unsafe.getUnsafe();
private static final long valueOffset;

static {
	try {
		valueOffset = unsafe.objectFieldOffset
		(AtomicInteger.class.getDeclaredField("value"));
	} catch (Exception ex) { throw new Error(ex); }
}

private volatile int value;
```

AtomicInteger ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚

CAS çš„åŸç†æ˜¯æ‹¿æœŸæœ›çš„å€¼å’ŒåŸæœ¬çš„ä¸€ä¸ªå€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™æ›´æ–°æˆæ–°çš„å€¼ã€‚UnSafe ç±»çš„ objectFieldOffset() æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ‹¿åˆ° â€œåŸæ¥çš„å€¼â€ çš„å†…å­˜åœ°å€ï¼Œè¿”å›å€¼æ˜¯ valueOffsetã€‚å¦å¤– value æ˜¯ä¸€ä¸ª volatile å˜é‡ï¼Œåœ¨å†…å­˜ä¸­å¯è§ï¼Œå› æ­¤ JVM å¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»ä»»ä½•çº¿ç¨‹æ€»èƒ½æ‹¿åˆ°è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚

å¹¶å‘å·¥å…·
----

### å¹¶å‘å·¥å…·ä¹‹ CountDownLatch ä¸ CyclicBarrier

#### åœ¨ Java ä¸­ CycliBarriar å’Œ CountdownLatch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

CountDownLatch ä¸ CyclicBarrier éƒ½æ˜¯ç”¨äºæ§åˆ¶å¹¶å‘çš„å·¥å…·ç±»ï¼Œéƒ½å¯ä»¥ç†è§£æˆç»´æŠ¤çš„å°±æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä½†æ˜¯è¿™ä¸¤è€…è¿˜æ˜¯å„æœ‰ä¸åŒä¾§é‡ç‚¹çš„ï¼š

*   CountDownLatch ä¸€èˆ¬ç”¨äºæŸä¸ªçº¿ç¨‹ A ç­‰å¾…è‹¥å¹²ä¸ªå…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼Œå®ƒæ‰æ‰§è¡Œï¼›è€Œ CyclicBarrier ä¸€èˆ¬ç”¨äºä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…è‡³æŸä¸ªçŠ¶æ€ï¼Œç„¶åè¿™ä¸€ç»„çº¿ç¨‹å†åŒæ—¶æ‰§è¡Œï¼›CountDownLatch å¼ºè°ƒä¸€ä¸ªçº¿ç¨‹ç­‰å¤šä¸ªçº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ã€‚CyclicBarrier æ˜¯å¤šä¸ªçº¿ç¨‹äº’ç­‰ï¼Œç­‰å¤§å®¶éƒ½å®Œæˆï¼Œå†æºæ‰‹å…±è¿›ã€‚
    
*   è°ƒç”¨ CountDownLatch çš„ countDown æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹å¹¶ä¸ä¼šé˜»å¡ï¼Œä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼›è€Œè°ƒç”¨ CyclicBarrier çš„ await æ–¹æ³•ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ° CyclicBarrier æŒ‡å®šçš„çº¿ç¨‹å…¨éƒ¨éƒ½åˆ°è¾¾äº†æŒ‡å®šç‚¹çš„æ—¶å€™ï¼Œæ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼›
    
*   CountDownLatch æ–¹æ³•æ¯”è¾ƒå°‘ï¼Œæ“ä½œæ¯”è¾ƒç®€å•ï¼Œè€Œ CyclicBarrier æä¾›çš„æ–¹æ³•æ›´å¤šï¼Œæ¯”å¦‚èƒ½å¤Ÿé€šè¿‡ getNumberWaiting()ï¼ŒisBroken() è¿™äº›æ–¹æ³•è·å–å½“å‰å¤šä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶ä¸” CyclicBarrier çš„æ„é€ æ–¹æ³•å¯ä»¥ä¼ å…¥ barrierActionï¼ŒæŒ‡å®šå½“æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾æ—¶æ‰§è¡Œçš„ä¸šåŠ¡åŠŸèƒ½ï¼›
    
*   CountDownLatch æ˜¯ä¸èƒ½å¤ç”¨çš„ï¼Œè€Œ CyclicLatch æ˜¯å¯ä»¥å¤ç”¨çš„ã€‚
    

### å¹¶å‘å·¥å…·ä¹‹ Semaphore ä¸ Exchanger

#### Semaphore æœ‰ä»€ä¹ˆä½œç”¨

Semaphore å°±æ˜¯ä¸€ä¸ªä¿¡å·é‡ï¼Œå®ƒçš„ä½œç”¨æ˜¯é™åˆ¶æŸæ®µä»£ç å—çš„å¹¶å‘æ•°ã€‚Semaphore æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ª int å‹æ•´æ•° nï¼Œè¡¨ç¤ºæŸæ®µä»£ç æœ€å¤šåªæœ‰ n ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®ï¼Œå¦‚æœè¶…å‡ºäº† nï¼Œé‚£ä¹ˆè¯·ç­‰å¾…ï¼Œç­‰åˆ°æŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•è¿™æ®µä»£ç å—ï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹å†è¿›å…¥ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºå¦‚æœ Semaphore æ„é€ å‡½æ•°ä¸­ä¼ å…¥çš„ int å‹æ•´æ•° n=1ï¼Œç›¸å½“äºå˜æˆäº†ä¸€ä¸ª synchronized äº†ã€‚

**Semaphore(ä¿¡å·é‡)- å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼š** synchronized å’Œ ReentrantLock éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼ŒSemaphore(ä¿¡å·é‡) å¯ä»¥æŒ‡å®šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹é—´äº¤æ¢æ•°æ®çš„å·¥å…· Exchanger

Exchanger æ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ï¼Œç”¨äºä¸¤ä¸ªçº¿ç¨‹é—´äº¤æ¢æ•°æ®ã€‚å®ƒæä¾›äº†ä¸€ä¸ªäº¤æ¢çš„åŒæ­¥ç‚¹ï¼Œåœ¨è¿™ä¸ªåŒæ­¥ç‚¹ä¸¤ä¸ªçº¿ç¨‹èƒ½å¤Ÿäº¤æ¢æ•°æ®ã€‚äº¤æ¢æ•°æ®æ˜¯é€šè¿‡ exchange æ–¹æ³•æ¥å®ç°çš„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ exchange æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¼šåŒæ­¥ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œ exchange æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ä¸¤ä¸ªçº¿ç¨‹å°±éƒ½è¾¾åˆ°äº†åŒæ­¥ç‚¹ï¼Œä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®ã€‚

#### å¸¸ç”¨çš„å¹¶å‘å·¥å…·ç±»æœ‰å“ªäº›ï¼Ÿ

*   **Semaphore(ä¿¡å·é‡)- å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼š** synchronized å’Œ ReentrantLock éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼ŒSemaphore(ä¿¡å·é‡) å¯ä»¥æŒ‡å®šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚
*   **CountDownLatch(å€’è®¡æ—¶å™¨)ï¼š** CountDownLatch æ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œç”¨æ¥åè°ƒå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚è¿™ä¸ªå·¥å…·é€šå¸¸ç”¨æ¥æ§åˆ¶çº¿ç¨‹ç­‰å¾…ï¼Œå®ƒå¯ä»¥è®©æŸä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ç›´åˆ°å€’è®¡æ—¶ç»“æŸï¼Œå†å¼€å§‹æ‰§è¡Œã€‚
*   **CyclicBarrier(å¾ªç¯æ …æ )ï¼š** CyclicBarrier å’Œ CountDownLatch éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” CountDownLatch æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ CountDownLatch ç±»ä¼¼ã€‚CyclicBarrier çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚CyclicBarrier é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ CyclicBarrier(int parties)ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ await() æ–¹æ³•å‘Šè¯‰ CyclicBarrier æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚

å¹¶å‘å®è·µ
----